<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Companies House Bulk Download - Get All PDFs for ¬£5 | DocSpace</title>
    
    <!-- Primary Meta Tags -->
    <meta name="title" content="Companies House Bulk Download - Get All PDFs for ¬£5 | DocSpace">
    <meta name="description" content="Download all Companies House documents instantly. Get every PDF filing for any UK company in one ZIP file. Official API, secure payment, ¬£5 per company.">
    <meta name="keywords" content="companies house documents, uk company filings, download company documents, companies house pdf, annual returns, company accounts, incorporation documents, uk business documents, docspace, companies house api, ch direct, company reports uk, business filings uk, corporate documents, statutory filings, limited company documents, plc filings, company registration documents">
    <meta name="author" content="DocSpace UK">
    <meta name="robots" content="index, follow">
    <meta name="language" content="English">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://docspace.uk/">
    
    <!-- Web App Manifest -->
    <!-- <link rel="manifest" href="/manifest.json"> -->
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236366f1' stroke-width='2'%3E%3Cpath d='M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4'/%3E%3C/svg%3E">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://docspace.uk/">
    <meta property="og:title" content="Companies House Bulk Download - Get All PDFs for ¬£5">
    <meta property="og:description" content="Download all Companies House documents for any UK company. Fast, reliable service for just ¬£5 per company download.">
    <!-- <meta property="og:image" content="https://docspace.uk/og-image.png"> -->
    <meta property="og:site_name" content="DocSpace UK">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://docspace.uk/">
    <meta property="twitter:title" content="Companies House Bulk Download - Get All PDFs for ¬£5">
    <meta property="twitter:description" content="Download all Companies House documents for any UK company. Fast, reliable service for just ¬£5 per company download.">
    <!-- <meta property="twitter:image" content="https://docspace.uk/og-image.png"> -->
    
    <!-- Additional SEO Meta Tags -->
    <meta name="geo.region" content="GB">
    <meta name="geo.placename" content="United Kingdom">
    <meta name="copyright" content="DocSpace UK 2025">
    <meta name="theme-color" content="#6366f1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="DocSpace">
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RR9SEE0SQF"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-RR9SEE0SQF');
    </script>
    
    <!-- Director Lookup Styles -->
    <style>
        /* Director Info Badge */
        .director-info-badge {
            display: inline-flex !important;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
            padding: 3px 10px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 14px;
            font-size: 11px;
            font-weight: 600;
            color: #6366f1;
            cursor: pointer;
            transition: all 0.2s ease;
            vertical-align: middle;
            position: relative;
            z-index: 10;
        }

        .director-info-badge:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
        }

        .director-info-badge svg {
            width: 12px;
            height: 12px;
        }

        /* Director Popup Overlay */
        .director-popup-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }

        /* Director Popup Card */
        .director-popup {
            background: #ffffff;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 25px 100px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Popup Header */
        .popup-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .popup-header h3 {
            margin: 0;
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .director-icon {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-popup {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
            font-size: 20px;
        }

        .close-popup:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        /* Popup Content */
        .popup-content {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(85vh - 120px);
        }

        /* Director Summary */
        .director-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid #e2e8f0;
        }

        .summary-item {
            text-align: center;
        }

        .summary-item .value {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
            display: block;
            margin-bottom: 4px;
        }

        .summary-item .label {
            font-size: 12px;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Appointments Section */
        .appointments-section {
            margin-bottom: 24px;
        }

        .appointments-section h4 {
            margin: 0 0 16px 0;
            font-size: 18px;
            color: #1e293b;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .appointments-section h4::before {
            content: 'üè¢';
            font-size: 20px;
        }

        /* Director Appointment Card */
        .director-appointment {
            background: #ffffff;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .director-appointment:hover {
            border-color: #6366f1;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
            transform: translateX(4px);
        }

        .appointment-company {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .company-link {
            font-weight: 700;
            font-size: 16px;
            color: #1e293b;
            text-decoration: none;
            transition: color 0.2s;
            flex: 1;
        }

        .company-link:hover {
            color: #6366f1;
        }

        .company-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        .company-status.active {
            background: #d1fae5;
            color: #065f46;
        }

        .company-status.in-liquidation {
            background: #fee2e2;
            color: #991b1b;
        }

        .company-status.dissolved {
            background: #f3f4f6;
            color: #6b7280;
        }

        .appointment-details {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: #64748b;
        }

        .appointment-details .role {
            font-weight: 600;
            color: #475569;
        }

        .appointment-note {
            margin-top: 8px;
            padding: 8px 12px;
            background: #f1f5f9;
            border-radius: 8px;
            font-size: 13px;
            color: #64748b;
            font-style: italic;
        }

        /* Director Details */
        .director-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 24px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-item .icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }

        .detail-item .text {
            flex: 1;
        }

        .detail-item .text .label {
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-item .text .value {
            font-size: 14px;
            color: #1e293b;
            font-weight: 600;
        }

        /* Director Links */
        .director-links {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 2px solid #e2e8f0;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .director-links a {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            color: #475569;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .director-links a:hover {
            background: #6366f1;
            border-color: #6366f1;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        /* Officer Name with Badge */
        .officer-name-container {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Mobile Responsive */
        @media (max-width: 600px) {
            .director-popup {
                max-height: 100vh;
                border-radius: 0;
            }
            
            .popup-content {
                max-height: calc(100vh - 120px);
            }
            
            .director-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .director-details {
                grid-template-columns: 1fr;
            }
            
            .appointment-company {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }
    </style>
    
    <!-- FAQ Schema Markup -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [{
        "@type": "Question",
        "name": "How do I download all documents from Companies House?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Search for any UK company on DocSpace, pay ¬£5, and instantly download all their Companies House documents as a ZIP file. Includes annual returns, accounts, incorporation documents, and more."
        }
      },{
        "@type": "Question",
        "name": "Can I bulk download Companies House PDFs?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Yes! DocSpace lets you bulk download all Companies House PDFs for any UK company in one click. Get hundreds of documents instantly for just ¬£5 per company."
        }
      },{
        "@type": "Question",
        "name": "How much does it cost to download Companies House documents?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "¬£5 per company for unlimited document downloads. This includes all filings, accounts, returns, and incorporation documents for that company."
        }
      },{
        "@type": "Question",
        "name": "Is DocSpace safe for downloading Companies House files?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Yes, DocSpace uses the official Companies House API and Stripe for secure payments. All documents are authentic and sourced directly from Companies House."
        }
      }]
    }
    </script>
    
    <!-- Preconnect for Performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://blue-flower-d40f.mahin84.workers.dev">
    <link rel="dns-prefetch" href="https://checkout.stripe.com">
    <link rel="dns-prefetch" href="https://companies-api-production-68c2.up.railway.app">
    
    <!-- Additional SEO Meta Tags -->
    <meta name="geo.region" content="GB-ENG">
    <meta name="geo.position" content="51.5074;-0.1278">
    <meta name="ICBM" content="51.5074, -0.1278">
    <meta name="geo.placename" content="London, UK">
    <meta name="distribution" content="global">
    <meta name="rating" content="general">
    <meta name="revisit-after" content="7 days">
    
    <!-- Structured Data for Organization -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "DocSpace",
      "description": "Download all Companies House documents for any UK company instantly",
      "url": "https://docspace.uk",
      "applicationCategory": "BusinessApplication",
      "operatingSystem": "Web Browser",
      "offers": {
        "@type": "Offer",
        "price": "5",
        "priceCurrency": "GBP",
        "description": "Complete company document download"
      },
      "provider": {
        "@type": "Organization",
        "name": "DocSpace UK"
      }
    }
    </script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%236366f1'/%3E%3Cstop offset='100%25' style='stop-color:%238b5cf6'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' rx='6' fill='url(%23g)'/%3E%3Cpath d='M16 6L8 11v13h16V11L16 6z' fill='white'/%3E%3Crect x='11' y='14' width='3' height='3' fill='%236366f1'/%3E%3Crect x='18' y='14' width='3' height='3' fill='%236366f1'/%3E%3Crect x='11' y='19' width='3' height='3' fill='%236366f1'/%3E%3Crect x='18' y='19' width='3' height='3' fill='%236366f1'/%3E%3C/svg%3E">
    
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #8b5cf6;
            --accent: #ec4899;
            --dark: #0f172a;
            --dark-light: #1e293b;
            --gray: #64748b;
            --gray-light: #94a3b8;
            --gray-lighter: #cbd5e1;
            --white: #ffffff;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --gradient-3: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-md: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            --radius: 12px;
            --radius-lg: 16px;
        }
        
        /* Tab navigation */
        .tab-navigation {
            display: flex;
            gap: 4px;
            margin-bottom: 32px;
            background: rgba(255, 255, 255, 0.03);
            padding: 4px;
            border-radius: 12px;
        }
        
        .tab-button {
            flex: 1;
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .tab-button:hover {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .tab-button.active {
            background: rgba(255, 255, 255, 0.08);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .coming-soon-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            background: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
            font-size: 11px;
            font-weight: 600;
            border-radius: 100px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 20px;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Explore tab content */
        .explore-content {
            text-align: center;
            padding: 40px 20px;
        }
        
        .explore-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            background: var(--gradient-2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 40px rgba(99, 102, 241, 0.3);
        }
        
        .explore-icon svg {
            width: 40px;
            height: 40px;
            color: white;
        }
        
        .explore-title {
            font-size: 24px;
            font-weight: 700;
            color: white;
            margin-bottom: 12px;
        }
        
        .explore-description {
            font-size: 16px;
            color: #64748b;
            line-height: 1.6;
            max-width: 400px;
            margin: 0 auto;
        }
        
        /* Toast notification system */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
        }
        
        .toast {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px 20px;
            min-width: 300px;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideInRight 0.3s ease;
            pointer-events: all;
        }
        
        .toast.success {
            border-color: rgba(16, 185, 129, 0.3);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .toast.error {
            border-color: rgba(239, 68, 68, 0.3);
            background: rgba(239, 68, 68, 0.1);
        }
        
        .toast.info {
            border-color: rgba(59, 130, 246, 0.3);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .toast-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        
        .toast.success .toast-icon {
            color: #10b981;
        }
        
        .toast.error .toast-icon {
            color: #ef4444;
        }
        
        .toast.info .toast-icon {
            color: #3b82f6;
        }
        
        .toast-message {
            flex: 1;
            font-size: 14px;
            color: white;
            line-height: 1.4;
        }
        
        .toast-close {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .toast-close:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* Confetti styles */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 9999;
        }
        
        
        .confetti.square {
            border-radius: 0;
        }
        
        .confetti.circle {
            border-radius: 50%;
        }
        
        .confetti.triangle {
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 10px solid;
            background: none;
        }
        
        @keyframes confetti-burst {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                transform: translate(-50%, -50%) scale(1.2) rotate(180deg);
                opacity: 1;
            }
            100% {
                transform: translate(calc(-50% + var(--x)), calc(-50% + var(--y))) scale(0.3) rotate(720deg);
                opacity: 0;
            }
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--gradient-2);
            animation: confetti-burst 2s ease-out forwards;
            transform-origin: center;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #1e293b;
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }

        .bg-animation::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 20% 80%, #6366f1 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, #8b5cf6 0%, transparent 50%),
                        radial-gradient(circle at 40% 40%, #3b82f6 0%, transparent 50%);
            animation: rotate 30s linear infinite;
            opacity: 0.1;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Top bar */
        .top-bar {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            max-width: 1200px;
            margin: 0 auto;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
        }

        .logo-small {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 100px;
            padding: 8px 16px 8px 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .logo-small:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.02);
        }
        
        .logo-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: var(--gradient-2);
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        
        .logo-text {
            font-size: 15px;
            font-weight: 600;
            color: white;
            letter-spacing: -0.3px;
        }

        .logo-small:hover .logo-icon {
            transform: rotate(15deg);
        }

        .logo-icon svg {
            width: 18px;
            height: 18px;
            color: white;
        }

        .top-bar-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Create Account button */
        .create-account-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--gradient-2);
            border: none;
            border-radius: 100px;
            padding: 10px 20px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .create-account-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.4);
        }

        .create-account-btn svg {
            width: 18px;
            height: 18px;
        }

        body.light-mode .create-account-btn {
            box-shadow: 0 4px 14px 0 rgba(99, 102, 241, 0.3);
        }
        
        /* Profile mode - matching logo style exactly */
        .create-account-btn.profile-mode {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 100px;
            padding: 8px 16px 8px 8px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: none;
        }
        
        .create-account-btn.profile-mode:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.02);
        }
        
        .profile-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: var(--gradient-2);
            border-radius: 50%;
            transition: transform 0.3s ease;
            flex-shrink: 0;
        }
        
        .create-account-btn.profile-mode:hover .profile-icon {
            transform: rotate(15deg);
        }
        
        .profile-text {
            font-size: 15px;
            font-weight: 600;
            color: white;
            letter-spacing: -0.3px;
        }
        
        /* Circle style for logged-in users */
        #userBtn.profile-mode {
            width: 48px;
            height: 48px;
            padding: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        #userBtn.profile-mode .profile-icon {
            width: 48px;
            height: 48px;
            background: none;
        }
        
        #userBtn.profile-mode svg {
            width: 24px;
            height: 24px;
            color: white;
        }
        
        #userBtn.profile-mode .profile-text {
            display: none;
        }
        
        }
        
        .profile-icon svg {
            width: 18px;
            height: 18px;
            color: white;
        }
        
        .create-account-btn.profile-mode:hover svg {
            color: white;
            transform: scale(1.1);
        }
        
        body.light-mode .create-account-btn.profile-mode {
            background: white;
            border-color: #e2e8f0;
            box-shadow: var(--shadow);
        }
        
        body.light-mode .create-account-btn.profile-mode svg {
            color: #6366f1;
        }
        
        /* Profile dropdown menu */
        .profile-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: rgba(20, 25, 40, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius);
            min-width: 220px;
            padding: 8px;
            display: none;
            z-index: 1000;
            box-shadow: var(--shadow-xl);
            animation: dropdownFadeIn 0.2s ease;
        }
        
        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .profile-dropdown.show {
            display: block;
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            color: #e2e8f0;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }
        
        .dropdown-item:hover {
            background: rgba(99, 102, 241, 0.1);
            color: white;
        }
        
        .dropdown-item svg {
            width: 18px;
            height: 18px;
            color: #94a3b8;
            transition: color 0.2s ease;
        }
        
        .dropdown-item:hover svg {
            color: var(--primary-light);
        }
        
        .dropdown-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 8px 0;
        }
        
        .dropdown-item.danger {
            color: #f87171;
        }
        
        .dropdown-item.danger svg {
            color: #f87171;
        }
        
        .dropdown-item.danger:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #fca5a5;
        }
        
        body.light-mode .profile-dropdown {
            background: white;
            border-color: #e2e8f0;
        }
        
        body.light-mode .dropdown-item {
            color: #475569;
        }
        
        body.light-mode .dropdown-item:hover {
            background: rgba(99, 102, 241, 0.08);
            color: #1e293b;
        }
        
        body.light-mode .dropdown-divider {
            background: #e2e8f0;
        }

        /* Dark mode toggle */
        .theme-toggle {
            position: relative;
            top: 0;
            right: 0;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .theme-toggle svg {
            width: 24px;
            height: 24px;
            color: white;
            transition: transform 0.3s ease;
        }

        .theme-toggle:hover svg {
            transform: rotate(180deg);
        }

        /* Main container */
        .main-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            position: relative;
        }

        /* Hero section */
        .hero {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeInUp 0.8s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-size: 3.5rem;
            font-weight: 800;
            background: var(--gradient-2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 16px;
            letter-spacing: -0.02em;
        }

        .hero-subtitle {
            font-size: 1.25rem;
            color: #94a3b8;
            max-width: 600px;
            margin: 0 auto 12px;
        }
        
        h1.hero-subtitle {
            font-size: 48px;
            font-weight: 800;
            color: white;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #ffffff 0%, #a5b4fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            max-width: 600px;
            margin: 0 auto 24px;
            line-height: 1.3;
            letter-spacing: -0.5px;
        }

        .hero-description {
            font-size: 18px;
            color: #94a3b8;
            margin-bottom: 32px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .price-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            padding: 8px 20px;
            border-radius: 100px;
            font-weight: 600;
            color: #a5b4fc;
            margin-top: 12px;
            animation: fadeIn 0.8s ease 0.3s both;
        }

        body.light-mode .price-badge {
            background: rgba(99, 102, 241, 0.15);
            border-color: rgba(99, 102, 241, 0.3);
            color: #6366f1;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Search container */
        .search-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            padding: 32px;
            width: 100%;
            max-width: 600px;
            margin-bottom: 40px;
            box-shadow: var(--shadow-xl);
            animation: fadeInUp 0.8s ease 0.2s both;
            position: relative;
            z-index: 500;
        }
        
        /* Modern search form */
        #searchForm {
            position: relative;
            width: 100%;
        }
        
        .search-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Form styles */
        .form-group {
            margin-bottom: 24px;
        }

        .form-input {
            width: 100%;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius);
            font-size: 16px;
            color: white;
            transition: all 0.3s ease;
            font-family: inherit;
            height: 56px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-input::placeholder {
            color: #64748b;
            opacity: 1;
        }

        .form-helper {
            font-size: 14px;
            color: #64748b;
            text-align: center;
            opacity: 0.8;
            margin-top: 20px;
        }

        /* Search button */
        .search-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 18px 32px;
            min-width: 140px;
            width: 140px;
            background: var(--gradient-2);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
            white-space: nowrap;
            flex-shrink: 0;
            height: 56px;
        }
        
        .search-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.5);
        }
        
        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Ensure button text is always visible */
        .search-btn span {
            display: inline-flex !important;
            align-items: center;
            gap: 6px;
            visibility: visible !important;
        }
        
        /* Button styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px 32px;
            background: var(--gradient-2);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-decoration: none;
            width: 100%;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0);
            transition: background 0.3s ease;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px -12px rgba(99, 102, 241, 0.5);
        }

        .btn:hover:not(:disabled)::before {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #334155;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .btn-success:hover:not(:disabled) {
            box-shadow: 0 20px 40px -12px rgba(16, 185, 129, 0.5);
        }

        /* Status messages - hidden as we use toasts now */
        .status-message {
            display: none !important;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-success {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border-color: rgba(16, 185, 129, 0.2);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.2);
        }

        .status-info {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border-color: rgba(59, 130, 246, 0.2);
        }

        /* Progress section */
        .progress-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            padding: 32px;
            margin-top: 24px;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .progress-title {
            font-size: 18px;
            font-weight: 600;
            color: white;
        }

        .progress-count {
            font-size: 14px;
            color: #94a3b8;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            height: 8px;
            border-radius: 100px;
            overflow: hidden;
            margin-bottom: 24px;
        }

        .progress-fill {
            background: var(--gradient-2);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* File list */
        .file-list {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .file-list::-webkit-scrollbar {
            width: 8px;
        }

        .file-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 100px;
        }

        .file-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 100px;
        }

        .file-list::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .file-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .file-item.success {
            color: #10b981;
        }

        .file-item.error {
            color: #ef4444;
        }

        .file-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #cbd5e1;
        }

        /* Search results */
        .results-container {
            width: 100%;
            max-width: 600px;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .company-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            padding: 32px;
            padding-left: 36px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        /* Removed violet bar */

        .company-name {
            font-size: 24px;
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
        }

        .company-info {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 24px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #94a3b8;
        }

        .info-item svg {
            width: 16px;
            height: 16px;
            color: #64748b;
        }

        .document-stats {
            display: flex;
            gap: 24px;
            padding: 20px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: var(--radius);
            margin-bottom: 24px;
        }

        .stat-item {
            flex: 1;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-light);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            color: #94a3b8;
        }

        /* Loading states */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .skeleton {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.05) 25%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0.05) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Info section */
        .info-section-single {
            width: 100%;
            max-width: 600px;
            margin: 24px auto 60px;
        }

        .info-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 32px;
            box-shadow: var(--shadow-xl);
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .info-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 50px -12px rgba(99, 102, 241, 0.25);
        }

        .info-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 32px;
        }

        .info-column h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-light);
            margin-bottom: 16px;
        }

        .feature-list.compact {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .feature-list.compact .feature-item {
            padding: 12px 16px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
            display: block;
            transition: all 0.2s ease;
        }

        .feature-list.compact .feature-item:hover {
            background: rgba(99, 102, 241, 0.15);
            transform: translateX(4px);
        }

        .user-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .user-item {
            font-size: 14px;
        }

        .user-item strong {
            color: #e2e8f0;
            display: block;
            margin-bottom: 4px;
            font-size: 15px;
        }

        .user-item p {
            color: #94a3b8;
            margin: 0;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .info-content {
                grid-template-columns: 1fr;
                gap: 24px;
            }
            
            .info-container {
                padding: 24px;
            }
            
            .search-container {
                padding: 24px;
            }
            
            .search-btn {
                padding: 16px 24px;
                border-radius: var(--radius);
            }
            
            .search-wrapper {
                gap: 8px;
            }
            
            /* Fix profile button on mobile */
            .create-account-btn.profile-mode {
                padding: 6px 12px 6px 6px;
                white-space: nowrap;
                min-height: 44px;
            }
            
            .profile-icon {
                width: 32px;
                height: 32px;
                margin: 0;
            }
            
            .profile-text {
                font-size: 14px;
            }
            
            /* Keep top bar fixed but ensure content isn't covered */
            .hero {
                padding-top: 80px;
            }
            
            h1.hero-subtitle {
                font-size: 32px;
            }
        }

        /* Old info card styles for compatibility */
        .info-section {
            display: none;
        }

        .info-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            padding: 32px;
            transition: all 0.3s ease;
        }

        .info-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-4px);
        }

        .info-icon {
            width: 48px;
            height: 48px;
            background: var(--gradient-2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }

        .info-icon svg {
            width: 24px;
            height: 24px;
            color: white;
        }

        .info-title {
            font-size: 20px;
            font-weight: 700;
            color: white;
            margin-bottom: 12px;
        }

        .info-description {
            font-size: 14px;
            color: #94a3b8;
            line-height: 1.7;
        }

        /* Feature list */
        .feature-list {
            list-style: none;
            margin-top: 16px;
        }

        .feature-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 14px;
            color: #cbd5e1;
        }

        .feature-item svg {
            width: 20px;
            height: 20px;
            color: var(--primary-light);
            flex-shrink: 0;
            margin-top: 2px;
        }

        /* Footer */
        footer {
            width: 100%;
            text-align: center;
            padding: 60px 20px 40px;
            margin-top: 100px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .footer-logo {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
            color: white;
            margin-bottom: 24px;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-bottom: 24px;
        }

        .footer-links a {
            color: #94a3b8;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.2s ease;
        }

        .footer-links a:hover {
            color: var(--primary-light);
        }

        .footer-copyright {
            font-size: 14px;
            color: #64748b;
        }


        /* Download Status Indicator */
        .download-status-indicator {
            margin-bottom: 12px;
        }

        .already-downloaded {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--success);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .already-downloaded svg {
            flex-shrink: 0;
        }

        /* Responsive design */
        
        /* Mobile-first improvements */
        @media (max-width: 480px) {
            /* Hero section for mobile */
            h1 {
                font-size: 2rem;
                line-height: 1.2;
            }

            .hero-subtitle {
                font-size: 1rem;
                padding: 0 16px;
            }

            /* Tagline badge mobile */
            .hero div div {
                font-size: 14px !important;
                padding: 10px 20px !important;
                margin-top: 16px !important;
            }

            /* Tab navigation - make touch-friendly */
            .tab-navigation {
                margin-bottom: 24px;
                padding: 6px;
            }
            
            .tab-button {
                padding: 14px 20px;
                font-size: 14px;
                min-height: 48px; /* Touch target size */
            }

            /* Search container - full width on mobile */
            .search-container {
                padding: 20px 16px;
                margin: 0 16px 32px 16px;
                max-width: calc(100% - 32px);
                width: calc(100% - 32px);
                -webkit-box-sizing: border-box;
                box-sizing: border-box;
            }
            
            /* Results container - full width on mobile */
            .results-container {
                max-width: 100%;
                margin: 0;
                width: 100%;
                -webkit-box-sizing: border-box;
                box-sizing: border-box;
            }
            
            /* Tab content container - full width on mobile */
            .tab-content {
                width: 100%;
                max-width: 100%;
            }

            /* Search form improvements */
            .search-form {
                gap: 12px;
            }
            
            .search-wrapper {
                gap: 8px !important;
            }
            
            .autocomplete-wrapper {
                flex: 1 !important;
                min-width: 0 !important;
                width: calc(100% - 88px) !important;
                max-width: calc(100% - 88px) !important;
            }

            #companySearch {
                padding: 16px 20px;
                font-size: 16px; /* Prevent zoom on iOS */
                min-height: 48px;
            }

            .search-btn {
                padding: 0 !important;
                min-height: 80px !important;
                height: 80px !important;
                width: 80px !important;
                max-width: 80px !important;
                min-width: 80px !important;
                flex-shrink: 0 !important;
                font-size: 15px !important;
                box-sizing: border-box !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }
            
            .search-btn span {
                display: none !important;
            }

            /* Filter controls - keep two-line layout on mobile */
            /* Removed vertical stacking to maintain desktop layout */

            /* Toggle buttons - larger touch targets */
            .toggle-btn {
                padding: 12px 20px;
                font-size: 14px;
                min-height: 44px;
                flex: 1;
            }

            /* Industry filter - better mobile sizing */
            #industryFilter {
                min-height: 44px;
                padding: 10px 14px;
                font-size: 14px;
            }

            /* Filter block - no padding on mobile */
            .tab-content > div:first-child {
                margin: 24px 0 !important;
            }
            
            /* Company cards - match search container width on mobile */
            .company-card, .explore-company-card {
                padding: 16px;
                margin: 0 16px 16px 16px;
                width: calc(100% - 32px);
                max-width: calc(100% - 32px);
            }
            
            /* Company list container - full width on mobile */
            #companyListExplore {
                max-width: 100%;
            }

            /* Company card content */
            .company-card h3 {
                font-size: 18px;
                line-height: 1.3;
            }

            .company-details {
                font-size: 14px;
            }

            /* Load more button */
            .show-more-btn {
                margin: 24px 16px;
                padding: 16px 32px;
                min-height: 48px;
                font-size: 15px;
            }
            
            /* Expandable card content - mobile optimization */
            .card-expand-content {
                font-size: 13px;
            }
            
            .expand-section {
                margin-top: 12px;
                padding-top: 12px;
            }
            
            .expand-row {
                margin-bottom: 10px;
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            
            .expand-label {
                min-width: auto;
                font-size: 12px;
                color: #94a3b8;
                font-weight: 600;
            }
            
            .expand-value {
                font-size: 13px;
                color: #e2e8f0;
                line-height: 1.4;
            }
            
            /* Charges display - mobile specific */
            .charges-breakdown {
                font-size: 12px;
            }
            
            .charge-line {
                padding: 6px 0;
                margin-bottom: 4px;
            }
            
            .charge-type {
                font-size: 12px;
            }
            
            .charge-count {
                font-size: 13px;
                font-weight: 700;
            }
            
            /* SIC codes - mobile responsive */
            .sic-code {
                font-size: 11px;
                padding: 3px 6px;
                margin-bottom: 3px;
                margin-right: 4px;
            }
            
            /* Sign up button - mobile touch target */
            .signup-btn {
                padding: 12px 24px;
                font-size: 14px;
                min-height: 44px;
                border-radius: 8px;
            }
            
            /* Expanded card max-height adjustment for mobile */
            .explore-company-card.expanded .card-expand-content {
                max-height: 400px;
            }

            /* Footer improvements */
            .footer-links {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }
            
            /* Marketing block - same width as main block on mobile */
            .info-container {
                margin: 0 16px !important;
                width: calc(100% - 32px) !important;
                max-width: calc(100% - 32px) !important;
            }

            /* Active switch mobile improvements */
            .switch {
                width: 44px !important;
                height: 24px !important;
                -webkit-appearance: none;
                appearance: none;
                background: rgba(255,255,255,0.1);
            }
            
            .switch.active {
                background: #6366f1;
            }
            
            .switch::after {
                width: 18px !important;
                height: 18px !important;
                top: 3px !important;
                left: 3px !important;
            }
            
            .switch.active::after {
                -webkit-transform: translateX(20px);
                transform: translateX(20px);
            }

            /* Pricing info mobile */
            .search-container p {
                text-align: center !important;
                font-size: 15px;
            }

            /* Company status indicators */
            .status-indicator {
                width: 10px;
                height: 10px;
                margin-right: 8px;
            }
            
            /* Charges indicator mobile */
            .charges-indicator {
                width: 14px !important;
                height: 14px !important;
            }
            
            .charges-indicator::before {
                font-size: 10px !important;
            }
            
            /* Force single line for filter area */
            .explore-content > div > div:first-child {
                flex-wrap: nowrap !important;
            }
            
            /* Reduce gaps on mobile */
            .explore-content > div > div:first-child > div:last-child {
                gap: 8px !important;
            }
            
            /* Show mobile text, hide desktop text */
            .desktop-text {
                display: none !important;
            }
            
            .mobile-text {
                display: inline !important;
            }
            
            /* Smaller font for toggle labels */
            .explore-content span[style*="font-size: 13px"] {
                font-size: 11px !important;
            }
            
            /* Reduce toggle button size on mobile */
            .explore-content .toggle-btn {
                padding: 10px 12px !important;
                font-size: 13px !important;
            }

            /* Industry badges - better mobile sizing */
            .explore-company-card .industry-badge,
            .company-card .industry-badge {
                padding: 4px 8px;
                font-size: 11px;
                border-radius: 4px;
            }

            /* Ensure tap targets are accessible */
            .explore-company-card,
            .company-card {
                cursor: pointer;
                min-height: 80px;
                transition: transform 0.2s ease, box-shadow 0.2s ease;
            }

            .explore-company-card:active,
            .company-card:active {
                transform: scale(0.98);
            }

            /* Better text hierarchy on mobile */
            .explore-company-card h3,
            .company-card h3 {
                margin-bottom: 8px;
                font-weight: 600;
            }

            .explore-company-card .company-details,
            .company-card .company-details {
                line-height: 1.4;
            }
            
            /* Safari-specific fixes */
            @supports (-webkit-touch-callout: none) {
                /* Fix for Safari width calculations */
                .main-container {
                    width: 100%;
                    padding: 40px 0;
                }
                
                .search-container,
                .info-container {
                    max-width: 100% !important;
                    margin: 0 16px 32px 16px !important;
                    width: calc(100% - 32px) !important;
                }
                
                .results-container,
                .tab-content {
                    max-width: 100% !important;
                    margin: 0 !important;
                    width: 100% !important;
                }
                
                /* Fix switch on Safari */
                .switch {
                    display: inline-block;
                    position: relative;
                    vertical-align: middle;
                }
            }
        }

        /* Tablet styles */
        @media (max-width: 768px) and (min-width: 481px) {
            .top-bar {
                width: calc(100% - 32px);
            }

            .create-account-btn span {
                display: none;
            }

            .create-account-btn {
                padding: 10px;
                width: 48px;
                height: 48px;
                justify-content: center;
            }

            h1 {
                font-size: 2.5rem;
            }

            .hero-subtitle {
                font-size: 1.1rem;
            }

            .search-container {
                padding: 28px 24px;
                margin: 0 24px 40px 24px;
                max-width: none;
            }

            .company-card, .explore-company-card {
                padding: 24px;
                margin: 0 24px 20px 24px;
            }

            .document-stats {
                flex-direction: column;
                gap: 16px;
            }

            .footer-links {
                flex-direction: column;
                gap: 16px;
            }

            /* Filter controls - better spacing on tablet */
            .tab-content > div:first-child {
                flex-wrap: wrap;
                gap: 12px;
            }

            #industryFilter {
                min-width: 200px;
                flex-shrink: 0;
            }
        }

        /* Autocomplete styles */
        .autocomplete-wrapper {
            position: relative;
            width: 100%;
        }
        
        /* Clear search button hover effect */
        #clearExploreSearch:hover {
            color: #e2e8f0 !important;
        }
        
        /* Filing download button hover effect */
        .filing-download-btn:hover {
            background: rgba(99, 102, 241, 0.1) !important;
            border-color: rgba(99, 102, 241, 0.5) !important;
            color: #c7d2fe !important;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: rgba(20, 25, 40, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius);
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
        }

        /* Mobile autocomplete improvements */
        @media (max-width: 480px) {
            .autocomplete-dropdown {
                max-height: 60vh;
                border-radius: 16px;
                margin-top: 4px;
                box-shadow: 0 25px 60px rgba(0, 0, 0, 0.6);
                border: 2px solid rgba(255, 255, 255, 0.15);
                background: rgba(15, 23, 42, 0.95);
            }
            
            .autocomplete-item {
                padding: 20px 16px;
                min-height: 56px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                transition: all 0.2s ease;
            }
            
            .autocomplete-item:hover,
            .autocomplete-item:active {
                background: rgba(99, 102, 241, 0.1);
                transform: translateX(4px);
            }
            
            .autocomplete-item:last-child {
                border-bottom: none;
            }
            
            .autocomplete-item .company-title {
                font-size: 17px;
                font-weight: 600;
                margin-bottom: 8px;
                color: #f1f5f9;
                line-height: 1.3;
            }
            
            .autocomplete-item .company-details {
                font-size: 14px;
                flex-direction: row;
                gap: 12px;
                align-items: center;
                color: #94a3b8;
                line-height: 1.4;
                flex-wrap: wrap;
            }
            
            .autocomplete-item .company-details span {
                display: inline-block;
                white-space: nowrap;
            }
        }

        .autocomplete-dropdown.show {
            display: block;
        }

        .autocomplete-item {
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover,
        .autocomplete-item.active {
            background: rgba(99, 102, 241, 0.2);
        }

        .autocomplete-item .company-title {
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
            font-size: 15px;
        }

        .autocomplete-item .company-details {
            font-size: 13px;
            color: #94a3b8;
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .autocomplete-item .company-number {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .autocomplete-item .company-status {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .autocomplete-item .company-status.active {
            color: #10b981;
        }

        .autocomplete-item .company-status.dissolved {
            color: #ef4444;
        }

        .autocomplete-loading {
            padding: 20px;
            text-align: center;
            color: #94a3b8;
        }

        .autocomplete-loading .spinner {
            margin: 0 auto;
        }

        .autocomplete-empty {
            padding: 20px;
            text-align: center;
            color: #64748b;
            font-size: 14px;
        }

        /* Light mode autocomplete */
        body.light-mode .autocomplete-dropdown {
            background: white;
            border-color: #e2e8f0;
        }

        body.light-mode .autocomplete-item {
            border-bottom-color: #f1f5f9;
        }

        body.light-mode .autocomplete-item:hover,
        body.light-mode .autocomplete-item.active {
            background: rgba(99, 102, 241, 0.08);
        }

        body.light-mode .autocomplete-item .company-title {
            color: #1e293b;
        }

        /* Light mode styles */
        body.light-mode {
            background: #f8fafc;
            color: #1e293b;
        }

        body.light-mode .bg-animation::before {
            opacity: 0.05;
        }

        body.light-mode .theme-toggle {
            background: rgba(0, 0, 0, 0.05);
            border-color: rgba(0, 0, 0, 0.1);
        }

        body.light-mode .theme-toggle svg {
            color: #1e293b;
        }

        body.light-mode .search-container,
        body.light-mode .company-card,
        body.light-mode .progress-section,
        body.light-mode .info-container {
            background: white;
            border-color: #e2e8f0;
        }

        body.light-mode .info-column h3 {
            color: var(--primary);
        }

        body.light-mode .feature-list.compact .feature-item {
            background: rgba(99, 102, 241, 0.08);
            border-color: rgba(99, 102, 241, 0.15);
            color: #475569;
        }

        body.light-mode .feature-list.compact .feature-item:hover {
            background: rgba(99, 102, 241, 0.12);
        }

        body.light-mode .user-item strong {
            color: #1e293b;
        }

        body.light-mode .user-item p {
            color: #64748b;
        }

        body.light-mode .info-card {
            background: white;
            border-color: #e2e8f0;
        }

        body.light-mode .form-input {
            background: #f8fafc;
            border-color: #e2e8f0;
            color: #1e293b;
        }

        body.light-mode .form-input:focus {
            background: white;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        body.light-mode .company-name,
        body.light-mode .info-title,
        body.light-mode .footer-logo {
            color: #1e293b;
        }

        body.light-mode .progress-title {
            color: #1e293b;
        }

        body.light-mode .file-item {
            background: #f8fafc;
        }

        body.light-mode .file-item:hover {
            background: #f1f5f9;
        }

        body.light-mode footer {
            border-top-color: #e2e8f0;
        }
        /* Explore tab styles */
        .toggle-btn { 
            padding: 8px 16px; 
            background: rgba(255,255,255,0.05); 
            border: none;
            border-radius: 6px; 
            color: rgba(255,255,255,0.7); 
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .toggle-btn:hover {
            background: rgba(255,255,255,0.08);
            color: white;
        }
        .toggle-btn.active { 
            background: linear-gradient(135deg, #6366f1, #8b5cf6); 
            color: white;
        }
        .switch {
            position: relative;
            width: 40px;
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .switch.active {
            background: #6366f1;
        }
        .switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }
        .switch.active::after {
            transform: translateX(20px);
        }
        .explore-company-card {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.08);
            padding: 20px;
            margin-bottom: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .explore-company-card:hover {
            background: rgba(255,255,255,0.04);
            border-color: rgba(139,92,246,0.3);
            transform: translateY(-1px);
        }
        
        /* Expanded card styles */
        .explore-company-card.expanded {
            background: rgba(255,255,255,0.05);
            border-color: rgba(139,92,246,0.4);
        }
        
        .card-expand-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0;
        }
        
        .explore-company-card.expanded .card-expand-content {
            max-height: 500px;
            opacity: 1;
            transition: max-height 0.3s ease-in, opacity 0.3s ease-in;
        }
        
        .expand-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .expand-row {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            color: #e2e8f0;
            font-size: 13px;
        }
        
        .expand-label {
            color: #94a3b8;
            min-width: 120px;
            font-weight: 500;
        }
        
        .expand-value {
            flex: 1;
            color: #e2e8f0;
        }
        
        .sic-code {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 4px;
            display: inline-block;
            cursor: help;
        }
        
        .charges-breakdown {
            font-size: 13px;
            line-height: 1.4;
        }
        
        .charge-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            padding: 4px 0;
        }
        
        .charge-line:last-child {
            margin-bottom: 0;
        }
        
        .charge-type {
            color: #94a3b8;
            font-weight: 500;
        }
        
        .charge-count {
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .charge-count.outstanding {
            color: #fca5a5;
        }
        
        .charge-count.satisfied {
            color: #86efac;
        }
        
        .signup-cta {
            margin-top: 20px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            border: 1px solid rgba(99, 102, 241, 0.15);
            border-radius: 8px;
            text-align: center;
        }
        
        .signup-cta p {
            color: #94a3b8;
            font-size: 13px;
            margin-bottom: 12px;
            display: none;
        }
        
        .signup-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .signup-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            min-width: 10px;
            min-height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
            position: relative;
            cursor: help;
            flex-shrink: 0;
            /* Reset any inherited transforms */
            transform: none !important;
            font-size: inherit !important;
        }
        /* Simple tooltip - 11px as requested with multiline support */
        [data-tooltip] {
            position: relative;
        }
        
        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: normal;
            line-height: 1.3;
            white-space: normal;
            max-width: 280px;
            width: max-content;
            text-align: center;
            word-wrap: break-word;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        [data-tooltip]:hover::after {
            opacity: 1;
        }
        
        .status-active {
            background: #22c55e;
        }
        .status-dissolved {
            background: #6b7280;
        }
        .status-liquidation {
            background: #ef4444;
        }
        .status-dormant {
            background: #f59e0b;
        }
        .status-receivership {
            background: #dc2626;
        }
        .industry-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 8px;
        }
        
        /* Desktop/mobile text visibility */
        .mobile-text {
            display: none;
        }
        
        /* Charges indicator */
        .charges-indicator {
            margin-left: 8px;
            width: 16px;
            height: 16px;
            min-width: 16px;
            min-height: 16px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-radius: 50%;
            display: inline-flex !important;
            align-items: center;
            justify-content: center;
            cursor: help;
            position: relative;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
            color: white;
            font-size: 11px;
            font-weight: 700;
            line-height: 1;
        }
        
        .charges-indicator:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 6px rgba(239, 68, 68, 0.4);
        }
        
        .industry-agriculture {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        .industry-financial {
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
        .industry-technology {
            background: rgba(99, 102, 241, 0.15);
            color: #6366f1;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }
        .industry-transport {
            background: rgba(14, 165, 233, 0.15);
            color: #0ea5e9;
            border: 1px solid rgba(14, 165, 233, 0.3);
        }
        .industry-energy {
            background: rgba(251, 146, 60, 0.15);
            color: #fb923c;
            border: 1px solid rgba(251, 146, 60, 0.3);
        }
        .industry-media {
            background: rgba(168, 85, 247, 0.15);
            color: #a855f7;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }
        .industry-retail {
            background: rgba(236, 72, 153, 0.15);
            color: #ec4899;
            border: 1px solid rgba(236, 72, 153, 0.3);
        }
        .industry-manufacturing {
            background: rgba(217, 70, 239, 0.15);
            color: #d946ef;
            border: 1px solid rgba(217, 70, 239, 0.3);
        }
        .industry-real.estate, .industry-real_estate {
            background: rgba(168, 85, 247, 0.15);
            color: #a855f7;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }
        .industry-healthcare {
            background: rgba(34, 211, 238, 0.15);
            color: #22d3ee;
            border: 1px solid rgba(34, 211, 238, 0.3);
        }
        .industry-construction {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        .industry-services {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        .industry-other {
            background: rgba(107, 114, 128, 0.15);
            color: #6b7280;
            border: 1px solid rgba(107, 114, 128, 0.3);
        }
        
        /* Industry filter dropdown styles */
        #industryFilter {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        
        #industryFilter:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
            border-color: rgba(99, 102, 241, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.1), 0 4px 6px -4px rgba(99, 102, 241, 0.1);
        }
        
        #industryFilter:focus {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
            border-color: rgba(99, 102, 241, 0.6);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1), 0 10px 15px -3px rgba(99, 102, 241, 0.1);
        }
        
        #industryFilter option {
            background: #1e293b;
            color: #e2e8f0;
            padding: 10px;
            font-weight: 500;
        }
        
        #industryFilter option:hover {
            background: #334155;
        }
        .show-more-btn {
            display: inline-block;
            padding: 12px 32px;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(139, 92, 246, 0.2);
            margin: 0 auto;
        }
        .show-more-btn:hover {
            opacity: 0.9;
            box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3);
        }
        .show-more-btn:active {
            opacity: 0.8;
        }
        
        /* Company Modal Styles - Complete copy from provided HTML */
        #companyModal.modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 0;
            animation: fadeIn 0.3s ease;
        }
        
        #companyModal .close-btn {
            position: fixed;
            top: 40px;
            right: 40px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1001;
        }
        
        #companyModal .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg) scale(1.1);
        }
        
        #companyModal .close-btn svg {
            width: 20px;
            height: 20px;
            color: #e7e9ea;
        }
        
        #companyModal .company-card {
            background: #0f172a;
            border: none;
            border-radius: 0;
            box-shadow: none;
            max-width: 100vw;
            width: 100vw;
            max-height: 100vh;
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            animation: slideUp 0.4s ease;
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        #companyModal .card-content {
            min-height: 100vh;
            overflow: visible;
            display: flex;
            flex-direction: column;
        }
        
        #companyModal .company-card::-webkit-scrollbar {
            width: 8px;
        }
        
        #companyModal .company-card::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.3);
        }
        
        #companyModal .company-card::-webkit-scrollbar-thumb {
            background: rgba(71, 85, 105, 0.5);
            border-radius: 4px;
        }
        
        #companyModal .company-card::-webkit-scrollbar-thumb:hover {
            background: rgba(71, 85, 105, 0.7);
        }
        
        /* Scrollbar removed for cleaner look */
        
        #companyModal .card-header {
            background: rgba(15, 23, 42, 0.98);
            padding: 30px 40px;
            position: relative;
            border-bottom: 1px solid rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(20px);
        }
        
        #companyModal .company-info {
            position: relative;
            z-index: 2;
        }
        
        #companyModal .company-title {
            font-size: 32px;
            font-weight: 900;
            color: #ffffff;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
            line-height: 1.2;
        }
        
        #companyModal .company-subtitle {
            color: #71767b;
            font-size: 16px;
            font-weight: 400;
            margin-bottom: 24px;
        }
        
        #companyModal .company-meta {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            margin-bottom: 24px;
        }
        
        #companyModal .badges-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 16px 0 20px 0;
            width: 100%;
        }
        
        #companyModal .company-badges {
            display: flex;
            gap: 12px;
            align-items: center;
            flex: 1;
            min-width: 0;
        }
        
        #companyModal .badge {
            padding: 8px 16px;
            border-radius: 100px;
            font-size: 14px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
        }
        
        #companyModal .active-badge {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
            color: #22c55e;
        }
        
        #companyModal .company-number {
            background: rgba(71, 85, 105, 0.3);
            border-color: rgba(71, 85, 105, 0.5);
            color: #cbd5e1;
            font-family: monospace;
        }
        
        #companyModal .company-type {
            background: rgba(71, 85, 105, 0.3);
            border-color: rgba(71, 85, 105, 0.5);
            color: #94a3b8;
        }
        
        #companyModal .dropdown-badge {
            background: rgba(71, 85, 105, 0.3);
            border-color: rgba(71, 85, 105, 0.5);
            color: #94a3b8;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            position: relative;
        }
        
        #companyModal .dropdown-badge svg {
            width: 12px;
            height: 12px;
        }
        
        #companyModal .tooltip {
            position: absolute;
            top: 100%;
            left: 0;
            background: #0f172a;
            border: 1px solid #475569;
            border-radius: 6px;
            padding: 8px 12px;
            margin-top: 4px;
            white-space: nowrap;
            font-size: 11px;
            font-weight: 400;
            color: #cbd5e1;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            width: 180px;
            white-space: normal;
            line-height: 1.3;
        }
        
        #companyModal .tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 16px;
            border: 4px solid transparent;
            border-bottom-color: #0f172a;
        }
        
        #companyModal .dropdown-badge:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        #companyModal .stats-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 16px;
            margin-top: 20px;
        }
        
        #companyModal .stat-box {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(51, 65, 85, 0.6);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        
        #companyModal .stat-value {
            font-size: 32px;
            font-weight: 800;
            color: #ffffff;
            margin-bottom: 8px;
        }
        
        #companyModal .stat-label {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #71767b;
            font-weight: 700;
        }
        
        #companyModal .stat-detail {
            font-size: 12px;
            color: #71767b;
            margin-top: 6px;
            font-weight: 400;
        }
        
        #companyModal .stat-detail.download-link {
            color: #3b82f6;
            text-decoration: underline;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        
        #companyModal .stat-detail.download-link:hover {
            color: #60a5fa;
        }
        
        #companyModal .charges-number {
            color: #ef4444 !important;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
        }
        
        #companyModal .risk-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #22c55e;
            padding: 8px 16px;
            border-radius: 100px;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        #companyModal .risk-badge.medium {
            background: rgba(251, 146, 60, 0.1);
            border-color: rgba(251, 146, 60, 0.3);
            color: #fb923c;
        }
        
        #companyModal .risk-badge.high {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.2);
        }
        
        #companyModal .risk-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: currentColor;
        }
        
        #companyModal .tabs-container {
            background: rgba(15, 23, 42, 0.95);
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }
        
        #companyModal .tabs-nav {
            display: flex;
            background: rgba(15, 23, 42, 0.8);
            border-bottom: 1px solid rgba(30, 41, 59, 0.5);
            overflow-x: auto;
            scrollbar-width: none;
            align-items: stretch;
            min-height: 60px;
            padding: 0 40px;
        }
        
        #companyModal .tabs-nav::-webkit-scrollbar {
            display: none;
        }
        
        #companyModal .tab-btn {
            padding: 16px 20px;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 0 0 auto;
        }
        
        #companyModal .tab-btn:hover {
            color: #e2e8f0;
            background: #334155;
        }
        
        #companyModal .tab-btn.active {
            color: #ffffff;
            border-bottom-color: #3b82f6;
            background: #334155;
        }
        
        #companyModal .tab-content {
            padding: 40px;
            background: rgba(15, 23, 42, 0.6);
            min-height: 400px;
            flex: 1;
            overflow-y: auto;
            display: block;
        }
        
        #companyModal .tab-pane {
            display: none;
            opacity: 0;
        }
        
        #companyModal .tab-pane.active {
            display: block;
            opacity: 1;
            animation: fadeInContent 0.3s ease;
        }
        
        @keyframes fadeInContent {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #companyModal .tab-pane h3 {
            font-size: 24px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 24px;
        }
        
        #companyModal .data-item {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(51, 65, 85, 0.5);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        
        #companyModal .data-item-header {
            font-size: 16px;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 8px;
        }
        
        #companyModal .data-item-detail {
            color: #cbd5e1;
            line-height: 1.6;
        }
        
        /* Responsive breakpoints for modal stats grid */
        @media (max-width: 1400px) {
            #companyModal .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 16px;
            }
        }
        
        @media (max-width: 900px) {
            #companyModal .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
        }
        
        @media (max-width: 500px) {
            #companyModal .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                margin-top: 24px;
            }
        }
        
        /* Enhanced Mobile UX for modal */
        @media (max-width: 768px) {
            #companyModal.modal-backdrop {
                padding: 0;
            }
            
            #companyModal .company-card {
                max-height: 100vh;
                height: 100vh;
                border-radius: 0;
                width: 100vw;
            }
            
            #companyModal .card-content {
                height: 100vh;
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            #companyModal .close-btn {
                top: 16px;
                right: 16px;
                width: 36px;
                height: 36px;
            }
            
            #companyModal .close-btn svg {
                width: 16px;
                height: 16px;
            }
            
            #companyModal .card-header {
                padding: max(24px, calc(env(safe-area-inset-top) + 24px)) 20px 24px 20px;
            }
            
            #companyModal .company-title {
                font-size: 28px;
                line-height: 1.2;
                margin-bottom: 8px;
            }
            
            #companyModal .company-subtitle {
                font-size: 14px;
                margin-bottom: 20px;
            }
            
            #companyModal .badges-row {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
                margin: 20px 0 24px 0;
            }
            
            #companyModal .company-badges {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            #companyModal .badge {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            #companyModal .risk-badge {
                padding: 8px 16px;
                font-size: 13px;
                align-self: flex-start;
            }
            
            #companyModal .stat-box {
                padding: 16px 12px;
                min-height: 100px;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
            
            #companyModal .stat-value {
                font-size: 24px;
                margin-bottom: 6px;
            }
            
            #companyModal .stat-label {
                font-size: 11px;
                letter-spacing: 0.5px;
                line-height: 1.2;
            }
            
            #companyModal .stat-detail {
                font-size: 10px;
                margin-top: 4px;
                line-height: 1.3;
            }
            
            #companyModal .tabs-nav {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
                padding: 0 4px;
            }
            
            #companyModal .tab-btn {
                padding: 16px 20px;
                font-size: 12px;
                min-width: 120px;
                text-align: center;
            }
            
            #companyModal .tab-content {
                padding: 20px;
            }
            
            #companyModal .tab-pane h3 {
                font-size: 20px;
                margin-bottom: 20px;
            }
            
            #companyModal .data-item {
                padding: 16px;
                margin-bottom: 12px;
            }
            
            #companyModal .data-item-header {
                font-size: 14px;
                margin-bottom: 6px;
            }
            
            #companyModal .data-item-detail {
                font-size: 13px;
                line-height: 1.5;
            }
        }
        
        /* Ultra-small screens for modal */
        @media (max-width: 375px) {
            #companyModal .card-header {
                padding: max(20px, calc(env(safe-area-inset-top) + 20px)) 16px 20px 16px;
            }
            
            #companyModal .company-title {
                font-size: 24px;
            }
            
            #companyModal .company-badges {
                gap: 6px;
            }
            
            #companyModal .badge {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            #companyModal .stat-box {
                padding: 12px 8px;
                min-height: 90px;
            }
            
            #companyModal .stat-value {
                font-size: 20px;
            }
            
            #companyModal .stat-label {
                font-size: 10px;
            }
            
            #companyModal .stat-detail {
                font-size: 9px;
            }
            
            #companyModal .tab-btn {
                padding: 14px 16px;
                font-size: 11px;
                min-width: 100px;
            }
            
            #companyModal .tab-content {
                padding: 16px;
            }
        }
        
        /* Large screens - ensure 6 boxes in one row for modal */
        @media (min-width: 1024px) {
            #companyModal .stats-grid {
                grid-template-columns: repeat(6, 1fr);
                gap: 20px;
            }
            
            #companyModal .stat-box {
                min-height: 120px;
            }
        }
        
        /* Extra large screens for modal */
        @media (min-width: 1400px) {
            #companyModal .stats-grid {
                grid-template-columns: repeat(6, 1fr);
                gap: 24px;
            }
            
            #companyModal .stat-box {
                padding: 24px 20px;
                min-height: 140px;
            }
            
            #companyModal .stat-value {
                font-size: 36px;
            }
            
            #companyModal .stat-label {
                font-size: 14px;
            }
            
            #companyModal .stat-detail {
                font-size: 13px;
            }
        }
    </style>
    
    <!-- Schema.org Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "DocSpace - Companies House Document Downloader",
      "url": "https://docspace.uk",
      "description": "Download all Companies House documents and filings for any UK company as a ZIP file. Fast, reliable service for just ¬£5 per company.",
      "applicationCategory": "BusinessApplication",
      "operatingSystem": "Any",
      "offers": {
        "@type": "Offer",
        "price": "5.00",
        "priceCurrency": "GBP",
        "availability": "https://schema.org/InStock"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.8",
        "ratingCount": "127"
      },
      "provider": {
        "@type": "Organization",
        "name": "DocSpace UK",
        "url": "https://docspace.uk",
        "logo": "https://docspace.uk/",
        "sameAs": [
          "https://twitter.com/docspaceuk",
          "https://www.linkedin.com/company/docspace-uk"
        ]
      }
    }
    </script>
</head>
<body>
    <!-- Animated background -->
    <div class="bg-animation"></div>
    
    <!-- Top bar -->
    <div class="top-bar">
        <div class="logo-small" onclick="triggerLogoEffect()">
            <div class="logo-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
            </div>
            <span class="logo-text">DocSpace</span>
        </div>
        <div class="top-bar-actions">
            <!-- Auth button container with dropdown -->
            <div style="position: relative;">
                <!-- Guest button (shown when not logged in) -->
                <button class="create-account-btn profile-mode" id="guestBtn" aria-label="Account" style="display: flex;" onclick="document.getElementById('guestDropdown').classList.toggle('show')">
                    <div class="profile-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </div>
                    <span class="profile-text">Create Account</span>
                </button>
                
                <!-- User button (shown when logged in) -->
                <button class="create-account-btn profile-mode" id="userBtn" aria-label="Account" style="display: none;" onclick="document.getElementById('userDropdown').classList.toggle('show')">
                    <div class="profile-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                </button>
                
                <!-- Guest dropdown -->
                <div class="profile-dropdown" id="guestDropdown">
                    <button class="dropdown-item" onclick="window.location.href='auth.html'">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                        </svg>
                        Create Account
                    </button>
                    <button class="dropdown-item" onclick="window.location.href='auth.html?mode=signin'">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                        Sign In
                    </button>
                    <!-- Light mode toggle commented out for now
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item" onclick="toggleTheme()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                        <span id="themeText">Dark Mode</span>
                    </button>
                    -->
                </div>
                
                <!-- User dropdown -->
                <div class="profile-dropdown" id="userDropdown">
                    <button class="dropdown-item" onclick="alert('Companies I Follow - Coming soon!')">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                        </svg>
                        Companies I Follow
                    </button>
                    <button class="dropdown-item" onclick="window.location.href='/search-history.html'">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Search History
                    </button>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item danger" onclick="signOut()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                        Log Out
                    </button>
                    <!-- Light mode toggle commented out for now
                    <button class="dropdown-item" onclick="toggleTheme()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                        <span id="themeTextUser">Dark Mode</span>
                    </button>
                    -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main container -->
    <div class="main-container">
        <!-- Hero section -->
        <div class="hero">
            <h1 class="hero-subtitle">UK Company Intelligence</h1>
            
            <!-- Tagline badge -->
            <div style="text-align: center; margin-top: 20px;">
                <div style="display: inline-block; padding: 12px 24px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 50px; color: #a5b4fc; font-size: 16px; font-weight: 600;">
                    Get insights, automate the boring
                </div>
            </div>
        </div>
        
        <!-- Search container -->
        <div class="search-container">
            <!-- Tab navigation -->
            <div class="tab-navigation">
                <button class="tab-button active" onclick="switchTab('explore')">
                    Explore
                </button>
                <button class="tab-button" onclick="switchTab('search')">
                    Bulk PDF Download
                </button>
            </div>
            
            <!-- Search tab content -->
            <div class="tab-content" id="searchTab">
                <form id="searchForm">
                    <div class="search-wrapper">
                        <div class="autocomplete-wrapper" style="flex: 1; min-width: 0;">
                            <input 
                                type="text" 
                                id="companyName" 
                                name="companyName" 
                                class="form-input"
                                placeholder="Search UK companies by name or number"
                                required
                                autocomplete="off"
                            >
                            <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
                        </div>
                        <button type="submit" class="search-btn" id="searchBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            <span>Search</span>
                        </button>
                    </div>
                    <!-- Subtle price info -->
                    <div style="text-align: left; margin-top: 8px; margin-bottom: 8px;">
                        <p style="color: #64748b; font-size: 14px; font-weight: 500; margin: 0; padding: 4px 0;">
                            Download all company PDFs for just 
                            <span style="color: #a5b4fc; font-weight: 600;">¬£5</span>
                        </p>
                    </div>
                </form>
            </div>
            
            <!-- Explore tab content -->
            <div class="tab-content active" id="exploreTab">
                <!-- Search Form for Explore Tab -->
                <form id="exploreSearchForm" style="margin-bottom: 24px;">
                    <div class="search-wrapper">
                        <div class="autocomplete-wrapper" style="flex: 1; min-width: 0; position: relative;">
                            <input 
                                type="text" 
                                id="exploreCompanyName" 
                                name="exploreCompanyName" 
                                class="form-input"
                                placeholder="Search companies by name..."
                                autocomplete="off"
                                style="background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 16px 50px 16px 20px; color: white; font-size: 16px; height: 56px; width: 100%;"
                            >
                            <button 
                                type="button" 
                                id="clearExploreSearch"
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 8px; display: none; color: #94a3b8; transition: color 0.3s ease;"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- Toggle buttons and filters -->
                <div style="display: flex; flex-direction: column; gap: 12px; margin: 24px 0;">
                    <!-- Line 1: Oldest, Newest, Active Only -->
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button class="toggle-btn active" onclick="showOldest()" id="oldestBtn" title="Show oldest companies">Oldest</button>
                        <button class="toggle-btn" onclick="showNewest()" id="newestBtn" title="Show newest companies">Newest</button>
                        <div style="display: flex; align-items: center; gap: 16px; margin-left: auto;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="switch" onclick="toggleActive(this)" id="activeSwitch"></div>
                                <span style="color: #94a3b8; font-size: 13px; white-space: nowrap;">
                                    <span class="desktop-text">Active Only</span>
                                    <span class="mobile-text">Active</span>
                                </span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="switch" onclick="toggleCharges(this)" id="chargesSwitch"></div>
                                <span style="color: #94a3b8; font-size: 13px; display: flex; align-items: center; gap: 4px; white-space: nowrap;">
                                    <span class="charges-indicator" data-tooltip="Companies with outstanding mortgages or charges">!</span>
                                    <span class="desktop-text">Has Charges</span>
                                    <span class="mobile-text">Charges</span>
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Line 2: Industry Filter (full width) -->
                    <div style="width: 100%;">
                        <select id="industryFilter" onchange="onIndustryChange()" style="
                            width: 100%;
                            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
                            border: 1px solid rgba(99, 102, 241, 0.3);
                            color: #e2e8f0;
                            padding: 8px 16px 8px 12px;
                            padding-right: 36px;
                            border-radius: 10px;
                            font-size: 13px;
                            font-weight: 500;
                            cursor: pointer;
                            outline: none;
                            min-width: 180px;
                            appearance: none;
                            background-image: url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"12\" height=\"12\" viewBox=\"0 0 12 12\"><path fill=\"%23a5b4fc\" d=\"M6 9L1 4h10z\"/></svg>');
                            background-repeat: no-repeat;
                            background-position: right 12px center;
                            transition: all 0.3s ease;
                            position: relative;
                        ">
                            <option value="ALL" selected>üåê All Industries</option>
                            <option value="AGRICULTURE">üåæ Agriculture</option>
                            <option value="FINANCIAL">üí∞ Financial</option>
                            <option value="TECHNOLOGY">üíª Technology</option>
                            <option value="RETAIL">üõçÔ∏è Retail</option>
                            <option value="MANUFACTURING">üè≠ Manufacturing</option>
                            <option value="REAL_ESTATE">üè¢ Real Estate</option>
                            <option value="ENERGY">‚ö° Energy</option>
                            <option value="HEALTHCARE">üè• Healthcare</option>
                            <option value="TRANSPORT">üöö Transport</option>
                            <option value="CONSTRUCTION">üèóÔ∏è Construction</option>
                            <option value="SERVICES">üíº Services</option>
                            <option value="MEDIA">üì∫ Media</option>
                            <option value="OTHER">üìÅ Other</option>
                        </select>
                    </div>
                </div>
                
                <!-- Company list -->
                <div id="companyListExplore"></div>
                
                <!-- Show more button -->
                <div style="text-align: center; margin-top: 24px; padding-bottom: 24px;">
                    <button class="show-more-btn" id="loadMoreBtn" onclick="loadMore()">Create Account for More</button>
                    <p style="color: #94a3b8; font-size: 14px; margin-top: 12px; margin-bottom: 0;">Get access to 5.6M UK Companies</p>
                </div>
            </div>
        </div>
        
        <!-- Toast container -->
        <div class="toast-container" id="toastContainer"></div>
        
        <!-- Results container -->
        <div class="results-container" id="resultsContainer">
            <div class="company-card" id="companyCard">
                <div class="company-name" id="companyNameDisplay"></div>
                <div class="company-info" id="companyInfo"></div>
                <div class="document-stats" id="documentStats">
                    <div class="stat-item">
                        <div class="stat-number" id="totalDocs">0</div>
                        <div class="stat-label">Total Documents</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="companyAge">0</div>
                        <div class="stat-label">Years Old</div>
                    </div>
                </div>
                <button class="btn btn-success" id="downloadZipBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                    </svg>
                    Download All Documents
                </button>
            </div>
            
            <!-- Progress section -->
            <div class="progress-section" id="progressContainer">
                <div class="progress-header">
                    <div class="progress-title">Downloading Documents</div>
                    <div class="progress-count" id="fileCount">0 of 0</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="file-list" id="fileList"></div>
            </div>
        </div>
        
        <!-- Info section -->
        <div class="info-section-single" id="marketingSection">
            <div class="info-container">
                <div class="info-content">
                    <div class="info-column">
                        <h3 class="info-title">Why DocSpace?</h3>
                        <ul class="feature-list compact">
                            <li class="feature-item">All filings in one click</li>
                            <li class="feature-item">Blazing-fast downloads</li>
                            <li class="feature-item">Flat ¬£5 fee per company</li>
                            <li class="feature-item">Secure Stripe checkout</li>
                            <li class="feature-item">No sign-up, no fuss</li>
                        </ul>
                    </div>
                    
                    <div class="info-column">
                        <h3 class="info-title">Who Uses DocSpace?</h3>
                        <div class="user-list">
                            <div class="user-item">
                                <strong>1. Accountants & Bookkeepers</strong>
                                <p>Quickly collect client filings for audits, tax prep, or financial reviews.</p>
                            </div>
                            <div class="user-item">
                                <strong>2. Corporate Investigators & Due Diligence Teams</strong>
                                <p>Download full company histories for M&A, compliance checks, or KYC.</p>
                            </div>
                            <div class="user-item">
                                <strong>3. Lawyers & Legal Researchers</strong>
                                <p>Access incorporation papers, director changes, charges‚Äîall in one go.</p>
                            </div>
                            <div class="user-item">
                                <strong>4. Investors & Analysts</strong>
                                <p>Evaluate company health and structure before investing or partnering.</p>
                            </div>
                            <div class="user-item">
                                <strong>5. Journalists & Researchers</strong>
                                <p>Get instant access to company disclosures for reports or case studies.</p>
                            </div>
                            <div class="user-item">
                                <strong>6. Founders & Business Owners</strong>
                                <p>Check competitor filings or retrieve your own archive easily.</p>
                            </div>
                            <div class="user-item">
                                <strong>7. Procurement & Risk Teams</strong>
                                <p>Vet suppliers with full filing history in seconds.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        </div>
    </div>
    
    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-logo">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="24" height="24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
                DocSpace UK
            </div>
            <div class="footer-links">
                <a href="/terms">Terms of Service</a>
                <a href="/privacy">Privacy Policy</a>
                <a href="/contact">Contact</a>
                <a href="/api">API Access</a>
            </div>
            <div class="footer-copyright">
                ¬© 2025 DocSpace UK - Companies House Document Download Service
            </div>
        </div>
    </footer>
    
    <script>
        const WORKER_URL = 'https://blue-flower-d40f.mahin84.workers.dev';
        const API_KEY = '22aefa40-ee9e-47c0-b40a-2dd3c03165c6';
        const STRIPE_PUBLIC_KEY = 'pk_test_51RT33XAJ1gsWpnv6rpEFMeCmuADlJet1lmqeaMrPXas4DYblZZ73SOnNEXb0gE5ADHrfRkVJIXyACM3Nw5Vt9HCz00L8E9wffe';
        let allDocuments = [];
        let companyData = null;
        let paymentCompleted = false;
        
        // Global variable for explore search
        let exploreSearchQuery = '';
        
        // Define clearExploreSearch function early so it's available for onclick
        function clearExploreSearch() {
            console.log('Clear search button clicked');
            
            const searchInput = document.getElementById('exploreCompanyName');
            const clearButton = document.getElementById('clearExploreSearch');
            
            if (searchInput) {
                searchInput.value = '';
                exploreSearchQuery = '';
                if (clearButton) {
                    clearButton.style.display = 'none';
                }
                
                // Reset to original data and reload
                companiesOffset = 5;
                
                // Clear the search state and reload the appropriate companies
                if (typeof currentView !== 'undefined') {
                    if (currentView === 'oldest') {
                        if (typeof oldestCompanies !== 'undefined') {
                            oldestCompanies = [];
                            window.oldestCompanies = [];
                        }
                        if (typeof showOldest === 'function') showOldest();
                    } else {
                        if (typeof newestCompanies !== 'undefined') {
                            newestCompanies = [];
                            window.newestCompanies = [];
                        }
                        if (typeof showNewest === 'function') showNewest();
                    }
                } else {
                    // Fallback - just reload the page section
                    if (typeof loadRealCompanies === 'function') {
                        loadRealCompanies();
                    }
                }
            }
            
            return false;
        }
        
        // Function to download a single filing document
        async function downloadSingleFiling(metadataUrl, description, dateText) {
            console.log('Downloading filing:', description);
            
            try {
                // Show loading state on button
                const button = event.target.closest('button');
                const originalHTML = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<span class="spinner"></span> Downloading...';
                
                // Ensure we have full URL
                if (metadataUrl.startsWith('/')) {
                    metadataUrl = `https://api.companieshouse.gov.uk${metadataUrl}`;
                }
                
                // Fetch the PDF content
                const contentUrl = `${metadataUrl}/content`;
                const response = await fetchWithWorker(contentUrl, API_KEY);
                
                if (!response.ok) {
                    throw new Error(`Failed to download: ${response.status}`);
                }
                
                const blob = await response.blob();
                
                if (blob.size === 0) {
                    throw new Error('Document is empty');
                }
                
                // Create filename from description and date
                const safeDescription = description.replace(/[^a-z0-9]/gi, '_').substring(0, 50);
                const safeDate = dateText.replace(/\s+/g, '_');
                const filename = `${safeDate}_${safeDescription}.pdf`;
                
                // Download the file
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // Show success state
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="14" height="14">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    Downloaded
                `;
                button.style.color = '#10b981';
                button.style.borderColor = 'rgba(16, 185, 129, 0.3)';
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.disabled = false;
                    button.style.color = '';
                    button.style.borderColor = '';
                }, 3000);
                
            } catch (error) {
                console.error('Download error:', error);
                
                // Show error state
                const button = event.target.closest('button');
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="14" height="14">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    Error
                `;
                button.style.color = '#ef4444';
                button.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                
                // Show toast with error
                if (typeof showToast === 'function') {
                    showToast(`Download failed: ${error.message}`, 'error');
                } else {
                    alert(`Download failed: ${error.message}`);
                }
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    button.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="14" height="14">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                        </svg>
                        Download
                    `;
                    button.disabled = false;
                    button.style.color = '';
                    button.style.borderColor = '';
                }, 3000);
            }
        }
        
        // Make downloadSingleFiling globally available
        window.downloadSingleFiling = downloadSingleFiling;
        
        // Define menu functions early so they're available immediately
        function showUserMenu() {
            const dropdown = document.getElementById('profileDropdown');
            if (!dropdown) return;
            
            dropdown.innerHTML = `
                <button class="dropdown-item" onclick="showMonitoredCompanies()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                    </svg>
                    Companies I Follow
                </button>
                <button class="dropdown-item" onclick="showSearchHistory()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Search History
                </button>
                <div class="dropdown-divider"></div>
                <button class="dropdown-item danger" onclick="signOut()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Log Out
                </button>
            `;
            dropdown.classList.toggle('show');
        }
        
        function showGuestMenu() {
            const dropdown = document.getElementById('profileDropdown');
            if (!dropdown) return;
            
            dropdown.innerHTML = `
                <button class="dropdown-item" onclick="window.location.href='auth.html'">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                    </svg>
                    Create Account
                </button>
                <button class="dropdown-item" onclick="window.location.href='auth.html?mode=signin'">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Sign In
                </button>
            `;
            dropdown.classList.toggle('show');
        }
        
        function showMonitoredCompanies() {
            alert('Companies I Follow - Coming soon!');
        }
        
        function showSearchHistory() {
            window.location.href = '/search-history.html';
        }
        
        // Global auth button handler (simple version that doesn't need supabase)
        function handleAuthButtonClick(event) {
            event.preventDefault();
            event.stopPropagation();
            
            console.log('Auth button clicked!');
            
            // For now, just toggle the dropdown
            const dropdown = document.getElementById('profileDropdown');
            if (dropdown) {
                // Simple toggle for testing
                if (dropdown.classList.contains('show')) {
                    dropdown.classList.remove('show');
                } else {
                    // Just show guest menu for now
                    showGuestMenu();
                }
            } else {
                console.error('Dropdown element not found!');
            }
        }
        
        // Initialize Stripe
        const stripe = Stripe(STRIPE_PUBLIC_KEY);
        
        // Autocomplete variables
        let autocompleteTimeout = null;
        let selectedIndex = -1;
        let suggestions = [];
        
        // Dark mode toggle - commented out for now
        /*
        const body = document.body;
        
        // Check for saved theme preference
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            body.classList.add('light-mode');
            updateThemeText();
        }
        
        function toggleTheme() {
            body.classList.toggle('light-mode');
            updateThemeText();
            localStorage.setItem('theme', body.classList.contains('light-mode') ? 'light' : 'dark');
            // Close any open dropdowns
            document.getElementById('guestDropdown').classList.remove('show');
            document.getElementById('userDropdown').classList.remove('show');
        }
        
        function updateThemeText() {
            const themeText = document.getElementById('themeText');
            const themeTextUser = document.getElementById('themeTextUser');
            const newText = body.classList.contains('light-mode') ? 'Dark Mode' : 'Light Mode';
            if (themeText) themeText.textContent = newText;
            if (themeTextUser) themeTextUser.textContent = newText;
        }
        */
        
        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find and activate the correct tab button
            if (event && event.target) {
                event.target.closest('.tab-button').classList.add('active');
            } else {
                // When called programmatically, find the button by tabName
                document.querySelectorAll('.tab-button').forEach(btn => {
                    if ((tabName === 'search' && btn.textContent.includes('Search')) ||
                        (tabName === 'explore' && btn.textContent.includes('Explore'))) {
                        btn.classList.add('active');
                    }
                });
            }
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabName === 'search') {
                document.getElementById('searchTab').classList.add('active');
            } else if (tabName === 'explore') {
                document.getElementById('exploreTab').classList.add('active');
                // Immediately render companies when explore tab is shown
                renderCompanies();
            }
        }
        
        // Logo click effect - confetti animation
        function triggerLogoEffect() {
            createConfetti();
            
            // Only reload if not on home page
            const isHomePage = window.location.pathname === '/' || 
                             window.location.pathname === '/index.html' ||
                             window.location.pathname === '';
            
            if (!isHomePage) {
                // Navigate to home page if on a different page
                setTimeout(() => {
                    window.location.href = '/';
                }, 3000);
            }
            // If on home page, just show confetti without reloading
        }
        
        function createConfetti() {
            const container = document.createElement('div');
            container.className = 'confetti-container';
            document.body.appendChild(container);
            
            // Get logo position
            const logo = document.querySelector('.logo-small');
            const logoRect = logo.getBoundingClientRect();
            const logoCenterX = logoRect.left + logoRect.width / 2;
            const logoCenterY = logoRect.top + logoRect.height / 2;
            
            const colors = ['#6366f1', '#8b5cf6', '#ec4899', '#3b82f6', '#10b981', '#f59e0b', '#ef4444'];
            const shapes = ['square', 'circle', 'triangle'];
            const confettiCount = 60;
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                const shape = shapes[Math.floor(Math.random() * shapes.length)];
                confetti.className = `confetti ${shape}`;
                
                // Random color
                const color = colors[Math.floor(Math.random() * colors.length)];
                if (shape === 'triangle') {
                    confetti.style.borderBottomColor = color;
                } else {
                    confetti.style.background = color;
                }
                
                // Position at logo center
                confetti.style.left = logoCenterX + 'px';
                confetti.style.top = logoCenterY + 'px';
                
                // Random burst direction
                const angle = (Math.PI * 2 * i) / confettiCount + (Math.random() - 0.5) * 0.5;
                const velocity = 200 + Math.random() * 400;
                const vx = Math.cos(angle) * velocity;
                const vy = Math.sin(angle) * velocity - 100; // Slight upward bias
                
                confetti.style.setProperty('--x', vx + 'px');
                confetti.style.setProperty('--y', vy + 'px');
                
                // Random delay for staggered burst
                confetti.style.animationDelay = Math.random() * 0.2 + 's';
                
                // Random size
                const size = Math.random() * 8 + 6;
                if (shape !== 'triangle') {
                    confetti.style.width = size + 'px';
                    confetti.style.height = size + 'px';
                } else {
                    confetti.style.borderLeftWidth = (size/2) + 'px';
                    confetti.style.borderRightWidth = (size/2) + 'px';
                    confetti.style.borderBottomWidth = size + 'px';
                }
                
                container.appendChild(confetti);
            }
            
            // Add a flash effect on the logo
            logo.style.transform = 'scale(1.2)';
            logo.style.transition = 'transform 0.3s ease';
            setTimeout(() => {
                logo.style.transform = '';
            }, 300);
            
            // Clean up after animation
            setTimeout(() => {
                container.remove();
            }, 3000);
        }
        
        // Helper functions
        function addDebug(message) {
            console.log(`${new Date().toISOString().substr(11, 8)} - ${message}`);
        }
        
        async function fetchWithWorker(url, apiKey) {
            const params = new URLSearchParams({
                url: url,
                apiKey: apiKey
            });
            const proxyUrl = `${WORKER_URL}?${params.toString()}`;
            
            addDebug(`Worker URL: ${WORKER_URL}`);
            addDebug(`Target URL: ${url}`);
            
            try {
                const response = await fetch(proxyUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': url.includes('/content') ? 'application/pdf' : 'application/json'
                    }
                });
                addDebug(`Response status: ${response.status}`);
                
                if (!response.ok) {
                    try {
                        const errorText = await response.text();
                        addDebug(`Error response: ${errorText}`);
                    } catch (e) {
                        // Ignore if can't read error
                    }
                }
                
                return response;
            } catch (error) {
                addDebug(`Fetch error: ${error.message}`);
                throw error;
            }
        }
        
        // Toast notification system
        function showToast(type, message, duration = 5000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // Icon based on type
            const icons = {
                success: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="toast-icon"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
                error: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="toast-icon"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
                info: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="toast-icon"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
            };
            
            toast.innerHTML = `
                ${icons[type] || icons.info}
                <div class="toast-message">${message}</div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            `;
            
            container.appendChild(toast);
            
            // Auto remove after duration
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        // Wrapper for old showStatus calls
        function showStatus(type, message) {
            showToast(type, message);
        }
        
        function updateProgress(current, total) {
            const percentage = Math.round((current / total) * 100);
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = `${percentage}%`;
            
            document.getElementById('fileCount').textContent = `${current} of ${total}`;
        }
        
        function addFileToList(filename, status, error = null) {
            const fileList = document.getElementById('fileList');
            const fileItem = document.createElement('div');
            fileItem.className = `file-item ${status}`;
            
            const icon = status === 'success' 
                ? '<svg class="file-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
                : '<svg class="file-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
            
            const errorText = error ? ` - ${error}` : '';
            fileItem.innerHTML = `${icon}<span class="file-name">${filename}${errorText}</span>`;
            
            fileList.appendChild(fileItem);
            fileList.scrollTop = fileList.scrollHeight;
        }
        
        async function displayCompanyInfo(company) {
            document.getElementById('companyNameDisplay').textContent = company.title;
            
            const companyInfo = document.getElementById('companyInfo');
            companyInfo.innerHTML = `
                <div class="info-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                    </svg>
                    ${company.company_number}
                </div>
                ${company.company_status ? `
                <div class="info-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    ${company.company_status.charAt(0).toUpperCase() + company.company_status.slice(1)}
                </div>
                ` : ''}
                ${company.date_of_creation ? `
                <div class="info-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Incorporated ${company.date_of_creation}
                </div>
                ` : ''}
            `;
            
            // Check download status for authenticated users
            if (currentUser && window.searchHistory) {
                try {
                    const downloadStatus = await window.searchHistory.checkDownloadStatus(company.company_number);
                    const downloadBtn = document.getElementById('downloadZipBtn');
                    const downloadBtnContainer = downloadBtn.parentElement;
                    
                    if (downloadStatus && downloadStatus.download_status === 'downloaded') {
                        // Company already downloaded - show free re-download option
                        const downloadedDate = new Date(downloadStatus.downloaded_at).toLocaleDateString();
                        
                        // Add downloaded indicator
                        const existingIndicator = downloadBtnContainer.querySelector('.download-status-indicator');
                        if (existingIndicator) existingIndicator.remove();
                        
                        const indicator = document.createElement('div');
                        indicator.className = 'download-status-indicator';
                        indicator.innerHTML = `
                            <div class="already-downloaded">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                Already downloaded on ${downloadedDate}
                            </div>
                        `;
                        downloadBtnContainer.insertBefore(indicator, downloadBtn);
                        
                        // Update button text
                        downloadBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Free Re-download
                        `;
                        downloadBtn.className = 'btn btn-primary'; // Change to green/primary color
                    } else {
                        // Company not downloaded yet - show normal download button
                        const existingIndicator = downloadBtnContainer.querySelector('.download-status-indicator');
                        if (existingIndicator) existingIndicator.remove();
                        
                        downloadBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                            </svg>
                            Download All Documents
                        `;
                        downloadBtn.className = 'btn btn-success';
                    }
                } catch (error) {
                    console.error('Error checking download status:', error);
                }
            }
        }
        
        // Search form handler
        const searchForm = document.getElementById('searchForm');
        if (searchForm) {
            searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const companyInput = document.getElementById('companyName');
            const companyName = companyInput.value.trim();
            const companyNumber = companyInput.dataset.companyNumber; // Get stored company number
            const searchBtn = document.getElementById('searchBtn');
            const resultsContainer = document.getElementById('resultsContainer');
            const progressContainer = document.getElementById('progressContainer');
            
            // Reset UI
            searchBtn.disabled = true;
            const btnIcon = searchBtn.querySelector('svg');
            const btnText = searchBtn.querySelector('span');
            if (btnIcon && btnText) {
                btnIcon.style.display = 'none';
                btnText.innerHTML = '<span class="spinner"></span>';
                if (window.innerWidth > 480) {
                    btnText.innerHTML = '<span class="spinner"></span> Search';
                }
                btnText.style.visibility = 'visible';
            }
            resultsContainer.style.display = 'none';
            progressContainer.style.display = 'none';
            document.getElementById('fileList').innerHTML = '';
            allDocuments = [];
            
            // Clear the stored company number after use
            delete companyInput.dataset.companyNumber;
            
            try {
                // If we have a company number from autocomplete, fetch directly
                if (companyNumber) {
                        
                    const companyUrl = `https://api.companieshouse.gov.uk/company/${companyNumber}`;
                    const companyResponse = await fetchWithWorker(companyUrl, API_KEY);
                    
                    if (!companyResponse.ok) {
                        throw new Error(`Failed to fetch company details (${companyResponse.status})`);
                    }
                    
                    companyData = await companyResponse.json();
                    companyData.company_number = companyNumber; // Ensure number is set
                    companyData.title = companyData.company_name; // Normalize field name
                } else {
                    // Otherwise, search by name
                        
                    const searchUrl = `https://api.companieshouse.gov.uk/search/companies?q=${encodeURIComponent(companyName)}&items_per_page=1`;
                    const searchResponse = await fetchWithWorker(searchUrl, API_KEY);
                    
                    if (!searchResponse.ok) {
                        if (searchResponse.status === 401) {
                            throw new Error('Invalid API key. Please check your credentials.');
                        }
                        throw new Error(`Failed to search for company (${searchResponse.status})`);
                    }
                    
                    const searchData = await searchResponse.json();
                    
                    if (!searchData.items || searchData.items.length === 0) {
                        throw new Error('No company found with that name');
                    }
                    
                    companyData = searchData.items[0];
                }
                
                // Move search history saving to after document count is available
                
                await displayCompanyInfo(companyData);
                
                // Get filing history
                
                const filingUrl = `https://api.companieshouse.gov.uk/company/${companyData.company_number}/filing-history?items_per_page=100`;
                const filingResponse = await fetchWithWorker(filingUrl, API_KEY);
                
                if (!filingResponse.ok) {
                    throw new Error('Failed to fetch filing history');
                }
                
                const filingData = await filingResponse.json();
                const documents = filingData.items || [];
                
                if (documents.length === 0) {
                    throw new Error('No documents found for this company');
                }
                
                // Filter documents with PDF links
                allDocuments = documents.filter(doc => {
                    return doc.links && doc.links.document_metadata;
                }).map(doc => {
                    let metadataUrl = doc.links.document_metadata;
                    
                    if (metadataUrl.startsWith('/')) {
                        metadataUrl = `https://api.companieshouse.gov.uk${metadataUrl}`;
                    }
                    
                    return {
                        date: doc.date || 'unknown',
                        category: doc.category || 'document',
                        description: doc.description || 'Untitled',
                        metadataUrl: metadataUrl,
                        filename: generateFilename(doc)
                    };
                });
                
                // Update stats
                document.getElementById('totalDocs').textContent = documents.length;
                
                // Add to search history for logged-in users with file count
                if (window.searchHistory) {
                    try {
                        // Double-check auth state before saving
                        const { data: { user } } = await supabaseClient.auth.getUser();
                        if (user) {
                            const result = await window.searchHistory.addSearch(companyData, documents.length);
                            console.log('Search history add result:', result);
                            if (result) {
                                console.log('Successfully added to search history:', companyData.company_name, 'with', documents.length, 'documents');
                            } else {
                                console.log('Failed to add to search history - result is null/undefined');
                            }
                        } else {
                            console.log('User not logged in, skipping search history');
                        }
                    } catch (error) {
                        console.error('Failed to add to search history:', error);
                    }
                }
                
                // Calculate company age
                if (companyData.date_of_creation) {
                    const incorporationDate = new Date(companyData.date_of_creation);
                    const currentDate = new Date();
                    const ageInYears = Math.floor((currentDate - incorporationDate) / (365.25 * 24 * 60 * 60 * 1000));
                    document.getElementById('companyAge').textContent = ageInYears;
                } else {
                    document.getElementById('companyAge').textContent = 'N/A';
                }
                
                if (allDocuments.length === 0) {
                    throw new Error('No downloadable PDFs found');
                }
                
                // Show results
                showStatus('success', `Found ${companyData.title} with ${allDocuments.length} downloadable documents`);
                resultsContainer.style.display = 'block';
                
            } catch (error) {
                showStatus('error', error.message);
                addDebug(`Error: ${error.message}`);
            } finally {
                searchBtn.disabled = false;
                const btnIcon = searchBtn.querySelector('svg');
                const btnText = searchBtn.querySelector('span');
                if (btnIcon && btnText) {
                    btnIcon.style.display = '';
                    btnText.innerHTML = 'Search';
                    btnText.style.visibility = 'visible';
                }
            }
        });
        }
        
        // Download handler
        async function startDownload() {
            const progressContainer = document.getElementById('progressContainer');
            const downloadZipBtn = document.getElementById('downloadZipBtn');
            
            downloadZipBtn.disabled = true;
            progressContainer.style.display = 'block';
            
            const zip = new JSZip();
            const companyFolder = zip.folder(sanitizeFilename(companyData.title));
            
            let downloaded = 0;
            let failed = 0;
            
            // Download all documents
            for (let i = 0; i < allDocuments.length; i++) {
                const doc = allDocuments[i];
                updateProgress(i + 1, allDocuments.length);
                
                try {
                    // CRITICAL FIX: Always append /content to get actual PDF, not metadata
                    const contentUrl = `${doc.metadataUrl}/content`;
                    
                    const pdfResponse = await fetchWithWorker(contentUrl, API_KEY);
                    
                    if (pdfResponse.ok) {
                        const pdfBlob = await pdfResponse.blob();
                        
                        if (pdfBlob.size > 0) {
                            companyFolder.file(doc.filename, pdfBlob);
                            downloaded++;
                            addFileToList(doc.filename, 'success');
                        } else {
                            failed++;
                            addFileToList(doc.filename, 'error', 'Empty file');
                        }
                    } else {
                        failed++;
                        addFileToList(doc.filename, 'error', `Status ${pdfResponse.status}`);
                    }
                    
                    // Small delay to avoid rate limiting
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    failed++;
                    addFileToList(doc.filename, 'error', error.message);
                }
            }
            
            if (downloaded > 0) {
                try {
                    const content = await zip.generateAsync({ 
                        type: 'blob',
                        compression: 'DEFLATE',
                        compressionOptions: { level: 6 }
                    });
                    
                    saveAs(content, `${sanitizeFilename(companyData.title)}_documents.zip`);
                    
                    showStatus('success', 
                        `‚ú® Download complete! ${downloaded} files downloaded${failed > 0 ? `, ${failed} failed` : ''}.`
                    );
                } catch (error) {
                    showStatus('error', 'Failed to create ZIP file');
                }
            } else {
                showStatus('error', 'No files could be downloaded.');
            }
            
            downloadZipBtn.disabled = false;
        }
        
        const downloadBtn = document.getElementById('downloadZipBtn');
        if (downloadBtn) {
            downloadBtn.addEventListener('click', async () => {
            const downloadZipBtn = document.getElementById('downloadZipBtn');
            
            if (!paymentCompleted) {
                downloadZipBtn.disabled = true;
                downloadZipBtn.innerHTML = '<span class="spinner"></span> Processing payment...';
                
                try {
                    showStatus('info', 'Redirecting to payment...');
                    
                    const dataToStore = {
                        companyData: companyData,
                        allDocuments: allDocuments,
                        timestamp: Date.now()
                    };
                    
                    localStorage.setItem('pendingCompany', JSON.stringify(dataToStore));
                    
                    const paymentUrl = 'https://buy.stripe.com/6oU14m6YxcZL9ywgEncwg01';
                    window.location.href = paymentUrl;
                    
                } catch (error) {
                    showStatus('error', 'Payment error: ' + error.message);
                    downloadZipBtn.disabled = false;
                    downloadZipBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                        </svg>
                        Download All Documents
                    `;
                }
                return;
            }
            
            await startDownload();
        });
        }
        
        function generateFilename(doc) {
            const date = doc.date || 'unknown';
            const category = doc.category || 'document';
            const desc = (doc.description || 'document').substring(0, 50);
            const safeDesc = sanitizeFilename(desc);
            return `${date}_${category}_${safeDesc}.pdf`;
        }
        
        function sanitizeFilename(name) {
            return name.replace(/[^a-z0-9\s\-\_]/gi, '').trim().replace(/\s+/g, '_');
        }
        
        // Autocomplete functionality
        const companyInput = document.getElementById('companyName');
        const autocompleteDropdown = document.getElementById('autocompleteDropdown');
        
        if (!companyInput || !autocompleteDropdown) {
            console.log('Search form elements not found, skipping autocomplete setup');
            // Skip the rest of autocomplete setup if elements don't exist
        } else {
        
        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Search companies for autocomplete
        async function searchCompanies(query) {
            if (query.length < 2) {
                hideAutocomplete();
                return;
            }
            
            // Show loading state
            autocompleteDropdown.innerHTML = '<div class="autocomplete-loading"><div class="spinner"></div></div>';
            autocompleteDropdown.classList.add('show');
            
            try {
                const searchUrl = `https://api.companieshouse.gov.uk/search/companies?q=${encodeURIComponent(query)}&items_per_page=5`;
                const response = await fetchWithWorker(searchUrl, API_KEY);
                
                if (!response.ok) {
                    hideAutocomplete();
                    return;
                }
                
                const data = await response.json();
                suggestions = data.items || [];
                
                if (suggestions.length === 0) {
                    autocompleteDropdown.innerHTML = '<div class="autocomplete-empty">No companies found</div>';
                    return;
                }
                
                // Render suggestions
                renderSuggestions();
                
            } catch (error) {
                console.error('Autocomplete error:', error);
                hideAutocomplete();
            }
        }
        
        // Render autocomplete suggestions
        function renderSuggestions() {
            autocompleteDropdown.innerHTML = suggestions.map((company, index) => {
                const statusClass = company.company_status === 'active' ? 'active' : 'dissolved';
                const statusIcon = company.company_status === 'active' 
                    ? '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="14" height="14"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
                    : '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="14" height="14"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                
                return `
                    <div class="autocomplete-item ${index === selectedIndex ? 'active' : ''}" data-index="${index}">
                        <div class="company-title">${company.title}</div>
                        <div class="company-details">
                            <span class="company-number">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="14" height="14">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                                </svg>
                                ${company.company_number}
                            </span>
                            <span class="company-status ${statusClass}">
                                ${statusIcon}
                                ${company.company_status.charAt(0).toUpperCase() + company.company_status.slice(1)}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add click handlers
            const items = autocompleteDropdown.querySelectorAll('.autocomplete-item');
            items.forEach((item, index) => {
                item.addEventListener('click', () => selectCompany(index));
            });
        }
        
        // Select a company from autocomplete
        function selectCompany(index) {
            const company = suggestions[index];
            if (company) {
                companyInput.value = company.title;
                // Store the company number for exact search
                companyInput.dataset.companyNumber = company.company_number;
                hideAutocomplete();
                // Trigger search
                document.getElementById('searchForm').dispatchEvent(new Event('submit'));
            }
        }
        
        // Hide autocomplete dropdown
        function hideAutocomplete() {
            autocompleteDropdown.classList.remove('show');
            autocompleteDropdown.innerHTML = '';
            selectedIndex = -1;
            suggestions = [];
        }
        
        // Debounced search function
        const debouncedSearch = debounce(searchCompanies, 300);
        
        // Input event listener
        companyInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            if (query.length >= 2) {
                debouncedSearch(query);
            } else {
                hideAutocomplete();
            }
        });
        
        // Keyboard navigation
        companyInput.addEventListener('keydown', (e) => {
            if (!autocompleteDropdown.classList.contains('show')) return;
            
            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, suggestions.length - 1);
                    renderSuggestions();
                    break;
                    
                case 'ArrowUp':
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    renderSuggestions();
                    break;
                    
                case 'Enter':
                    if (selectedIndex >= 0) {
                        e.preventDefault();
                        selectCompany(selectedIndex);
                    }
                    break;
                    
                case 'Escape':
                    hideAutocomplete();
                    break;
            }
        });
        
        // Hide autocomplete on click outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.autocomplete-wrapper')) {
                hideAutocomplete();
            }
        });
        
        } // End of autocomplete setup check
        
        // Initialize Supabase
        const SUPABASE_URL = 'https://iotwhyiisbazeqmowljv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlvdHdoeWlpc2JhemVxbW93bGp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgzMDUwMzUsImV4cCI6MjA2Mzg4MTAzNX0.HYAZLeIjR9b9C9k0p3wgf73GvpVH4-Ag9wQbACLcsLc';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                persistSession: true,
                storageKey: 'docspace-auth',
                storage: window.localStorage,
                detectSessionInUrl: true,
                autoRefreshToken: true
            }
        });
        
        // Auth state management
        let currentUser = null;
        
        // Search history functions (inline since we can't import modules)
        window.searchHistory = {
            async addSearch(companyData, fileCount = null) {
                console.log('addSearch called with:', companyData, 'fileCount:', fileCount);
                
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) {
                    console.log('No user found in addSearch');
                    return null;
                }
                
                console.log('User found:', user.id, user.email);
                
                const recordData = {
                    user_id: user.id,
                    company_number: companyData.company_number,
                    company_name: companyData.company_name || companyData.title,
                    company_status: companyData.company_status,
                    company_type: companyData.company_type,
                    date_of_creation: companyData.date_of_creation,
                    address: companyData.registered_office_address ? 
                        `${companyData.registered_office_address.address_line_1 || ''}, ${companyData.registered_office_address.locality || ''}, ${companyData.registered_office_address.postal_code || ''}`.replace(/^,\s*|,\s*$/g, '') : 
                        null,
                    searched_at: new Date().toISOString()
                    // Note: file_count column doesn't exist in database yet
                };
                
                console.log('Attempting to upsert:', recordData);
                
                const { data, error } = await supabaseClient
                    .from('search_history')
                    .upsert(recordData)
                    .select();
                
                if (error) {
                    console.error('Error adding to search history:', error);
                    console.error('Error details:', error.message, error.details, error.hint);
                } else {
                    console.log('Successfully added to search history:', data);
                }
                
                return data;
            },

            async getHistory() {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return [];

                const { data, error } = await supabaseClient
                    .from('search_history')
                    .select('*')
                    .order('searched_at', { ascending: false })
                    .limit(20);

                if (error) {
                    console.error('Error getting search history:', error);
                    return [];
                }
                return data || [];
            },

            async checkDownloadStatus(companyNumber) {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return null;

                const { data, error } = await supabaseClient
                    .from('search_history')
                    .select('download_status, downloaded_at, company_name, download_count')
                    .eq('user_id', user.id)
                    .eq('company_number', companyNumber)
                    .maybeSingle();

                if (error && error.code !== 'PGRST116') console.error('Error checking download status:', error);
                return error ? null : data;
            }
        };
        
        // Listen for auth state changes
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            console.log('Auth state changed:', event, session);
            currentUser = session?.user || null;
            updateAuthUI();
            
            // Special handling for sign in
            if (event === 'SIGNED_IN' && session) {
                console.log('User signed in successfully:', session.user.email);
                currentUser = session.user;
                updateAuthUI();
            }
        });
        
        // Force update auth UI immediately
        setTimeout(async () => {
            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                console.log('Force session check:', { session, error });
                
                if (session) {
                    console.log('Force updating UI for logged in user:', session.user.email);
                    currentUser = session.user;
                    updateAuthUI();
                } else {
                    console.log('No session found in force update, trying refresh...');
                    // Try to refresh the session
                    const { data: refreshData, error: refreshError } = await supabaseClient.auth.refreshSession();
                    console.log('Refresh attempt:', { refreshData, refreshError });
                    
                    if (refreshData?.session) {
                        console.log('Session found after refresh:', refreshData.session.user.email);
                        currentUser = refreshData.session.user;
                        updateAuthUI();
                    } else {
                        console.log('No session after refresh either');
                    }
                }
            } catch (err) {
                console.error('Error in force update:', err);
            }
        }, 500);
        
        // Check auth state
        async function checkAuthState() {
            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                console.log('Auth check - Session:', session);
                console.log('Auth check - User:', session?.user);
                if (error) {
                    console.error('Auth error:', error);
                }
                currentUser = session?.user || null;
                updateAuthUI();
            } catch (err) {
                console.error('Failed to check auth:', err);
            }
        }
        
        // Update UI based on auth state
        function updateAuthUI() {
            console.log('Updating auth UI, currentUser:', currentUser);
            const userBtn = document.getElementById('userBtn');
            const guestBtn = document.getElementById('guestBtn');
            const marketingSection = document.getElementById('marketingSection');
            
            if (currentUser) {
                console.log('User is logged in:', currentUser.email);
                // Show user button, hide guest button
                if (userBtn) userBtn.style.display = 'flex';
                if (guestBtn) guestBtn.style.display = 'none';
                
                // Hide marketing section for logged-in users
                if (marketingSection) {
                    marketingSection.style.display = 'none';
                }
            } else {
                console.log('User is not logged in');
                // Show guest button, hide user button
                if (guestBtn) guestBtn.style.display = 'flex';
                if (userBtn) userBtn.style.display = 'none';
                
                // Show marketing section for guests
                if (marketingSection) {
                    marketingSection.style.display = 'block';
                }
            }
            
        }
        
        // Show user dropdown menu
        function showUserMenu() {
            const dropdown = document.getElementById('profileDropdown');
            // Update dropdown content for logged-in users
            dropdown.innerHTML = `
                <button class="dropdown-item" onclick="showMonitoredCompanies()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                    </svg>
                    Companies I Follow
                </button>
                <button class="dropdown-item" onclick="showSearchHistory()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Search History
                </button>
                <button class="dropdown-item logout" onclick="signOut()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Log Out
                </button>
            `;
            dropdown.classList.toggle('show');
        }
        
        // Show guest dropdown menu
        function showGuestMenu() {
            const dropdown = document.getElementById('profileDropdown');
            // Update dropdown content for guests
            dropdown.innerHTML = `
                <button class="dropdown-item" onclick="window.location.href='auth.html'">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                    </svg>
                    Create Account
                </button>
                <button class="dropdown-item" onclick="window.location.href='auth.html?mode=signin'">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Sign In
                </button>
            `;
            dropdown.classList.toggle('show');
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            const userDropdown = document.getElementById('userDropdown');
            const guestDropdown = document.getElementById('guestDropdown');
            const userBtn = document.getElementById('userBtn');
            const guestBtn = document.getElementById('guestBtn');
            
            if (userDropdown && userBtn && !userBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                userDropdown.classList.remove('show');
            }
            
            if (guestDropdown && guestBtn && !guestBtn.contains(e.target) && !guestDropdown.contains(e.target)) {
                guestDropdown.classList.remove('show');
            }
        });
        
        // Dropdown menu functions
        function showMonitoredCompanies() {
            alert('Companies I Follow - Coming soon!');
            // TODO: Show modal with monitored companies list
        }
        
        function showSearchHistory() {
            // Navigate to dedicated search history page
            window.location.href = '/search-history.html';
        }
        
        // Sign out function
        async function signOut() {
            try {
                await supabaseClient.auth.signOut();
                currentUser = null;
                
                // Close all dropdown menus
                document.getElementById('userDropdown').classList.remove('show');
                document.getElementById('guestDropdown').classList.remove('show');
                
                updateAuthUI();
                showStatus('info', 'Signed out successfully');
            } catch (error) {
                console.error('Sign out error:', error);
                showStatus('error', 'Failed to sign out');
            }
        }
        
        // Debug function - type debugAuth() in console
        window.debugAuth = async function() {
            console.log('=== AUTH DEBUG ===');
            console.log('LocalStorage keys:', Object.keys(localStorage));
            console.log('docspace-auth:', localStorage.getItem('docspace-auth'));
            
            // Try to get session directly
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            console.log('Direct session check:', session);
            console.log('Session error:', error);
            
            // Try to get user
            const { data: { user } } = await supabaseClient.auth.getUser();
            console.log('Current user:', user);
            
            console.log('=================');
        };
        
        // Sign out button handler (keeping this one for the separate sign out button if needed)
        const signOutBtn = document.getElementById('signOutBtn');
        if (signOutBtn) {
            signOutBtn.addEventListener('click', async () => {
                signOut();
            });
        }
        
        // Listen for auth state changes
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            console.log('Auth state changed:', event, session);
            currentUser = session?.user || null;
            updateAuthUI();
            
            // Special handling for sign in
            if (event === 'SIGNED_IN' && session) {
                console.log('User signed in successfully:', session.user.email);
                currentUser = session.user;
                updateAuthUI();
            }
        });
        
        // Set up auth button immediately
        document.addEventListener('DOMContentLoaded', () => {
            const authBtn = document.getElementById('authBtn');
            if (authBtn) {
                authBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Check auth state at click time
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    console.log('Click time auth check:', session);
                    
                    if (session?.user) {
                        console.log('Showing user menu for:', session.user.email);
                        showUserMenu();
                    } else {
                        console.log('Showing guest menu');
                        showGuestMenu();
                    }
                });
            }
        });
        
        // Check for payment status on page load
        window.addEventListener('DOMContentLoaded', async () => {
            // Wait a bit for Supabase to initialize
            await new Promise(resolve => setTimeout(resolve, 100));
            // First check if we're coming back from auth redirect
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const urlParams = new URLSearchParams(window.location.search);
            const accessToken = hashParams.get('access_token') || urlParams.get('access_token');
            
            if (accessToken) {
                console.log('Found access token in URL, setting session...');
                
                // Try to manually handle the auth callback
                try {
                    // First let Supabase try to handle it automatically
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Check if session was created
                    const { data: { session: autoSession } } = await supabaseClient.auth.getSession();
                    
                    if (!autoSession) {
                        console.log('Auto session detection failed, trying manual exchange...');
                        // If no session, try to exchange the hash for a session
                        const refreshToken = hashParams.get('refresh_token') || urlParams.get('refresh_token');
                        const { data, error } = await supabaseClient.auth.setSession({
                            access_token: accessToken,
                            refresh_token: refreshToken
                        });
                        
                        if (error) {
                            console.error('Error setting session:', error);
                        } else if (data?.session) {
                            console.log('Session set manually:', data.session);
                            currentUser = data.session.user;
                            updateAuthUI();
                        }
                    } else {
                        console.log('Session detected automatically:', autoSession);
                        currentUser = autoSession.user;
                        updateAuthUI();
                    }
                } catch (error) {
                    console.error('Error handling auth callback:', error);
                }
                
                // Clean up the URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            // Check auth state after DOM is loaded
            await checkAuthState();
            
            // Force refresh session to ensure we have latest state
            const { data: refreshData, error: refreshError } = await supabaseClient.auth.refreshSession();
            if (refreshData?.session) {
                console.log('Session refreshed:', refreshData.session);
                currentUser = refreshData.session.user;
                updateAuthUI();
            }
            
            // Also try to recover session from storage
            const { data: sessionData } = await supabaseClient.auth.getSession();
            if (sessionData?.session) {
                console.log('Recovered session from storage:', sessionData.session);
                currentUser = sessionData.session.user;
                updateAuthUI();
            }
            
            // Check for search data from search history page
            const searchData = sessionStorage.getItem('searchData');
            if (searchData) {
                try {
                    const { companyNumber, companyName, autoDownload, paymentCompleted: paidAlready } = JSON.parse(searchData);
                    sessionStorage.removeItem('searchData'); // Clear it
                    
                    // If payment was already completed, set the flag
                    if (paidAlready) {
                        paymentCompleted = true;
                        console.log('Payment already completed, skipping payment step');
                    }
                    
                    // Fill in the search form
                    const companyInput = document.getElementById('companyName');
                    companyInput.value = companyName;
                    companyInput.dataset.companyNumber = companyNumber;
                    
                    // Trigger form submission
                    setTimeout(() => {
                        document.getElementById('searchForm').dispatchEvent(new Event('submit'));
                        
                        // If auto-download is requested, trigger download after search completes
                        if (autoDownload) {
                            setTimeout(() => {
                                const downloadBtn = document.getElementById('downloadZipBtn');
                                if (downloadBtn && !downloadBtn.disabled) {
                                    downloadBtn.click();
                                }
                            }, 3000);
                        }
                    }, 1000);
                } catch (error) {
                    console.error('Error processing search data:', error);
                }
            }
            
            // Check payment status using already declared urlParams
            const paymentStatus = urlParams.get('payment');
            
            if (paymentStatus === 'success') {
                const storedData = localStorage.getItem('pendingCompany');
                
                if (storedData) {
                    try {
                        const parsed = JSON.parse(storedData);
                        
                        // Check if this is from history page
                        if (parsed.fromHistory) {
                            // Mark payment as completed
                            paymentCompleted = true;
                            
                            // Redirect to search with the company details
                            sessionStorage.setItem('searchData', JSON.stringify({
                                companyNumber: parsed.companyNumber,
                                companyName: parsed.companyName,
                                autoDownload: true,
                                paymentCompleted: true  // Add this flag
                            }));
                            localStorage.removeItem('pendingCompany');
                            window.location.href = window.location.origin;
                            return;
                        }
                        
                        const { companyData: stored, allDocuments: docs, timestamp } = parsed;
                        
                        if (Date.now() - timestamp < 30 * 60 * 1000) {
                            companyData = stored;
                            allDocuments = docs;
                            paymentCompleted = true;
                            
                            console.log('Restoring after payment:', companyData, docs);
                            
                            // Ensure we have the right data
                            if (!companyData.title && companyData.company_name) {
                                companyData.title = companyData.company_name;
                            }
                            
                            displayCompanyInfo(companyData);
                            document.getElementById('totalDocs').textContent = docs.length;
                            // Company age should already be set from stored data
                            if (companyData.date_of_creation) {
                                const incorporationDate = new Date(companyData.date_of_creation);
                                const currentDate = new Date();
                                const ageInYears = Math.floor((currentDate - incorporationDate) / (365.25 * 24 * 60 * 60 * 1000));
                                document.getElementById('companyAge').textContent = ageInYears;
                            }
                            document.getElementById('resultsContainer').style.display = 'block';
                            
                            showStatus('success', 'Payment successful! Starting download...');
                            localStorage.removeItem('pendingCompany');
                            
                            console.log('Starting download in 1.5 seconds...');
                            setTimeout(async () => {
                                console.log('Starting download now...');
                                try {
                                    await startDownload();
                                } catch (error) {
                                    console.error('Download error:', error);
                                    showStatus('error', 'Download failed: ' + error.message);
                                }
                            }, 1500);
                        } else {
                            localStorage.removeItem('pendingCompany');
                            showStatus('error', 'Payment session expired. Please search again.');
                        }
                    } catch (error) {
                        showStatus('error', 'Error restoring session. Please search again.');
                    }
                } else {
                    showStatus('info', 'Payment successful! Please search for the company again to download.');
                }
                
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (paymentStatus === 'cancelled') {
                showStatus('info', 'Payment cancelled. Search for a company to try again.');
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });
        
        // Explore tab functions
        // Initialize with existing data first
        let oldestCompanies = [
            { name: "THE RYE CATTLE MARKET COMPANY LIMITED", number: "00001452", year: "1859", location: "Rye, East Sussex", status: "Active", industry: "AGRICULTURE", totalCharges: 0, outstandingCharges: 0, satisfiedCharges: 0, incorporationDate: "1859-01-01", companyType: "Private Limited Company", sicCodes: [] },
            { name: "THE ABERDEEN-ANGUS CATTLE SOCIETY", number: "SC000926", year: "1879", location: "Perth, Scotland", status: "Active", industry: "AGRICULTURE", totalCharges: 2, outstandingCharges: 1, satisfiedCharges: 1, incorporationDate: "1879-01-01", companyType: "Private Limited Company", sicCodes: [] },
            { name: "BLACK SEA AND BALTIC INSURANCE CO", number: "00204185", year: "1925", location: "London", status: "Active", industry: "FINANCIAL", totalCharges: 5, outstandingCharges: 2, satisfiedCharges: 3, incorporationDate: "1925-01-01", companyType: "Private Limited Company", sicCodes: [] },
            { name: "BRITISH WIDOWS FUND AND LIFE", number: "00000124", year: "1815", location: "Edinburgh", status: "Active", industry: "FINANCIAL", totalCharges: 0, outstandingCharges: 0, satisfiedCharges: 0, incorporationDate: "1815-01-01", companyType: "Private Limited Company", sicCodes: [] },
            { name: "LONDON ASSURANCE CORPORATION", number: "00000098", year: "1862", location: "London", status: "Active", industry: "FINANCIAL", totalCharges: 1, outstandingCharges: 0, satisfiedCharges: 1, incorporationDate: "1862-01-01", companyType: "Private Limited Company", sicCodes: [] }
        ];
        
        let newestCompanies = [
            { name: "TECH SOLUTIONS LIMITED", number: "15234567", year: "2024", location: "London", status: "Active", industry: "TECHNOLOGY", totalCharges: 0, outstandingCharges: 0, satisfiedCharges: 0, incorporationDate: "2024-01-01", companyType: "Private Limited Company", sicCodes: [] },
            { name: "RENEWABLE ENERGY UK LTD", number: "15234568", year: "2024", location: "Manchester", status: "Active", industry: "ENERGY", totalCharges: 3, outstandingCharges: 2, satisfiedCharges: 1, incorporationDate: "2024-01-01", companyType: "Private Limited Company", sicCodes: [] },
            { name: "DIGITAL SERVICES LIMITED", number: "15234569", year: "2024", location: "Cambridge", status: "Active", industry: "TECHNOLOGY", totalCharges: 0, outstandingCharges: 0, satisfiedCharges: 0, incorporationDate: "2024-01-01", companyType: "Private Limited Company", sicCodes: [] },
            { name: "MODERN FOODS COMPANY", number: "15234570", year: "2024", location: "Bristol", status: "Active", industry: "AGRICULTURE", totalCharges: 1, outstandingCharges: 1, satisfiedCharges: 0, incorporationDate: "2024-01-01", companyType: "Private Limited Company", sicCodes: [] },
            { name: "FINANCIAL TECH LTD", number: "15234571", year: "2024", location: "Edinburgh", status: "Active", industry: "FINANCIAL", totalCharges: 2, outstandingCharges: 0, satisfiedCharges: 2, incorporationDate: "2024-01-01", companyType: "Private Limited Company", sicCodes: [] }
        ];

        // Function to guess industry from SIC code
        function guessIndustryFromSIC(sicText) {
            if (!sicText) return 'OTHER';
            const sic = sicText.toUpperCase();
            
            // Agriculture & Food (01-03, 10-11)
            if (sic.startsWith('01') || sic.startsWith('02') || sic.startsWith('03') || 
                sic.startsWith('10') || sic.startsWith('11') || sic.includes('AGRICULTURE') || 
                sic.includes('FARM') || sic.includes('FOOD') || sic.includes('CATTLE')) {
                return 'AGRICULTURE';
            }
            
            // Financial (64-66)
            if (sic.startsWith('64') || sic.startsWith('65') || sic.startsWith('66') || 
                sic.includes('FINANC') || sic.includes('INSURANCE') || sic.includes('BANK')) {
                return 'FINANCIAL';
            }
            
            // Technology (62-63)
            if (sic.startsWith('62') || sic.startsWith('63') || sic.includes('SOFTWARE') || 
                sic.includes('COMPUTER') || sic.includes('INFORMATION')) {
                return 'TECHNOLOGY';
            }
            
            // Retail (45-47)
            if (sic.startsWith('45') || sic.startsWith('46') || sic.startsWith('47') || 
                sic.includes('RETAIL') || sic.includes('WHOLESALE') || sic.includes('SALE')) {
                return 'RETAIL';
            }
            
            // Manufacturing (10-33)
            if ((sic.match(/^\d{2}/) && parseInt(sic.substring(0, 2)) >= 10 && parseInt(sic.substring(0, 2)) <= 33) ||
                sic.includes('MANUFACTUR')) {
                return 'MANUFACTURING';
            }
            
            // Real Estate (68)
            if (sic.startsWith('68') || sic.includes('REAL ESTATE') || sic.includes('PROPERTY')) {
                return 'REAL_ESTATE';
            }
            
            // Energy (05-09, 35)
            if (sic.startsWith('05') || sic.startsWith('06') || sic.startsWith('07') || 
                sic.startsWith('08') || sic.startsWith('09') || sic.startsWith('35') || 
                sic.includes('ENERGY') || sic.includes('ELECTRIC') || sic.includes('GAS') || 
                sic.includes('MINING')) {
                return 'ENERGY';
            }
            
            // Healthcare (86-88)
            if (sic.startsWith('86') || sic.startsWith('87') || sic.startsWith('88') || 
                sic.includes('HEALTH') || sic.includes('MEDICAL') || sic.includes('HOSPITAL')) {
                return 'HEALTHCARE';
            }
            
            // Transportation (49-53)
            if (sic.startsWith('49') || sic.startsWith('50') || sic.startsWith('51') || 
                sic.startsWith('52') || sic.startsWith('53') || sic.includes('TRANSPORT')) {
                return 'TRANSPORT';
            }
            
            // Construction (41-43)
            if (sic.startsWith('41') || sic.startsWith('42') || sic.startsWith('43') || 
                sic.includes('CONSTRUCTION') || sic.includes('BUILDING')) {
                return 'CONSTRUCTION';
            }
            
            // Professional Services (69-75)
            if (sic.startsWith('69') || sic.startsWith('70') || sic.startsWith('71') || 
                sic.startsWith('72') || sic.startsWith('73') || sic.startsWith('74') || 
                sic.startsWith('75') || sic.includes('CONSULTING') || sic.includes('LEGAL')) {
                return 'SERVICES';
            }
            
            // Media & Entertainment (58-60, 90-93)
            if (sic.startsWith('58') || sic.startsWith('59') || sic.startsWith('60') || 
                sic.startsWith('90') || sic.startsWith('91') || sic.startsWith('92') || 
                sic.startsWith('93') || sic.includes('MEDIA') || sic.includes('BROADCAST') || 
                sic.includes('PUBLISHING') || sic.includes('ENTERTAINMENT')) {
                return 'MEDIA';
            }
            
            return 'OTHER';
        }
        
        // Function to guess industry from company name
        function guessIndustry(companyName) {
            const name = companyName.toUpperCase();
            
            // Agriculture & Food
            if (name.includes('CATTLE') || name.includes('FARM') || name.includes('AGRICULTURE') || 
                name.includes('FOOD') || name.includes('DAIRY') || name.includes('MEAT')) {
                return 'AGRICULTURE';
            }
            
            // Financial
            if (name.includes('INSURANCE') || name.includes('BANK') || name.includes('FINANCE') || 
                name.includes('INVESTMENT') || name.includes('FUND') || name.includes('CAPITAL') ||
                name.includes('HOLDINGS') || name.includes('ASSURANCE')) {
                return 'FINANCIAL';
            }
            
            // Technology
            if (name.includes('TECH') || name.includes('SOFTWARE') || name.includes('DIGITAL') || 
                name.includes('COMPUTER') || name.includes('IT ') || name.includes('DATA')) {
                return 'TECHNOLOGY';
            }
            
            // Property & Real Estate
            if (name.includes('PROPERTIES') || name.includes('PROPERTY') || name.includes('ESTATE') || 
                name.includes('LAND') || name.includes('DEVELOPMENT')) {
                return 'REAL_ESTATE';
            }
            
            // Construction
            if (name.includes('CONSTRUCTION') || name.includes('BUILDING') || name.includes('BUILDER')) {
                return 'CONSTRUCTION';
            }
            
            // Transport & Shipping
            if (name.includes('TRANSPORT') || name.includes('SHIPPING') || name.includes('NAVIGATION') || 
                name.includes('RAILWAY') || name.includes('LOGISTICS')) {
                return 'TRANSPORT';
            }
            
            // Energy & Utilities
            if (name.includes('GAS') || name.includes('ELECTRIC') || name.includes('ENERGY') || 
                name.includes('POWER') || name.includes('OIL') || name.includes('PETROLEUM')) {
                return 'ENERGY';
            }
            
            // Retail & Shops
            if (name.includes('RETAIL') || name.includes('SHOP') || name.includes('STORE') || 
                name.includes('TRADING') || name.includes('SALES')) {
                return 'RETAIL';
            }
            
            // Manufacturing
            if (name.includes('MANUFACTUR') || name.includes('FACTORY') || name.includes('PRODUCTION') || 
                name.includes('ENGINEERING')) {
                return 'MANUFACTURING';
            }
            
            // Healthcare
            if (name.includes('HEALTH') || name.includes('MEDICAL') || name.includes('CLINIC') || 
                name.includes('HOSPITAL') || name.includes('PHARMA') || name.includes('CARE')) {
                return 'HEALTHCARE';
            }
            
            // Professional Services
            if (name.includes('CONSULTING') || name.includes('SERVICES') || name.includes('SOLUTIONS') || 
                name.includes('LEGAL') || name.includes('ACCOUNTAN') || name.includes('MANAGEMENT')) {
                return 'SERVICES';
            }
            
            // Media & Publishing
            if (name.includes('NEWSPAPER') || name.includes('MEDIA') || name.includes('PUBLISHING') || 
                name.includes('BROADCAST') || name.includes('PRESS')) {
                return 'MEDIA';
            }
            
            return 'OTHER';
        }

        // API Base URL - always use Railway for the 5.6M companies database
        const API_BASE_URL = 'https://companies-api-production-68c2.up.railway.app';

        // Fetch real data from Railway and replace the mock data
        function loadRealCompanies() {
            console.log(`Loading real companies from Railway (${currentView})...`);
            
            const industryFilter = document.getElementById('industryFilter') ? document.getElementById('industryFilter').value : 'ALL';
            const industryParam = industryFilter !== 'ALL' ? `?industry=${industryFilter}` : '';
            
            const endpoint = currentView === 'oldest' 
                ? `${API_BASE_URL}/api/oldest${industryParam}`
                : `${API_BASE_URL}/api/newest${industryParam}`;
            
            console.log('Fetching from:', endpoint);
            
            fetch(endpoint)
                .then(r => {
                    console.log('Response status:', r.status);
                    if (!r.ok) throw new Error(`HTTP ${r.status}`);
                    return r.json();
                })
                .then(data => {
                    console.log(`${currentView} companies data:`, data);
                    if (data && Array.isArray(data) && data.length > 0) {
                        const companies = data.map(company => {
                            // Extract year from IncorporationDate
                            let year = 'Unknown';
                            if (company.IncorporationDate) {
                                const date = new Date(company.IncorporationDate);
                                year = date.getFullYear().toString();
                            }
                            
                            // Get location from address fields
                            let location = company.RegAddress_PostTown || 
                                          company.RegAddress_County || 
                                          company.RegAddress_Country || 
                                          'United Kingdom';
                            
                            // Determine industry from SIC codes or company name
                            let industry = 'OTHER';
                            if (company.SICCode_SicText_1) {
                                industry = guessIndustryFromSIC(company.SICCode_SicText_1);
                            } else {
                                industry = guessIndustry(company.CompanyName);
                            }
                            
                            return {
                                name: company.CompanyName,
                                number: company.CompanyNumber,
                                year: year,
                                location: location,
                                status: company.CompanyStatus,
                                industry: industry,
                                // Charges data - convert strings to numbers
                                totalCharges: parseInt(company.Mortgages_NumMortCharges) || 0,
                                outstandingCharges: parseInt(company.Mortgages_NumMortOutstanding) || 0,
                                satisfiedCharges: parseInt(company.Mortgages_NumMortSatisfied) || 0,
                                partSatisfiedCharges: parseInt(company.Mortgages_NumMortPartSatisfied) || 0,
                                // Additional data for expanded view
                                incorporationDate: company.IncorporationDate,
                                companyType: company.CompanyCategory,
                                sicCodes: [
                                    company.SICCode_SicText_1,
                                    company.SICCode_SicText_2,
                                    company.SICCode_SicText_3,
                                    company.SICCode_SicText_4
                                ].filter(Boolean),
                                address: {
                                    line1: company.RegAddress_AddressLine1,
                                    line2: company.RegAddress_AddressLine2,
                                    postTown: company.RegAddress_PostTown,
                                    county: company.RegAddress_County,
                                    postCode: company.RegAddress_PostCode,
                                    country: company.RegAddress_Country
                                },
                                // Railway date fields for accounts and confirmation statements
                                railwayAccountsNextDue: company.Accounts_NextDueDate,
                                railwayConfStmtNextDue: company.ConfStmtNextDueDate
                            };
                        });
                        
                        // Assign to the correct array based on current view
                        if (currentView === 'oldest') {
                            oldestCompanies = companies;
                            window.oldestCompanies = companies;
                            console.log('üî∏ Updated oldestCompanies:', companies.length, 'companies');
                            console.log('üî∏ RC companies in oldest:', companies.filter(c => c.number?.startsWith('RC')).map(c => c.number));
                            console.log('üî∏ window.oldestCompanies now has:', window.oldestCompanies?.length || 0, 'companies');
                        } else {
                            newestCompanies = companies;
                            window.newestCompanies = companies;
                            console.log('üî∏ Updated newestCompanies:', companies.length, 'companies');
                            console.log('üî∏ RC companies in newest:', companies.filter(c => c.number?.startsWith('RC')).map(c => c.number));
                            console.log('üî∏ window.newestCompanies now has:', window.newestCompanies?.length || 0, 'companies');
                        }
                        
                        if (document.getElementById('exploreTab').classList.contains('active')) {
                            renderCompanies();
                        }
                    } else {
                        console.warn(`No data received from ${endpoint}`);
                        // Initialize with empty array if no data
                        if (currentView === 'oldest') {
                            oldestCompanies = [];
                            window.oldestCompanies = [];
                        } else {
                            newestCompanies = [];
                            window.newestCompanies = [];
                        }
                        renderCompanies();
                    }
                })
                .catch(err => {
                    console.error(`Error loading ${currentView} companies from Railway:`, err);
                    console.error('Railway database connection appears to be closed');
                    
                    // Show error message to user about database connectivity
                    const list = document.getElementById('companyListExplore');
                    if (list && document.getElementById('exploreTab').classList.contains('active')) {
                        list.innerHTML = `
                            <div style="text-align: center; color: #ef4444; padding: 40px; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; background: rgba(239, 68, 68, 0.05);">
                                <h3 style="margin-bottom: 16px;">Database Connection Issue</h3>
                                <p style="margin-bottom: 16px;">The Railway database connection is currently closed. This affects access to the full 5.6M company database.</p>
                                <p style="color: #94a3b8; font-size: 14px;">Railway Error: ${err.message}</p>
                                <button onclick="loadRealCompanies()" style="margin-top: 16px; padding: 8px 16px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    Retry Connection
                                </button>
                            </div>
                        `;
                    }
                });
        }

        // Function to aggressively retry Railway connection
        let connectionRetryCount = 0;
        const maxRetries = 50; // Increased retries
        
        function checkRailwayConnection() {
            if (connectionRetryCount >= maxRetries) {
                console.log('Max retries reached for Railway connection');
                const list = document.getElementById('companyListExplore');
                if (list && document.getElementById('exploreTab').classList.contains('active')) {
                    list.innerHTML = `
                        <div style="text-align: center; color: #ef4444; padding: 40px; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; background: rgba(239, 68, 68, 0.05);">
                            <h3 style="margin-bottom: 16px;">‚ö†Ô∏è Database Connection Lost</h3>
                            <p style="margin-bottom: 16px;">Cannot connect to the 5.6M company database on Railway.</p>
                            <p style="color: #94a3b8; font-size: 14px; margin-bottom: 16px;">The Railway backend service needs to restart its database connection.</p>
                            <button onclick="connectionRetryCount = 0; checkRailwayConnection();" style="margin-top: 16px; padding: 8px 16px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                Retry Connection
                            </button>
                        </div>
                    `;
                }
                return;
            }
            
            // Show connection attempt to user
            const list = document.getElementById('companyListExplore');
            if (list && document.getElementById('exploreTab').classList.contains('active') && connectionRetryCount > 0) {
                list.innerHTML = `
                    <div style="text-align: center; color: #6366f1; padding: 40px;">
                        <div class="spinner" style="margin-bottom: 16px;"></div>
                        <h3 style="margin-bottom: 8px;">Connecting to Railway Database...</h3>
                        <p style="color: #94a3b8; font-size: 14px;">Attempt ${connectionRetryCount + 1} of ${maxRetries}</p>
                        <p style="color: #94a3b8; font-size: 12px;">Trying to access 5.6M company database</p>
                    </div>
                `;
            }
            
            // First try to hit the API endpoints directly to wake up the database
            const endpointsToTry = ['/api/oldest', '/api/newest'];
            const endpoint = endpointsToTry[connectionRetryCount % endpointsToTry.length];
            
            fetch(`${API_BASE_URL}${endpoint}`)
                .then(r => r.json())
                .then(data => {
                    if (data && Array.isArray(data) && data.length > 0) {
                        // Don't reload if there's an active search
                        if (!exploreSearchQuery || exploreSearchQuery.length === 0) {
                            console.log('‚úÖ Railway database connection restored!');
                            connectionRetryCount = 0; // Reset counter
                            loadRealCompanies(); // Load the data
                        } else {
                            console.log('‚úÖ Railway connection OK, but search is active - not reloading');
                            connectionRetryCount = 0; // Reset counter
                        }
                        return;
                    }
                    throw new Error('Database still not connected');
                })
                .catch(err => {
                    console.log(`Railway attempt ${connectionRetryCount + 1}: ${err.message}`);
                    connectionRetryCount++;
                    if (connectionRetryCount < maxRetries) {
                        setTimeout(checkRailwayConnection, 2000); // Retry every 2 seconds
                    }
                });
        }

        // Manual function to force Railway reconnection
        window.forceRailwayReconnect = function() {
            console.log('üîÑ Forcing Railway database reconnection...');
            connectionRetryCount = 0;
            checkRailwayConnection();
        };

        // Load real data when page loads
        setTimeout(() => {
            console.log('Initial load - checking filters...');
            const industryFilter = document.getElementById('industryFilter');
            const activeSwitch = document.getElementById('activeSwitch');
            const chargesSwitch = document.getElementById('chargesSwitch');
            console.log('Filters found:', {
                industryFilter: !!industryFilter,
                activeSwitch: !!activeSwitch,
                chargesSwitch: !!chargesSwitch,
                industryValue: industryFilter ? industryFilter.value : 'none'
            });
            
            // Initial render with default data (FINANCIAL filter is selected by default)
            if (document.getElementById('exploreTab').classList.contains('active')) {
                renderCompanies();
            }
            
            // Then try to load real data from Railway
            loadRealCompanies();
            
            // Start aggressive connection monitoring
            checkRailwayConnection();
            
            // Also set up periodic monitoring every 30 seconds
            setInterval(() => {
                if (connectionRetryCount === 0) { // Only if not already retrying
                    checkRailwayConnection();
                }
            }, 30000);
        }, 1000);

        
        let currentView = 'oldest';
        
        function onIndustryChange() {
            companiesOffset = 5; // Reset offset when industry changes
            loadRealCompanies(); // Reload data with new filter
        }
        
        function showOldest() {
            currentView = 'oldest';
            companiesOffset = 5; // Reset offset
            document.getElementById('oldestBtn').classList.add('active');
            document.getElementById('newestBtn').classList.remove('active');
            document.querySelector('.show-more-btn').style.display = 'block'; // Show button again
            
            // Check if there's an active search
            const searchInput = document.getElementById('exploreCompanyName');
            if (searchInput && searchInput.value.trim().length >= 2) {
                // Re-apply the search with new sorting
                filterExploreCompanies(searchInput.value.trim());
            } else {
                // Load normal companies
                loadRealCompanies(); // Load data with current industry filter
            }
        }
        
        function showNewest() {
            currentView = 'newest';
            companiesOffset = 5; // Reset offset
            document.getElementById('newestBtn').classList.add('active');
            document.getElementById('oldestBtn').classList.remove('active');
            document.querySelector('.show-more-btn').style.display = 'block'; // Show button again
            
            // Check if there's an active search
            const searchInput = document.getElementById('exploreCompanyName');
            if (searchInput && searchInput.value.trim().length >= 2) {
                // Re-apply the search with new sorting
                filterExploreCompanies(searchInput.value.trim());
            } else {
                // Load normal companies
                loadRealCompanies(); // Load data with current industry filter
            }
        }
        
        function toggleActive(element) {
            element.classList.toggle('active');
            renderCompanies();
        }
        
        function toggleCharges(element) {
            element.classList.toggle('active');
            renderCompanies();
        }
        
        function renderCompanies() {
            const list = document.getElementById('companyListExplore');
            if (!list) {
                console.warn('Company list element not found');
                return;
            }
            
            const activeSwitch = document.getElementById('activeSwitch');
            const chargesSwitch = document.getElementById('chargesSwitch');
            const industryFilter = document.getElementById('industryFilter');
            
            const activeOnly = activeSwitch ? activeSwitch.classList.contains('active') : false;
            const chargesOnly = chargesSwitch ? chargesSwitch.classList.contains('active') : false;
            const industryValue = industryFilter ? industryFilter.value : 'ALL';
            
            const companies = currentView === 'oldest' ? oldestCompanies : newestCompanies;
            
            console.log('Rendering companies:', {
                view: currentView,
                totalCompanies: companies.length,
                activeOnly,
                chargesOnly,
                industry: industryValue
            });
            
            // Apply filters
            let filtered = companies;
            
            // Filter by search query first (if any)
            if (exploreSearchQuery && exploreSearchQuery.length > 0) {
                filtered = filtered.filter(c => {
                    const companyName = (c.name || '').toLowerCase();
                    const companyNumber = (c.number || '').toLowerCase();
                    return companyName.includes(exploreSearchQuery) || companyNumber.includes(exploreSearchQuery);
                });
            }
            
            // Filter by industry (for default data when Railway is not available)
            if (industryValue !== 'ALL') {
                filtered = filtered.filter(c => c.industry === industryValue);
            }
            
            // Filter by active status
            if (activeOnly) {
                filtered = filtered.filter(c => c.status === 'Active');
            }
            
            // Filter by charges
            if (chargesOnly) {
                filtered = filtered.filter(c => c.totalCharges > 0);
            }
            
            list.innerHTML = filtered.map(company => {
                const incorporationDate = company.incorporationDate ? new Date(company.incorporationDate).toLocaleDateString('en-GB', { 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric' 
                }) : 'Not available';
                
                const companyAge = company.incorporationDate ? 
                    Math.floor((new Date() - new Date(company.incorporationDate)) / (365.25 * 24 * 60 * 60 * 1000)) : null;
                
                return `
                <div class="explore-company-card" onclick="toggleCardExpansion(this, '${company.number}')" data-company-number="${company.number}">
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: #ffffff; display: flex; align-items: center;">
                        <span class="status-indicator status-${company.status.toLowerCase()}" data-tooltip="${company.status}"></span>
                        ${company.name}
                        ${company.totalCharges > 0 ? `
                            <span class="charges-indicator" data-tooltip="${company.totalCharges} charge${company.totalCharges !== 1 ? 's' : ''} (${company.outstandingCharges} outstanding)">!</span>
                        ` : ''}
                    </div>
                    <div style="color: #94a3b8; font-size: 14px; display: flex; align-items: center;">
                        ${company.year} ‚Ä¢ ${company.location} ‚Ä¢ ${company.number}
                        <span class="industry-badge industry-${company.industry.toLowerCase().replace(/[\s_]/g, '_')}">${company.industry.replace(/_/g, ' ')}</span>
                    </div>
                    
                    <div class="card-expand-content">
                        <div class="expand-section">
                            <div class="expand-row">
                                <span class="expand-label">Incorporated:</span>
                                <span class="expand-value">${incorporationDate}${companyAge !== null ? ` (${companyAge} years ago)` : ''}</span>
                            </div>
                            
                            <div class="expand-row">
                                <span class="expand-label">Company Type:</span>
                                <span class="expand-value">${company.companyType || 'Private Limited Company'}</span>
                            </div>
                            
                            ${company.sicCodes && company.sicCodes.length > 0 ? `
                                <div class="expand-row">
                                    <span class="expand-label">SIC Codes:</span>
                                    <div class="expand-value">
                                        ${company.sicCodes.map(sic => `
                                            <div class="sic-code" data-tooltip="${sic}">${sic.split(' - ')[0]}</div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${company.totalCharges > 0 ? `
                                <div class="expand-row">
                                    <span class="expand-label">Charges:</span>
                                    <div class="expand-value">
                                        <div class="charges-breakdown">
                                            <div class="charge-line">
                                                <span class="charge-type">Total charges</span>
                                                <span class="charge-count">${company.totalCharges}</span>
                                            </div>
                                            ${company.outstandingCharges > 0 ? `
                                                <div class="charge-line">
                                                    <span class="charge-type">Outstanding</span>
                                                    <span class="charge-count outstanding">${company.outstandingCharges}</span>
                                                </div>
                                            ` : ''}
                                            ${company.satisfiedCharges > 0 ? `
                                                <div class="charge-line">
                                                    <span class="charge-type">Satisfied</span>
                                                    <span class="charge-count satisfied">${company.satisfiedCharges}</span>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1); text-align: center;">
                                <button class="signup-btn" onclick="event.stopPropagation(); viewCompanyDetails(this);" data-company='${JSON.stringify(company)}'>
                                    View Details
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
            
            // If no companies after filter, show message
            if (filtered.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 40px;">No companies found with current filters</div>';
            }
        }
        
        function selectExploreCompany(companyNumber) {
            document.getElementById('searchQuery').value = companyNumber;
            document.getElementById('tab-bulk').click();
            searchCompany();
        }
        
        let companiesOffset = 5; // Start at 5 since we already loaded first 5
        
        // Get current user helper
        async function getCurrentUser() {
            if (typeof supabaseClient === 'undefined') return null;
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                return user;
            } catch (error) {
                return null;
            }
        }
        
        async function loadMore() {
            const user = await getCurrentUser();
            
            if (!user) {
                // Redirect to auth page
                window.location.href = '/auth.html';
                return;
            }
            
            // For logged-in users, load more companies
            const industryFilter = document.getElementById('industryFilter') ? document.getElementById('industryFilter').value : 'ALL';
            const industryParam = industryFilter !== 'ALL' ? `?industry=${industryFilter}` : '';
            
            const endpoint = currentView === 'oldest' 
                ? `${API_BASE_URL}/api/oldest/${companiesOffset}${industryParam}`
                : `${API_BASE_URL}/api/newest/${companiesOffset}${industryParam}`;
                
            fetch(endpoint)
                .then(r => r.json())
                .then(data => {
                    if (data && Array.isArray(data) && data.length > 0) {
                        const companies = currentView === 'oldest' ? oldestCompanies : newestCompanies;
                        
                        data.forEach(company => {
                            // Extract year from IncorporationDate
                            let year = 'Unknown';
                            if (company.IncorporationDate) {
                                const date = new Date(company.IncorporationDate);
                                year = date.getFullYear().toString();
                            }
                            
                            // Get location from address fields
                            let location = company.RegAddress_PostTown || 
                                          company.RegAddress_County || 
                                          company.RegAddress_Country || 
                                          'United Kingdom';
                            
                            // Determine industry from SIC codes or company name
                            let industry = 'OTHER';
                            if (company.SICCode_SicText_1) {
                                industry = guessIndustryFromSIC(company.SICCode_SicText_1);
                            } else {
                                industry = guessIndustry(company.CompanyName);
                            }
                            
                            companies.push({
                                name: company.CompanyName,
                                number: company.CompanyNumber,
                                year: year,
                                location: location,
                                status: company.CompanyStatus,
                                industry: industry
                            });
                        });
                        
                        companiesOffset += 5;
                        renderCompanies();
                        
                        if (data.length < 5) {
                            // No more companies to load
                            document.querySelector('.show-more-btn').style.display = 'none';
                        }
                    }
                })
                .catch(err => console.error('Error loading more companies:', err));
        }
        
        // Update load more button text based on auth state
        async function updateLoadMoreButton() {
            const user = await getCurrentUser();
            const btn = document.getElementById('loadMoreBtn');
            if (btn) {
                btn.textContent = user ? 'Load More' : 'Create Account for More';
            }
        }
        
        // Initial render on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load initial data if arrays are empty OR if visiting a company URL directly
            const isCompanyURL = window.location.hash.startsWith('#company/');
            if (oldestCompanies.length === 0 || (isCompanyURL && window.oldestCompanies?.length === 0)) {
                console.log('üî∏ Loading initial Railway data... (company URL detected:', isCompanyURL, ')');
                loadRealCompanies();
            }
            
            // Check if explore tab is initially active and render companies with current filter
            if (document.getElementById('exploreTab') && document.getElementById('exploreTab').classList.contains('active')) {
                console.log('Explore tab is active on load, rendering with filter...');
                renderCompanies();
            }
            // Update button text
            updateLoadMoreButton();
            
            // Handle company hash routing on page load
            setTimeout(handleCompanyHash, 500); // Wait for companies to load
            
            // Also call immediately in case the company data is already available
            handleCompanyHash();
            
            // Additional hash check on window load
            window.addEventListener('load', function() {
                console.log('üî∏ Window load event, checking hash again:', window.location.hash);
                if (window.location.hash.startsWith('#company/')) {
                    handleCompanyHash();
                }
            });
        });
        
        // Also update button when auth state changes
        window.addEventListener('authStateChanged', updateLoadMoreButton);
        
        // Toggle card expansion function
        function toggleCardExpansion(card, companyNumber) {
            // Prevent event from bubbling up to search functionality
            event.stopPropagation();
            
            // Check if this card is already expanded
            const isExpanded = card.classList.contains('expanded');
            
            // Close all other expanded cards
            document.querySelectorAll('.explore-company-card.expanded').forEach(expandedCard => {
                if (expandedCard !== card) {
                    expandedCard.classList.remove('expanded');
                }
            });
            
            // Toggle the clicked card
            if (!isExpanded) {
                card.classList.add('expanded');
            } else {
                card.classList.remove('expanded');
            }
        }
        
        // Show signup modal function
        function showSignupModal() {
            // Navigate to auth page
            window.location.href = '/auth.html';
        }
        
        // View company details - available for ALL users (signed in and not signed in)
        function viewCompanyDetails(button) {
            console.log('üî∏ viewCompanyDetails called for all users');
            try {
                const companyData = JSON.parse(button.getAttribute('data-company'));
                console.log('üî∏ Company data:', companyData);
                showCompanyModal(companyData);
            } catch (error) {
                console.error('üî∏ Error parsing company data:', error);
                // Fallback with basic data
                const fallbackData = {
                    name: "Company Details",
                    number: "00000000",
                    status: "Active",
                    totalCharges: 0,
                    outstandingCharges: 0,
                    satisfiedCharges: 0,
                    incorporationDate: "2000-01-01",
                    companyType: "Private Limited Company"
                };
                showCompanyModal(fallbackData);
            }
        }
        
        // Function to show company modal for all users
        async function showCompanyModal(companyData) {
            console.log('üî∏ showCompanyModal called with:', companyData);
            const modal = document.getElementById('companyModal');
            console.log('üî∏ Modal element found:', !!modal);
            if (modal) {
                // Show modal first
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                console.log('üî∏ Modal should now be visible');
                
                // Update URL hash for shareable links
                const companyNumber = companyData.number || companyData.company_number;
                if (companyNumber) {
                    window.history.pushState(null, null, `#company/${companyNumber}`);
                }
                
                // Update modal content with company data (async)
                await updateModalContent(companyData);
            } else {
                console.error('üî∏ Modal element not found!');
            }
        }
        
        
        // Function to close company modal
        function closeCompanyModal() {
            const modal = document.getElementById('companyModal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                    
                    // Clear hash from URL
                    if (window.location.hash.startsWith('#company/')) {
                        window.history.pushState(null, null, window.location.pathname);
                    }
                }, 300);
            }
        }

        // Handle hash-based company routing
        async function handleCompanyHash() {
            const hash = window.location.hash;
            console.log('üî∏ handleCompanyHash called, hash:', hash);
            if (hash.startsWith('#company/')) {
                const companyNumber = hash.replace('#company/', '');
                if (companyNumber) {
                    console.log('üî∏ Loading company from hash:', companyNumber);
                    
                    // First try to find company in loaded data
                    const allCompanies = [...oldestCompanies, ...newestCompanies];
                    const foundCompany = allCompanies.find(c => c.number === companyNumber);
                    
                    if (foundCompany) {
                        console.log('üî∏ Found company in loaded data:', foundCompany);
                        await showCompanyModal(foundCompany);
                        
                        // Always fetch fresh data from Companies House API to get accurate stats
                        console.log('üî∏ Fetching fresh Companies House data for accurate stats...');
                        console.log('üî∏ Railway company data being passed:', foundCompany);
                        setTimeout(() => {
                            fetchCompanyDetails(companyNumber, foundCompany);
                        }, 100);
                    } else {
                        console.log('üî∏ Company not in loaded data, creating fallback and loading from Companies House API...');
                        
                        // Skip Railway API (doesn't support individual company lookup)
                        // Create minimal company object and show modal immediately
                        console.log('üî∏ Creating minimal company object for immediate display');
                        const fallbackCompany = {
                            name: `Loading Company ${companyNumber}...`,
                            number: companyNumber,
                            company_number: companyNumber,
                            status: 'Loading...',
                            company_status: 'Loading...',
                            companyType: 'Loading...',
                            company_type: 'Loading...',
                            incorporationDate: 'Loading...',
                            date_of_creation: 'Loading...'
                        };
                        await showCompanyModal(fallbackCompany);
                    }
                }
            }
        }

        // Listen for hash changes
        window.addEventListener('hashchange', handleCompanyHash);
        
        // Update modal content with company data
        async function updateModalContent(company) {
            console.log('üî∏ Updating modal with company data:', company);
            
            // Update company name
            const titleElement = document.querySelector('#companyModal .company-title');
            if (titleElement) {
                titleElement.textContent = company.name || company.title || 'Company Name';
            }
            
            // Update company subtitle
            const subtitleElement = document.querySelector('#companyModal .company-subtitle');
            if (subtitleElement) {
                if (company.previousName) {
                    subtitleElement.textContent = `Previously: ${company.previousName}`;
                    subtitleElement.style.display = 'block';
                } else {
                    subtitleElement.style.display = 'none';
                }
            }
            
            // Update company number badge
            const numberBadge = document.querySelector('#companyModal .company-number');
            if (numberBadge) {
                numberBadge.textContent = company.number || company.company_number || '00000000';
            }
            
            // Update company type badge
            const typeBadge = document.querySelector('#companyModal .company-type');
            if (typeBadge) {
                const type = company.companyType || company.company_type || 'ltd';
                // Extract short form
                if (type.toLowerCase().includes('public limited')) {
                    typeBadge.textContent = 'plc';
                } else if (type.toLowerCase().includes('limited liability partnership')) {
                    typeBadge.textContent = 'llp';
                } else if (type.toLowerCase().includes('limited partnership')) {
                    typeBadge.textContent = 'lp';
                } else if (type.toLowerCase().includes('limited')) {
                    typeBadge.textContent = 'ltd';
                } else {
                    typeBadge.textContent = type.toLowerCase().substring(0, 10);
                }
            }
            
            // Update status badge
            const statusBadge = document.querySelector('#companyModal .active-badge');
            if (statusBadge && company.status) {
                const status = company.status.toLowerCase();
                if (status === 'active') {
                    statusBadge.textContent = '‚óè Active';
                    statusBadge.style.background = 'rgba(34, 197, 94, 0.1)';
                    statusBadge.style.borderColor = 'rgba(34, 197, 94, 0.3)';
                    statusBadge.style.color = '#22c55e';
                } else if (status === 'dissolved') {
                    statusBadge.textContent = '‚úï Dissolved';
                    statusBadge.style.background = 'rgba(239, 68, 68, 0.1)';
                    statusBadge.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                    statusBadge.style.color = '#ef4444';
                } else if (status === 'liquidation') {
                    statusBadge.textContent = '‚ö†Ô∏è In Liquidation';
                    statusBadge.style.background = 'rgba(251, 146, 60, 0.1)';
                    statusBadge.style.borderColor = 'rgba(251, 146, 60, 0.3)';
                    statusBadge.style.color = '#fb923c';
                } else {
                    statusBadge.textContent = `‚óè ${status.charAt(0).toUpperCase() + status.slice(1)}`;
                }
            }
            
            // Update industry badge (dropdown-badge)
            const industryBadge = document.querySelector('#companyModal .dropdown-badge');
            if (industryBadge && company.industry) {
                const industrySpan = industryBadge.firstChild;
                if (industrySpan) {
                    industrySpan.textContent = company.industry.charAt(0).toUpperCase() + company.industry.slice(1).toLowerCase();
                }
                // Update tooltip with SIC codes
                const tooltip = industryBadge.querySelector('.tooltip');
                if (tooltip && company.sicCodes && company.sicCodes.length > 0) {
                    tooltip.textContent = company.sicCodes.filter(Boolean).join(', ') || 'No SIC codes available';
                }
            }
            
            // Update risk badge
            const riskBadge = document.querySelector('#companyModal .risk-badge');
            if (riskBadge && company.totalCharges !== undefined) {
                const riskLevel = company.totalCharges > 5 ? 'high' : company.totalCharges > 2 ? 'medium' : 'low';
                const riskText = company.totalCharges > 5 ? 'HIGH RISK' : company.totalCharges > 2 ? 'MEDIUM RISK' : 'LOW RISK';
                riskBadge.className = `risk-badge ${riskLevel}`;
                riskBadge.innerHTML = `<div class="risk-dot"></div>${riskText} (${Math.min(100, (company.totalCharges || 0) * 10)}/100)`;
            }
            
            // Calculate company age
            const companyAge = company.incorporationDate || company.date_of_creation 
                ? Math.floor((new Date() - new Date(company.incorporationDate || company.date_of_creation)) / (365.25 * 24 * 60 * 60 * 1000))
                : 0;
            
            // Update stats with real company data
            const statUpdates = [
                { selector: '.stat-box:nth-child(1) .stat-value', value: companyAge },
                { selector: '.stat-box:nth-child(1) .stat-detail', value: company.incorporationDate ? `Inc ${new Date(company.incorporationDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}` : 'Inc date unknown' },
                { selector: '.stat-box:nth-child(2) .stat-value', value: company.officerCount || '0' },
                { selector: '.stat-box:nth-child(2) .stat-detail', value: `${company.officerCount || 0} active` },
                { selector: '.stat-box:nth-child(3) .stat-value', value: company.filingCount || '0' },
                { selector: '.stat-box:nth-child(3) .stat-detail', value: `${company.filingCount || 0} total filings` },
                { selector: '.stat-box:nth-child(4) .stat-value', value: company.totalCharges || '0' },
                { selector: '.stat-box:nth-child(4) .stat-detail', value: `${company.outstandingCharges || 0} outstanding` }
            ];
            
            // Update ACCOUNTS status - use API data (more current)
            const accountsBox = document.querySelector('#companyModal .stat-box:nth-child(5)');
            if (accountsBox) {
                const accountsValue = accountsBox.querySelector('.stat-value');
                const accountsDetail = accountsBox.querySelector('.stat-detail');
                
                if (company.accountsDue || company.nextAccountsDue) {
                    accountsValue.textContent = '‚úì';
                    accountsDetail.textContent = `Next: ${formatAccountsDue(company.accountsDue || company.nextAccountsDue)}`;
                } else if (company.accountsOverdue) {
                    accountsValue.textContent = '‚ö†Ô∏è';
                    accountsValue.style.color = '#ef4444';
                    accountsDetail.textContent = 'OVERDUE';
                    accountsDetail.style.color = '#ef4444';
                } else {
                    // Calculate next accounts date based on incorporation date
                    accountsValue.textContent = '‚úì';
                    const nextAccountsDate = calculateNextAccountsDate(company.incorporationDate || company.date_of_creation);
                    accountsDetail.textContent = `Next: ${formatAccountsDue(nextAccountsDate)}`;
                }
            }
            
            // Update CONFIRMATION STATEMENT status - use API data (more current)
            const confirmationBox = document.querySelector('#companyModal .stat-box:nth-child(6)');
            if (confirmationBox) {
                const confirmationValue = confirmationBox.querySelector('.stat-value');
                const confirmationDetail = confirmationBox.querySelector('.stat-detail');
                
                if (company.confirmationStatementDue || company.nextConfirmationDue) {
                    confirmationValue.textContent = '‚úì';
                    confirmationDetail.textContent = `Next: ${formatAccountsDue(company.confirmationStatementDue || company.nextConfirmationDue)}`;
                } else if (company.confirmationOverdue) {
                    confirmationValue.textContent = '‚ö†Ô∏è';
                    confirmationValue.style.color = '#ef4444';
                    confirmationDetail.textContent = 'OVERDUE';
                    confirmationDetail.style.color = '#ef4444';
                } else {
                    // Calculate next confirmation statement date
                    confirmationValue.textContent = '‚úì';
                    const nextConfirmationDate = calculateNextConfirmationDate(company.incorporationDate || company.date_of_creation);
                    confirmationDetail.textContent = nextConfirmationDate ? `Next: ${formatAccountsDue(nextConfirmationDate)}` : 'Up to date';
                }
            }
            
            statUpdates.forEach(update => {
                const element = document.querySelector(`#companyModal ${update.selector}`);
                if (element) {
                    element.textContent = update.value;
                }
            });
            
            // Apply charges number styling
            const chargesValue = document.querySelector('#companyModal .stat-box:nth-child(4) .stat-value');
            if (chargesValue && (company.totalCharges || 0) > 0) {
                chargesValue.classList.add('charges-number');
            }
            
            // Update Overview tab content with Railway data first
            updateOverviewTab(company);
            
            // Store Railway address before API call overwrites it
            const railwayAddress = company.address;
            
            // Fetch and populate detailed company data (pass Railway data as fallback)
            await fetchCompanyDetails(company.number || company.company_number, company);
            
            // For Railway companies, the address might be overwritten by API call
            // So we need to restore it if available
            if (railwayAddress && Object.values(railwayAddress).some(v => v)) {
                // Wait a bit for the overview tab to be populated
                setTimeout(() => {
                    // Find the address element in the overview tab
                    const overviewTab = document.querySelector('#companyModal #overview');
                    if (overviewTab) {
                        const addressItem = Array.from(overviewTab.querySelectorAll('.data-item')).find(item => {
                            const header = item.querySelector('.data-item-header');
                            return header && header.textContent === 'Registered Address';
                        });
                        
                        if (addressItem) {
                            const addressDetail = addressItem.querySelector('.data-item-detail');
                            if (addressDetail) {
                                // Format Railway address
                                const addressParts = [];
                                if (railwayAddress.line1) addressParts.push(railwayAddress.line1);
                                if (railwayAddress.line2) addressParts.push(railwayAddress.line2);
                                if (railwayAddress.postTown) addressParts.push(railwayAddress.postTown);
                                if (railwayAddress.county) addressParts.push(railwayAddress.county);
                                if (railwayAddress.postCode) addressParts.push(railwayAddress.postCode);
                                if (railwayAddress.country) addressParts.push(railwayAddress.country);
                                
                                const formattedAddress = addressParts.length > 0 ? addressParts.join(', ') : 'Address not available';
                                addressDetail.textContent = formattedAddress;
                                console.log('üî∏ Railway address restored:', formattedAddress);
                            }
                        }
                    }
                }, 500);
            }
        }
        
        // Update Overview tab with company data
        function updateOverviewTab(company) {
            console.log('üî∏ updateOverviewTab called with company:', company);
            console.log('üî∏ Company address data:', company.address);
            
            // Update address
            const addressEl = document.getElementById('modal-address');
            console.log('üî∏ Looking for modal-address element:', !!addressEl);
            console.log('üî∏ Modal display state:', document.getElementById('companyModal')?.style.display);
            if (addressEl) {
                const addressParts = [];
                
                // Handle Railway format (company.address.line1) and API format (company.address_line_1)
                if (company.address && typeof company.address === 'object') {
                    console.log('üî∏ Using Railway address format');
                    // Railway format
                    if (company.address.line1) addressParts.push(company.address.line1);
                    if (company.address.line2) addressParts.push(company.address.line2);
                    if (company.address.postTown) addressParts.push(company.address.postTown);
                    if (company.address.county) addressParts.push(company.address.county);
                    if (company.address.postCode) addressParts.push(company.address.postCode);
                    if (company.address.country) addressParts.push(company.address.country);
                } else {
                    console.log('üî∏ Using API address format');
                    // API format
                    if (company.address_line_1) addressParts.push(company.address_line_1);
                    if (company.address_line_2) addressParts.push(company.address_line_2);
                    if (company.locality) addressParts.push(company.locality);
                    if (company.region) addressParts.push(company.region);
                    if (company.postal_code) addressParts.push(company.postal_code);
                    if (company.country) addressParts.push(company.country);
                }
                
                const finalAddress = addressParts.length > 0 ? addressParts.join(', ') : 'No address available';
                console.log('üî∏ updateOverviewTab setting address to:', finalAddress);
                addressEl.textContent = finalAddress;
            } else {
                console.error('üî∏ Address element not found in updateOverviewTab');
            }
            
            // Update company type
            const typeEl = document.getElementById('modal-type');
            if (typeEl) {
                typeEl.textContent = company.companyType || company.company_type || 'Limited Company';
            }
            
            // Update status
            const statusEl = document.getElementById('modal-status');
            if (statusEl) {
                statusEl.textContent = company.status || 'Active';
            }
            
            // Update incorporation date
            const incDateEl = document.getElementById('modal-inc-date');
            if (incDateEl) {
                incDateEl.textContent = company.incorporationDate 
                    ? new Date(company.incorporationDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })
                    : 'Not available';
            }
            
            // Update SIC codes
            const sicEl = document.getElementById('modal-sic');
            if (sicEl) {
                if (company.sicCodes && company.sicCodes.length > 0) {
                    sicEl.innerHTML = company.sicCodes.filter(Boolean).join('<br>');
                } else {
                    sicEl.textContent = 'No SIC codes available';
                }
            }
            
            // Update previous names
            const prevNamesEl = document.getElementById('modal-prev-names');
            if (prevNamesEl) {
                prevNamesEl.textContent = company.previousName || 'None recorded';
            }
        }
        
        // Fetch detailed company information from API
        async function fetchCompanyDetails(companyNumber, railwayCompanyData = null) {
            if (!companyNumber) {
                console.log('üî∏ fetchCompanyDetails: No company number provided');
                return;
            }
            
            try {
                console.log('üî∏ Fetching detailed data for company:', companyNumber);
                
                // Fetch company profile using the worker proxy
                const API_KEY = '22aefa40-ee9e-47c0-b40a-2dd3c03165c6';
                const response = await fetchWithWorker(`https://api.companieshouse.gov.uk/company/${companyNumber}`, API_KEY);
                console.log('üî∏ Companies House API response status:', response.status);
                
                if (response.ok) {
                    const companyData = await response.json();
                    console.log('üî∏ Companies House API data received:', companyData);
                    
                    // Update the modal header with real company data
                    updateModalHeader(companyData);
                    
                    populateOverviewTab(companyData);
                    
                    // Update accounts status from API data
                    if (companyData.accounts) {
                        const accountsBox = document.querySelector('#companyModal .stat-box:nth-child(5)');
                        if (accountsBox) {
                            const accountsValue = accountsBox.querySelector('.stat-value');
                            const accountsDetail = accountsBox.querySelector('.stat-detail');
                            
                            if (companyData.accounts.overdue === true) {
                                accountsValue.textContent = '‚ö†Ô∏è';
                                accountsValue.style.color = '#ef4444';
                                accountsDetail.textContent = 'OVERDUE';
                                accountsDetail.style.color = '#ef4444';
                            } else if (companyData.accounts.next_due) {
                                accountsValue.textContent = '‚úì';
                                accountsValue.style.color = '';
                                accountsDetail.textContent = `Next: ${new Date(companyData.accounts.next_due).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}`;
                                accountsDetail.style.color = '';
                            } else if (companyData.accounts.next_made_up_to) {
                                // Calculate next due based on next made up to date + 9 months
                                const nextMadeUpTo = new Date(companyData.accounts.next_made_up_to);
                                nextMadeUpTo.setMonth(nextMadeUpTo.getMonth() + 9);
                                accountsValue.textContent = '‚úì';
                                accountsValue.style.color = '';
                                accountsDetail.textContent = `Next: ${nextMadeUpTo.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}`;
                                accountsDetail.style.color = '';
                            }
                        }
                    }
                    
                    // Update confirmation statement status from API data
                    if (companyData.confirmation_statement) {
                        const confirmationBox = document.querySelector('#companyModal .stat-box:nth-child(6)');
                        if (confirmationBox) {
                            const confirmationValue = confirmationBox.querySelector('.stat-value');
                            const confirmationDetail = confirmationBox.querySelector('.stat-detail');
                            
                            if (companyData.confirmation_statement.overdue === true) {
                                confirmationValue.textContent = '‚ö†Ô∏è';
                                confirmationValue.style.color = '#ef4444';
                                confirmationDetail.textContent = 'OVERDUE';
                                confirmationDetail.style.color = '#ef4444';
                            } else if (companyData.confirmation_statement.next_due) {
                                confirmationValue.textContent = '‚úì';
                                confirmationValue.style.color = '';
                                confirmationDetail.textContent = `Next: ${new Date(companyData.confirmation_statement.next_due).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}`;
                                confirmationDetail.style.color = '';
                            } else if (companyData.confirmation_statement.next_made_up_to) {
                                // Calculate next due based on next made up to date + 14 days
                                const nextMadeUpTo = new Date(companyData.confirmation_statement.next_made_up_to);
                                nextMadeUpTo.setDate(nextMadeUpTo.getDate() + 14);
                                confirmationValue.textContent = '‚úì';
                                confirmationValue.style.color = '';
                                confirmationDetail.textContent = `Next: ${nextMadeUpTo.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}`;
                                confirmationDetail.style.color = '';
                            }
                        }
                    }
                    
                    // Fetch officers with incorporation date
                    fetchOfficers(companyNumber, companyData.date_of_creation);
                    
                    // Fetch charges
                    fetchCharges(companyNumber);
                    
                    // Fetch filing history
                    fetchFilingHistory(companyNumber, companyData.date_of_creation);
                    
                    // Update risk insights with full company data
                    const fullCompanyData = {
                        ...(railwayCompanyData || {}),
                        ...companyData,
                        name: companyData.company_name || (railwayCompanyData ? railwayCompanyData.name : ''),
                        status: companyData.company_status || (railwayCompanyData ? railwayCompanyData.status : ''),
                        incorporationDate: companyData.date_of_creation || (railwayCompanyData ? railwayCompanyData.incorporationDate : ''),
                        companyType: companyData.type || (railwayCompanyData ? railwayCompanyData.companyType : ''),
                        sicCodes: companyData.sic_codes || (railwayCompanyData ? railwayCompanyData.sicCodes : []) || []
                    };
                    updateRiskInsightsTab(fullCompanyData);
                } else {
                    console.log('üî∏ Main company API failed, using Railway data and calculating stats');
                    
                    // Use Railway company data for basic info if provided
                    if (railwayCompanyData) {
                        console.log('üî∏ Updating modal with Railway data:', railwayCompanyData);
                        
                        // Calculate age from Railway incorporation date
                        if (railwayCompanyData.incorporationDate) {
                            const ageBox = document.querySelector('#companyModal .stat-box:nth-child(1)');
                            if (ageBox) {
                                const ageValue = ageBox.querySelector('.stat-value');
                                const ageDetail = ageBox.querySelector('.stat-detail');
                                
                                const incorporationDate = new Date(railwayCompanyData.incorporationDate);
                                const currentDate = new Date();
                                const ageInYears = Math.floor((currentDate - incorporationDate) / (365.25 * 24 * 60 * 60 * 1000));
                                
                                if (ageValue) ageValue.textContent = ageInYears;
                                if (ageDetail) {
                                    ageDetail.textContent = `Inc ${incorporationDate.toLocaleDateString('en-GB', { 
                                        day: 'numeric', 
                                        month: 'short', 
                                        year: 'numeric' 
                                    })}`;
                                }
                                
                                console.log('üî∏ Updated Railway company age to:', ageInYears, 'years');
                            }
                        }
                        
                        // Update status badge with Railway data
                        const statusBadge = document.querySelector('#companyModal .active-badge');
                        if (statusBadge && railwayCompanyData.status) {
                            const status = railwayCompanyData.status.toLowerCase();
                            if (status === 'active') {
                                statusBadge.textContent = '‚óè Active';
                                statusBadge.className = 'badge active-badge';
                            } else if (status === 'dissolved') {
                                statusBadge.textContent = '‚úï Dissolved';
                                statusBadge.className = 'badge';
                                statusBadge.style.background = 'rgba(239, 68, 68, 0.1)';
                                statusBadge.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                                statusBadge.style.color = '#ef4444';
                            }
                            console.log('üî∏ Updated Railway company status to:', railwayCompanyData.status);
                        }
                        
                        populateWithMockData(railwayCompanyData);
                    } else {
                        // Try to get from button as fallback
                        const fullCompanyData = document.querySelector(`[data-company*="${companyNumber}"]`);
                        if (fullCompanyData) {
                            const companyData = JSON.parse(fullCompanyData.getAttribute('data-company'));
                            populateWithMockData(companyData);
                        } else {
                            populateWithMockData({ number: companyNumber });
                        }
                    }
                    
                    // Still try to fetch officers, charges, filings - these might work for some companies
                    fetchOfficers(companyNumber, railwayCompanyData ? railwayCompanyData.incorporationDate : null);
                    fetchCharges(companyNumber);
                    fetchFilingHistory(companyNumber, railwayCompanyData ? railwayCompanyData.incorporationDate : null);
                }
            } catch (error) {
                console.log('üî∏ Error fetching company data, using Railway data and calculating stats:', error);
                
                // Use Railway company data for basic info if provided
                if (railwayCompanyData) {
                    console.log('üî∏ Updating modal with Railway data after error:', railwayCompanyData);
                    
                    // Calculate age from Railway incorporation date
                    if (railwayCompanyData.incorporationDate) {
                        const ageBox = document.querySelector('#companyModal .stat-box:nth-child(1)');
                        if (ageBox) {
                            const ageValue = ageBox.querySelector('.stat-value');
                            const ageDetail = ageBox.querySelector('.stat-detail');
                            
                            const incorporationDate = new Date(railwayCompanyData.incorporationDate);
                            const currentDate = new Date();
                            const ageInYears = Math.floor((currentDate - incorporationDate) / (365.25 * 24 * 60 * 60 * 1000));
                            
                            if (ageValue) ageValue.textContent = ageInYears;
                            if (ageDetail) {
                                ageDetail.textContent = `Inc ${incorporationDate.toLocaleDateString('en-GB', { 
                                    day: 'numeric', 
                                    month: 'short', 
                                    year: 'numeric' 
                                })}`;
                            }
                            
                            console.log('üî∏ Updated Railway company age to:', ageInYears, 'years (after error)');
                        }
                    }
                    
                    // Update status badge with Railway data
                    const statusBadge = document.querySelector('#companyModal .active-badge');
                    if (statusBadge && railwayCompanyData.status) {
                        const status = railwayCompanyData.status.toLowerCase();
                        if (status === 'active') {
                            statusBadge.textContent = '‚óè Active';
                            statusBadge.className = 'badge active-badge';
                        } else if (status === 'dissolved') {
                            statusBadge.textContent = '‚úï Dissolved';
                            statusBadge.className = 'badge';
                            statusBadge.style.background = 'rgba(239, 68, 68, 0.1)';
                            statusBadge.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                            statusBadge.style.color = '#ef4444';
                        }
                        console.log('üî∏ Updated Railway company status to:', railwayCompanyData.status, '(after error)');
                    }
                }
                
                // Even with error, still try to fetch officers, charges, filings
                fetchOfficers(companyNumber, railwayCompanyData ? railwayCompanyData.incorporationDate : null);
                fetchCharges(companyNumber);
                fetchFilingHistory(companyNumber, railwayCompanyData ? railwayCompanyData.incorporationDate : null);
                
                // Use Railway company data for basic info if provided
                if (railwayCompanyData) {
                    populateWithMockData(railwayCompanyData);
                } else {
                    // Try to get from button as fallback
                    const button = document.querySelector(`[data-company*="${companyNumber}"]`);
                    if (button) {
                        const companyData = JSON.parse(button.getAttribute('data-company'));
                        populateWithMockData(companyData);
                    } else {
                        populateWithMockData({ number: companyNumber });
                    }
                }
            }
        }
        
        // Update modal header with real company data
        function updateModalHeader(companyData) {
            console.log('üî∏ updateModalHeader called with:', companyData.company_name);
            
            // Update SEO meta tags for this company
            updateCompanySEO(companyData);
            
            // Update company name in header
            const titleElement = document.querySelector('#companyModal .company-title');
            if (titleElement && companyData.company_name) {
                titleElement.textContent = companyData.company_name;
                console.log('üî∏ Updated modal title to:', companyData.company_name);
            }
            
            // Update company number badge
            const numberBadge = document.querySelector('#companyModal .company-number');
            if (numberBadge && companyData.company_number) {
                numberBadge.textContent = companyData.company_number;
            }
            
            // Update company type badge
            const typeBadge = document.querySelector('#companyModal .company-type');
            if (typeBadge && companyData.type) {
                if (companyData.type.toLowerCase().includes('public limited')) {
                    typeBadge.textContent = 'plc';
                } else if (companyData.type.toLowerCase().includes('limited liability partnership')) {
                    typeBadge.textContent = 'llp';
                } else if (companyData.type.toLowerCase().includes('limited partnership')) {
                    typeBadge.textContent = 'lp';
                } else if (companyData.type.toLowerCase().includes('limited') || companyData.type === 'ltd') {
                    typeBadge.textContent = 'ltd';
                } else {
                    typeBadge.textContent = companyData.type.toLowerCase().substring(0, 10);
                }
            }
            
            // Update status badge from Companies House API data
            const statusBadge = document.querySelector('#companyModal .active-badge');
            if (statusBadge) {
                if (companyData.company_status) {
                    const status = companyData.company_status.toLowerCase();
                    if (status === 'active') {
                        statusBadge.textContent = '‚óè Active';
                        statusBadge.className = 'badge active-badge';
                    } else if (status === 'dissolved') {
                        statusBadge.textContent = '‚úï Dissolved';
                        statusBadge.className = 'badge';
                        statusBadge.style.background = 'rgba(239, 68, 68, 0.1)';
                        statusBadge.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                        statusBadge.style.color = '#ef4444';
                    }
                    console.log('üî∏ Updated company status to:', companyData.company_status, '(from CH API)');
                } else if (companyData.company_number?.startsWith('RC') || companyData.type?.toLowerCase().includes('royal charter')) {
                    // Royal Charter companies are presumed active if they appear in CH API
                    statusBadge.textContent = '‚óè Active';
                    statusBadge.className = 'badge active-badge';
                    console.log('üî∏ Updated Royal Charter company status to: Active (presumed)');
                }
            }
            
            // Calculate and update company age from Companies House API data
            const ageBox = document.querySelector('#companyModal .stat-box:nth-child(1)');
            if (ageBox) {
                const ageValue = ageBox.querySelector('.stat-value');
                const ageDetail = ageBox.querySelector('.stat-detail');
                
                if (companyData.date_of_creation) {
                    const incorporationDate = new Date(companyData.date_of_creation);
                    const currentDate = new Date();
                    const ageInYears = Math.floor((currentDate - incorporationDate) / (365.25 * 24 * 60 * 60 * 1000));
                    
                    if (ageValue) ageValue.textContent = ageInYears;
                    if (ageDetail) {
                        ageDetail.textContent = `Inc ${incorporationDate.toLocaleDateString('en-GB', { 
                            day: 'numeric', 
                            month: 'short', 
                            year: 'numeric' 
                        })}`;
                    }
                    
                    console.log('üî∏ Updated company age to:', ageInYears, 'years (from CH API)');
                } else if (companyData.company_number?.startsWith('RC')) {
                    // For Royal Charter companies, try to get incorporation date from Railway data
                    console.log('üî∏ Looking for Railway data for RC company:', companyData.company_number);
                    
                    const allCompanies = [...(window.oldestCompanies || []), ...(window.newestCompanies || [])];
                    console.log('üî∏ Initial check - Total companies available:', allCompanies.length);
                    console.log('üî∏ window.oldestCompanies length:', window.oldestCompanies?.length || 0);
                    console.log('üî∏ window.newestCompanies length:', window.newestCompanies?.length || 0);
                    console.log('üî∏ Available RC companies:', allCompanies.filter(c => c.number?.startsWith('RC')).map(c => c.number));
                    const railwayCompany = allCompanies.find(c => c.number === companyData.company_number);
                    console.log('üî∏ Initial lookup result:', railwayCompany ? 'FOUND' : 'NOT FOUND');
                    
                    if (railwayCompany && railwayCompany.incorporationDate) {
                        const incorporationDate = new Date(railwayCompany.incorporationDate);
                        const currentDate = new Date();
                        const ageInYears = Math.floor((currentDate - incorporationDate) / (365.25 * 24 * 60 * 60 * 1000));
                        
                        if (ageValue) ageValue.textContent = ageInYears;
                        if (ageDetail) {
                            ageDetail.textContent = `Inc ${incorporationDate.toLocaleDateString('en-GB', { 
                                day: 'numeric', 
                                month: 'short', 
                                year: 'numeric' 
                            })}`;
                        }
                        
                        console.log('üî∏ Updated Royal Charter company age to:', ageInYears, 'years (from Railway data)');
                        
                        // Also update the Analysis Summary with correct Railway data
                        updateRiskInsightsTab(companyData);
                        console.log('üî∏ Updated Analysis Summary with Railway data');
                    } else {
                        // Railway data not loaded yet, set up a retry mechanism
                        if (ageValue) ageValue.textContent = '...';
                        if (ageDetail) ageDetail.textContent = 'Loading age...';
                        
                        console.log('üî∏ Railway data not loaded yet, setting up retry for:', companyData.company_number);
                        
                        // Retry every 500ms up to 10 times (5 seconds total)
                        let retryCount = 0;
                        const maxRetries = 10;
                        
                        const retryInterval = setInterval(() => {
                            retryCount++;
                            console.log(`üî∏ Retry ${retryCount}/${maxRetries} for Railway data...`);
                            
                            const allCompaniesRetry = [...(window.oldestCompanies || []), ...(window.newestCompanies || [])];
                            console.log(`üî∏ Total companies in window arrays:`, allCompaniesRetry.length);
                            console.log(`üî∏ window.oldestCompanies length:`, window.oldestCompanies?.length || 0);
                            console.log(`üî∏ window.newestCompanies length:`, window.newestCompanies?.length || 0);
                            console.log(`üî∏ Available RC companies:`, allCompaniesRetry.filter(c => c.number?.startsWith('RC')).map(c => c.number));
                            console.log(`üî∏ Looking for:`, companyData.company_number);
                            const railwayCompanyRetry = allCompaniesRetry.find(c => c.number === companyData.company_number);
                            console.log(`üî∏ Found:`, railwayCompanyRetry ? 'YES' : 'NO');
                            if (railwayCompanyRetry) {
                                console.log(`üî∏ Found company data:`, railwayCompanyRetry);
                            }
                            
                            if (railwayCompanyRetry && railwayCompanyRetry.incorporationDate) {
                                clearInterval(retryInterval);
                                
                                const incorporationDate = new Date(railwayCompanyRetry.incorporationDate);
                                const currentDate = new Date();
                                const ageInYears = Math.floor((currentDate - incorporationDate) / (365.25 * 24 * 60 * 60 * 1000));
                                
                                if (ageValue) ageValue.textContent = ageInYears;
                                if (ageDetail) {
                                    ageDetail.textContent = `Inc ${incorporationDate.toLocaleDateString('en-GB', { 
                                        day: 'numeric', 
                                        month: 'short', 
                                        year: 'numeric' 
                                    })}`;
                                }
                                
                                console.log('üî∏ Updated Royal Charter company age to:', ageInYears, 'years (from Railway data - retry)');
                                
                                // Also update the Analysis Summary with correct Railway data
                                updateRiskInsightsTab(companyData);
                                console.log('üî∏ Updated Analysis Summary with Railway data');
                            } else if (retryCount >= maxRetries) {
                                clearInterval(retryInterval);
                                // Final fallback after all retries
                                if (ageValue) ageValue.textContent = '?';
                                if (ageDetail) ageDetail.textContent = 'Age unknown';
                                console.log('üî∏ Failed to get Railway data after retries');
                            }
                        }, 500);
                    }
                } else {
                    // Unknown incorporation date
                    if (ageValue) ageValue.textContent = '?';
                    if (ageDetail) ageDetail.textContent = 'Inc date unknown';
                    console.log('üî∏ Company age unknown - no incorporation date');
                }
            }
            
            // Update charges count (will be updated later when charges API returns)
            const chargesBox = document.querySelector('#companyModal .stat-box:nth-child(4)');
            if (chargesBox) {
                const chargesValue = chargesBox.querySelector('.stat-value');
                const chargesDetail = chargesBox.querySelector('.stat-detail');
                
                // Set initial values based on has_charges flag
                if (companyData.has_charges === false) {
                    if (chargesValue) chargesValue.textContent = '0';
                    if (chargesDetail) chargesDetail.textContent = '0 outstanding';
                    console.log('üî∏ Company has no charges');
                } else {
                    // Will be updated when charges API call completes
                    if (chargesValue) chargesValue.textContent = '...';
                    if (chargesDetail) chargesDetail.textContent = 'Loading...';
                    console.log('üî∏ Company may have charges, waiting for charges API');
                }
            }
        }
        
        // Populate Overview tab with real data
        function populateOverviewTab(companyData) {
            console.log('üî∏ populateOverviewTab called with:', companyData);
            const overviewTab = document.querySelector('#companyModal #overview');
            if (!overviewTab) {
                console.log('üî∏ Overview tab not found!');
                return;
            }
            
            overviewTab.innerHTML = `
                <h3>Company Overview</h3>
                <div class="data-item">
                    <div class="data-item-header">Registered Address</div>
                    <div class="data-item-detail">${formatAddress(companyData.registered_office_address)}</div>
                </div>
                <div class="data-item">
                    <div class="data-item-header">Company Type</div>
                    <div class="data-item-detail">${companyData.type || 'Private Limited Company'}</div>
                </div>
                <div class="data-item">
                    <div class="data-item-header">Company Status</div>
                    <div class="data-item-detail">${companyData.company_status || 'Active'}</div>
                </div>
                <div class="data-item">
                    <div class="data-item-header">Nature of Business (SIC)</div>
                    <div class="data-item-detail">${formatSicCodes(companyData.sic_codes)}</div>
                </div>
                <div class="data-item">
                    <div class="data-item-header">Incorporation Date</div>
                    <div class="data-item-detail">${companyData.date_of_creation ? new Date(companyData.date_of_creation).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }) : 'Unknown'}</div>
                </div>
                ${companyData.accounts ? `
                <div class="data-item">
                    <div class="data-item-header">Accounting Reference Date</div>
                    <div class="data-item-detail">${companyData.accounts.accounting_reference_date?.day || ''} ${companyData.accounts.accounting_reference_date?.month || ''}</div>
                </div>
                <div class="data-item">
                    <div class="data-item-header">Next Accounts Due</div>
                    <div class="data-item-detail">${companyData.accounts.next_due ? new Date(companyData.accounts.next_due).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }) : 'Unknown'}</div>
                </div>
                <div class="data-item">
                    <div class="data-item-header">Last Accounts Made Up To</div>
                    <div class="data-item-detail">${companyData.accounts.last_accounts?.made_up_to ? new Date(companyData.accounts.last_accounts.made_up_to).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }) : 'Not filed'}</div>
                </div>
                ${companyData.accounts.overdue ? `
                <div class="data-item" style="border-color: #ef4444;">
                    <div class="data-item-header" style="color: #ef4444;">‚ö†Ô∏è Accounts Status</div>
                    <div class="data-item-detail" style="color: #ef4444;">OVERDUE - Accounts are overdue for filing</div>
                </div>` : ''}` : ''}
                ${companyData.confirmation_statement ? `
                <div class="data-item">
                    <div class="data-item-header">Next Confirmation Statement Due</div>
                    <div class="data-item-detail">${companyData.confirmation_statement.next_due ? new Date(companyData.confirmation_statement.next_due).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }) : 'Unknown'}</div>
                </div>` : ''}
            `;
        }
        
        // Fetch and populate officers data
        async function fetchOfficers(companyNumber, incorporationDate) {
            try {
                const API_KEY = '22aefa40-ee9e-47c0-b40a-2dd3c03165c6';
                const response = await fetchWithWorker(`https://api.companieshouse.gov.uk/company/${companyNumber}/officers?items_per_page=200`, API_KEY);
                
                if (response.ok) {
                    const data = await response.json();
                    const officers = data.items.map(officer => ({
                        name: officer.name,
                        role: formatOfficerRole(officer.officer_role),
                        appointed: officer.appointed_on,
                        resigned: officer.resigned_on,
                        address: formatAddress(officer.address),
                        nationality: officer.nationality,
                        dateOfBirth: officer.date_of_birth ? `${officer.date_of_birth.month}/${officer.date_of_birth.year}` : null
                    }));
                    
                    // Update officers count in stat box (2nd box) - show total like Companies House
                    const officersBox = document.querySelector('#companyModal .stat-box:nth-child(2)');
                    if (officersBox) {
                        const officersValue = officersBox.querySelector('.stat-value');
                        const officersDetail = officersBox.querySelector('.stat-detail');
                        const activeOfficers = officers.filter(officer => !officer.resigned);
                        const totalOfficers = data.total_count || officers.length;
                        
                        if (officersValue) officersValue.textContent = totalOfficers.toString();
                        if (officersDetail) officersDetail.textContent = `${activeOfficers.length} active`;
                        
                        console.log(`üî∏ Updated officers count: ${totalOfficers} total (${activeOfficers.length} active)`);
                    }
                    
                    populateOfficersTab(officers, companyNumber, incorporationDate);
                } else {
                    // Fallback to basic data
                    const fallbackOfficers = [
                        { name: 'Officer data unavailable', role: 'Director', appointed: new Date().toISOString().split('T')[0] }
                    ];
                    populateOfficersTab(fallbackOfficers, companyNumber, incorporationDate);
                }
            } catch (error) {
                console.log('Error fetching officers:', error);
                // Use basic fallback
                populateOfficersTab([], companyNumber, incorporationDate);
            }
        }
        
        function formatOfficerRole(role) {
            const roleMap = {
                'director': 'Director',
                'secretary': 'Company Secretary',
                'llp-member': 'LLP Member',
                'llp-designated-member': 'LLP Designated Member',
                'corporate-director': 'Corporate Director',
                'corporate-secretary': 'Corporate Secretary',
                'corporate-llp-member': 'Corporate LLP Member',
                'corporate-llp-designated-member': 'Corporate LLP Designated Member'
            };
            return roleMap[role] || role.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }
        
        // Populate Officers tab
        function populateOfficersTab(officers, companyNumber, incorporationDate) {
            const peopleTab = document.querySelector('#companyModal #people');
            if (!peopleTab) return;
            
            // Sort officers - active first, then by appointment date
            const sortedOfficers = officers.sort((a, b) => {
                if (!a.resigned && b.resigned) return -1;
                if (a.resigned && !b.resigned) return 1;
                return new Date(b.appointed) - new Date(a.appointed);
            });
            
            const officerHTML = sortedOfficers.length > 0 ? sortedOfficers.map(officer => {
                const appointedDate = officer.appointed ? new Date(officer.appointed).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) : 'Unknown';
                const resignedText = officer.resigned ? ` - Resigned: ${new Date(officer.resigned).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })}` : '';
                const statusStyle = officer.resigned ? 'style="opacity: 0.6;"' : '';
                
                return `
                    <div class="data-item" ${statusStyle}>
                        <div class="data-item-header">${officer.name.toUpperCase()}</div>
                        <div class="data-item-detail">${officer.role} - Appointed: ${appointedDate}${resignedText}</div>
                    </div>
                `;
            }).join('') : (() => {
                const isHistorical = isHistoricalCompany(companyNumber || '', incorporationDate);
                const historicalType = getHistoricalCompanyType(companyNumber || '');
                
                if (isHistorical) {
                    return `
                        <div style="text-align: center; padding: 40px;">
                            <div style="margin-bottom: 16px;">
                                <span style="background: rgba(251, 191, 36, 0.1); color: #fbbf24; padding: 6px 16px; border-radius: 8px; font-size: 13px; font-weight: 600;">
                                    ${historicalType}
                                </span>
                            </div>
                            <div style="color: #94a3b8; font-size: 15px; line-height: 1.6;">
                                Historical records are not digitally available
                            </div>
                            <div style="color: #64748b; font-size: 13px; margin-top: 8px;">
                                Pre-digital era company records
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="data-item">
                            <div class="data-item-header">No officer information available</div>
                            <div class="data-item-detail">Officer data could not be retrieved</div>
                        </div>
                    `;
                }
            })();
            
            peopleTab.innerHTML = `
                <h3>People & Control</h3>
                ${officerHTML}
            `;
            
            // Enhance officer names with director lookup badges
            console.log('Calling enhanceOfficerNames...');
            enhanceOfficerNames();
        }
        
        // Fetch and populate charges data
        async function fetchCharges(companyNumber) {
            try {
                const API_KEY = '22aefa40-ee9e-47c0-b40a-2dd3c03165c6';
                const response = await fetchWithWorker(`https://api.companieshouse.gov.uk/company/${companyNumber}/charges`, API_KEY);
                console.log('üî∏ Charges API response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üî∏ Charges API data received:', data);
                    const charges = data.items ? data.items.map(charge => ({
                        description: charge.classification?.description || 'Charge',
                        created: charge.created_on || charge.delivered_on,
                        status: charge.status === 'fully-satisfied' ? 'satisfied' : (charge.status || 'outstanding'),
                        personsEntitled: charge.persons_entitled ? charge.persons_entitled.map(p => p.name).join(', ') : '',
                        amountSecured: charge.particulars?.amount_secured || '',
                        type: charge.classification?.type || charge.charge_code || ''
                    })) : [];
                    
                    populateChargesTab(charges);
                } else {
                    // Use data from Railway database if available
                    const button = document.querySelector(`[data-company*="${companyNumber}"]`);
                    if (button) {
                        const companyData = JSON.parse(button.getAttribute('data-company'));
                        const charges = [];
                        if (companyData.totalCharges > 0) {
                            for (let i = 0; i < Math.min(companyData.totalCharges, 10); i++) {
                                charges.push({
                                    description: `Charge ${i + 1}`,
                                    created: 'Date not available',
                                    status: i < companyData.outstandingCharges ? 'outstanding' : 'satisfied',
                                    personsEntitled: '',
                                    amountSecured: '',
                                    type: ''
                                });
                            }
                        }
                        populateChargesTab(charges);
                    } else {
                        populateChargesTab([]);
                    }
                }
            } catch (error) {
                console.log('Error fetching charges:', error);
                populateChargesTab([]);
            }
        }
        
        // Populate Charges tab
        function populateChargesTab(charges) {
            const chargesTab = document.querySelector('#companyModal #charges');
            if (!chargesTab) return;
            
            // Update charges count in stat box (4th box)
            const chargesBox = document.querySelector('#companyModal .stat-box:nth-child(4)');
            if (chargesBox) {
                const chargesValue = chargesBox.querySelector('.stat-value');
                const chargesDetail = chargesBox.querySelector('.stat-detail');
                const outstandingCount = charges.filter(c => c.status === 'outstanding').length;
                const totalCharges = charges.length;
                
                if (chargesValue) chargesValue.textContent = totalCharges.toString();
                if (chargesDetail) chargesDetail.textContent = `${outstandingCount} outstanding`;
                
                console.log(`üî∏ Updated charges count: ${totalCharges} total (${outstandingCount} outstanding)`);
            }
            
            if (charges.length === 0) {
                chargesTab.innerHTML = `
                    <h3>Charges & Securities</h3>
                    <div style="text-align: center; padding: 60px 20px; color: #71767b;">
                        <p style="font-size: 20px; margin-bottom: 12px;">‚úì No Outstanding Charges</p>
                        <p>This company has no registered charges or securities</p>
                    </div>
                `;
            } else {
                // Count outstanding vs satisfied
                const outstandingCount = charges.filter(c => c.status === 'outstanding').length;
                const satisfiedCount = charges.filter(c => c.status === 'satisfied').length;
                
                const chargesHTML = charges.map(charge => {
                    const dateText = charge.created !== 'Date not available' 
                        ? new Date(charge.created).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })
                        : 'Date not available';
                    const statusColor = charge.status === 'outstanding' ? '#ef4444' : '#22c55e';
                    const statusText = charge.status === 'outstanding' ? 'OUTSTANDING' : 'SATISFIED';
                    
                    return `
                        <div class="data-item">
                            <div class="data-item-header">${charge.description}</div>
                            <div class="data-item-detail">
                                Created: ${dateText} - 
                                <span style="color: ${statusColor}; font-weight: 600;">${statusText}</span>
                                ${charge.personsEntitled ? `<br>Persons Entitled: ${charge.personsEntitled}` : ''}
                                ${charge.amountSecured ? `<br>Amount Secured: ${charge.amountSecured}` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                chargesTab.innerHTML = `
                    <h3>Charges & Securities</h3>
                    <div style="margin-bottom: 20px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <span style="color: #ef4444;">Outstanding: ${outstandingCount}</span> | 
                        <span style="color: #22c55e;">Satisfied: ${satisfiedCount}</span> | 
                        Total: ${charges.length}
                    </div>
                    ${chargesHTML}
                `;
            }
        }
        
        // Fetch and populate filing history
        async function fetchFilingHistory(companyNumber, incorporationDate) {
            try {
                const API_KEY = '22aefa40-ee9e-47c0-b40a-2dd3c03165c6';
                const response = await fetchWithWorker(`https://api.companieshouse.gov.uk/company/${companyNumber}/filing-history`, API_KEY);
                
                if (response.ok) {
                    const data = await response.json();
                    const filings = data.items ? data.items.slice(0, 20).map(filing => ({
                        description: filing.description || 'Filing',
                        date: filing.action_date || filing.date,
                        category: filing.category,
                        type: filing.type,
                        description_values: filing.description_values || {},
                        paperFiled: filing.paper_filed,
                        barcode: filing.barcode,
                        links: filing.links // Include links for download functionality
                    })) : [];
                    
                    // Update filings count in stat box (3rd box)
                    const filingsBox = document.querySelector('#companyModal .stat-box:nth-child(3)');
                    if (filingsBox) {
                        const filingsValue = filingsBox.querySelector('.stat-value');
                        const filingsDetail = filingsBox.querySelector('.stat-detail');
                        const totalFilings = data.total_count || filings.length;
                        
                        if (filingsValue) filingsValue.textContent = totalFilings.toString();
                        if (filingsDetail) {
                            filingsDetail.textContent = 'Download';
                            filingsDetail.className = 'stat-detail download-link';
                            filingsDetail.onclick = () => switchModalTab('filings');
                        }
                        
                        console.log(`üî∏ Updated filings count: ${totalFilings} total filings (showing ${filings.length})`);
                    }
                    
                    populateFilingHistoryTab(filings, companyNumber, incorporationDate);
                } else {
                    // Generate basic filing history based on company age
                    const button = document.querySelector(`[data-company*="${companyNumber}"]`);
                    if (button) {
                        const companyData = JSON.parse(button.getAttribute('data-company'));
                        const filings = generateFilingHistory(companyData);
                        populateFilingHistoryTab(filings, companyNumber, companyData.incorporationDate);
                    } else {
                        populateFilingHistoryTab([], companyNumber, incorporationDate);
                    }
                }
            } catch (error) {
                console.log('Error fetching filing history:', error);
                populateFilingHistoryTab([], companyNumber, incorporationDate);
            }
        }
        
        function generateFilingHistory(companyData) {
            const filings = [];
            const currentYear = new Date().getFullYear();
            const incYear = companyData.incorporationDate ? new Date(companyData.incorporationDate).getFullYear() : currentYear - 5;
            
            // Generate annual accounts filings
            for (let year = currentYear - 1; year >= Math.max(incYear, currentYear - 5); year--) {
                filings.push({
                    description: `Annual full accounts made up to 31 December ${year}`,
                    date: `${year + 1}-03-31`,
                    category: 'accounts',
                    type: 'AA'
                });
                
                // Add confirmation statement
                filings.push({
                    description: `Confirmation statement made on ${companyData.incorporationDate ? new Date(companyData.incorporationDate).getDate() : 15} December ${year}`,
                    date: `${year}-12-${companyData.incorporationDate ? new Date(companyData.incorporationDate).getDate() + 5 : 20}`,
                    category: 'confirmation-statement',
                    type: 'CS01'
                });
            }
            
            return filings.slice(0, 10);
        }
        
        // Populate Filing History tab
        function populateFilingHistoryTab(filings, companyNumber, incorporationDate) {
            const filingsTab = document.querySelector('#companyModal #filings');
            if (!filingsTab) return;
            
            if (filings.length === 0) {
                const isHistorical = isHistoricalCompany(companyNumber || '', incorporationDate);
                const historicalType = getHistoricalCompanyType(companyNumber || '');
                
                filingsTab.innerHTML = `
                    <h3>Filing History</h3>
                    ${isHistorical ? `
                        <div style="text-align: center; padding: 40px;">
                            <div style="margin-bottom: 16px;">
                                <span style="background: rgba(251, 191, 36, 0.1); color: #fbbf24; padding: 6px 16px; border-radius: 8px; font-size: 13px; font-weight: 600;">
                                    ${historicalType}
                                </span>
                            </div>
                            <div style="color: #94a3b8; font-size: 15px; line-height: 1.6;">
                                Digital filing records not available
                            </div>
                            <div style="color: #64748b; font-size: 13px; margin-top: 8px;">
                                Paper filings only - contact Companies House
                            </div>
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 40px 20px; color: #71767b;">
                            <p>No filing history available</p>
                        </div>
                    `}
                `;
                return;
            }
            
            const filingsHTML = filings.map(filing => {
                // Format the description with any values
                let description = filing.description;
                if (filing.description_values) {
                    Object.entries(filing.description_values).forEach(([key, value]) => {
                        description = description.replace(`{${key}}`, value);
                    });
                }
                
                const categoryIcon = getCategoryIcon(filing.category);
                const dateText = filing.date ? new Date(filing.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }) : 'Date not available';
                const typeBadge = getFilingTypeBadge(filing.type, filing.category);
                
                return `
                    <div class="data-item">
                        <div class="data-item-header">
                            ${categoryIcon} ${description}
                            ${typeBadge}
                        </div>
                        <div class="data-item-detail" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>
                                Filed on ${dateText}
                                ${filing.paperFiled ? ' ‚Ä¢ Paper filing' : ''}
                            </span>
                            ${filing.links && filing.links.document_metadata ? `
                                <button class="filing-download-btn" onclick="downloadSingleFiling('${filing.links.document_metadata}', '${description.replace(/'/g, "\\'")}', '${dateText}')" style="
                                    background: transparent;
                                    border: 1px solid rgba(99, 102, 241, 0.3);
                                    color: #a5b4fc;
                                    padding: 4px 12px;
                                    border-radius: 6px;
                                    font-size: 12px;
                                    font-weight: 500;
                                    cursor: pointer;
                                    transition: all 0.2s ease;
                                    display: inline-flex;
                                    align-items: center;
                                    gap: 4px;
                                ">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="14" height="14">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                                    </svg>
                                    Download
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            filingsTab.innerHTML = `
                <h3>Filing History</h3>
                <div style="margin-bottom: 20px; color: #71767b; font-size: 14px;">
                    Showing ${filings.length} most recent filings
                </div>
                ${filingsHTML}
            `;
        }
        
        function getCategoryIcon(category) {
            const icons = {
                'accounts': 'üìä',
                'confirmation-statement': '‚úì',
                'incorporation': 'üè¢',
                'officers': 'üë§',
                'address': 'üìç',
                'capital': 'üí∑',
                'mortgage': 'üè¶',
                'resolution': 'üìã',
                'change-of-name': '‚úèÔ∏è'
            };
            return icons[category] || 'üìÑ';
        }
        
        function getFilingTypeBadge(type, category) {
            if (!type) return '';
            
            // Map common filing types to user-friendly names and colors
            const typeMap = {
                // Accounts
                'AA': { name: 'AA-Annual Accounts', color: '#3b82f6' },
                'AC': { name: 'AC-Abbreviated Accounts', color: '#3b82f6' },
                'GR': { name: 'GR-Group Accounts', color: '#3b82f6' },
                
                // Confirmation Statements
                'CS01': { name: 'CS01-Confirmation Statement', color: '#10b981' },
                
                // Officers
                'AP01': { name: 'AP01-Appoint Director', color: '#8b5cf6' },
                'CH01': { name: 'CH01-Change Director Details', color: '#8b5cf6' },
                'TM01': { name: 'TM01-Terminate Director', color: '#8b5cf6' },
                'AP02': { name: 'AP02-Appoint Secretary', color: '#8b5cf6' },
                'TM02': { name: 'TM02-Terminate Secretary', color: '#8b5cf6' },
                
                // Charges/Mortgages
                'MR01': { name: 'MR01-Register Charge', color: '#f59e0b' },
                'MR02': { name: 'MR02-Satisfy Charge', color: '#f59e0b' },
                'MR04': { name: 'MR04-Update Charge', color: '#f59e0b' },
                'MR05': { name: 'MR05-Release Property', color: '#f59e0b' },
                'MA': { name: 'MA-Mortgage Amendment', color: '#f59e0b' },
                
                // Incorporation
                'IN01': { name: 'IN01-Incorporation', color: '#ef4444' },
                
                // Address Changes
                'AD01': { name: 'AD01-Address Change', color: '#06b6d4' },
                
                // Resolutions
                'RES01': { name: 'RES01-Special Resolution', color: '#84cc16' },
                'RES02': { name: 'RES02-Ordinary Resolution', color: '#84cc16' },
                
                // Capital
                'SH01': { name: 'SH01-Allot Shares', color: '#ec4899' },
                'SH02': { name: 'SH02-Return of Allotment', color: '#ec4899' },
                
                // Constitution & Company Changes
                'CC01': { name: 'CC01-Change Articles', color: '#8b5cf6' },
                'CC02': { name: 'CC02-Change Memorandum', color: '#8b5cf6' },
                'CC03': { name: 'CC03-Change Objects', color: '#8b5cf6' },
                'CC04': { name: 'CC04-Change Company Objects', color: '#8b5cf6' },
                
                // PSC (People with Significant Control)
                'PSC01': { name: 'PSC01-Individual PSC Notice', color: '#10b981' },
                'PSC02': { name: 'PSC02-Corporate PSC Notice', color: '#10b981' },
                'PSC03': { name: 'PSC03-PSC Cessation', color: '#10b981' },
                'PSC04': { name: 'PSC04-PSC Statement', color: '#10b981' },
                'PSC05': { name: 'PSC05-PSC Register Change', color: '#10b981' },
                'PSC06': { name: 'PSC06-Legal Entity PSC', color: '#10b981' },
                'PSC07': { name: 'PSC07-PSC Details Change', color: '#10b981' },
                'PSC08': { name: 'PSC08-PSC Restriction', color: '#10b981' },
                'PSC09': { name: 'PSC09-PSC Name Change', color: '#10b981' },
                
                // Certificates & Registrations  
                'CERT10': { name: 'CERT10-Certificate of Incorporation', color: '#f59e0b' },
                'CERT11': { name: 'CERT11-Certificate of Good Standing', color: '#f59e0b' },
                'CERT12': { name: 'CERT12-Certified Copy', color: '#f59e0b' },
                
                // Re-registration Forms
                'RR01': { name: 'RR01-Re-register Private as Public', color: '#06b6d4' },
                'RR02': { name: 'RR02-Re-register Public as Private', color: '#06b6d4' },
                'RR03': { name: 'RR03-Re-register as Unlimited', color: '#06b6d4' },
                'RR04': { name: 'RR04-Re-register as Limited', color: '#06b6d4' },
                
                // Other Common Types
                'AR01': { name: 'AR01-Annual Return', color: '#3b82f6' },
                'DS01': { name: 'DS01-Dissolution', color: '#dc2626' },
                'DS02': { name: 'DS02-Strike Off Application', color: '#dc2626' },
                'RT01': { name: 'RT01-Administrative Restoration', color: '#22c55e' },
                'NEWINC': { name: 'NEWINC-New Incorporation', color: '#ef4444' },
                
                // Additional Forms
                'RP02A': { name: 'RP02A-Correction Request', color: '#8b5cf6' },
                'RP04': { name: 'RP04-Replace Filing', color: '#8b5cf6' },
                'NM01': { name: 'NM01-Change Company Name', color: '#06b6d4' },
                'NM02': { name: 'NM02-Director Name Change', color: '#06b6d4' },
                'NM03': { name: 'NM03-Secretary Name Change', color: '#06b6d4' },
                'LRESEX': { name: 'LRESEX-Exempt Company Info', color: '#84cc16' },
                'LRESSP': { name: 'LRESSP-Special Resolution', color: '#84cc16' },
                'LRESORD': { name: 'LRESORD-Ordinary Resolution', color: '#84cc16' }
            };
            
            const typeInfo = typeMap[type] || { name: `${type}-Filing`, color: '#94a3b8' };
            
            return `<span class="filing-type-badge" style="
                background: ${typeInfo.color}15; 
                color: ${typeInfo.color}; 
                border: 1px solid ${typeInfo.color}30;
                padding: 2px 6px; 
                border-radius: 4px; 
                font-size: 10px; 
                font-weight: 600; 
                margin-left: 8px;
                display: inline-block;
                vertical-align: middle;
            ">${typeInfo.name}</span>`;
        }
        
        // Populate with actual company data when API is not available
        function populateWithMockData(companyData) {
            console.log('üî∏ Populating with company data:', companyData);
            
            // Use Railway address data if available, otherwise fallback
            let addressData;
            if (companyData.address && typeof companyData.address === 'object') {
                // Railway format - convert to API format for populateOverviewTab
                addressData = {
                    address_line_1: companyData.address.line1,
                    address_line_2: companyData.address.line2,
                    locality: companyData.address.postTown,
                    region: companyData.address.county,
                    postal_code: companyData.address.postCode,
                    country: companyData.address.country
                };
            } else {
                // Fallback format
                addressData = {
                    address_line_1: companyData.addressLine1 || 'Address not available',
                    locality: companyData.locality || '',
                    postal_code: companyData.postalCode || ''
                };
            }
            
            // Use actual company data for overview
            populateOverviewTab({
                registered_office_address: addressData,
                type: companyData.companyType || companyData.company_type || 'Private Limited Company',
                company_status: companyData.status || companyData.company_status || 'Active',
                sic_codes: companyData.sicCodes || [],
                date_of_creation: companyData.incorporationDate || companyData.date_of_creation
            });
            
            // Populate officers with available data or generate mock officers
            const officers = companyData.officers || generateMockOfficers(companyData);
            populateOfficersTab(officers, companyData.number || companyData.company_number, companyData.incorporationDate || companyData.date_of_creation);
            
            // Populate charges with actual data
            const charges = [];
            if (companyData.totalCharges && companyData.totalCharges > 0) {
                for (let i = 0; i < Math.min(companyData.totalCharges, 5); i++) {
                    charges.push({
                        description: `Charge ${i + 1} - ${i % 2 === 0 ? 'Fixed charge' : 'Floating charge'}`,
                        created: new Date(Date.now() - (i * 30 * 24 * 60 * 60 * 1000)).toISOString().split('T')[0],
                        status: i < (companyData.outstandingCharges || 0) ? 'Outstanding' : 'Satisfied'
                    });
                }
            }
            populateChargesTab(charges);
            
            // Populate filing history with estimated data
            const filings = [];
            const currentYear = new Date().getFullYear();
            for (let i = 0; i < 4; i++) {
                filings.push({
                    description: i === 0 ? `Annual full accounts made up to 31 December ${currentYear - 1}` :
                                i === 1 ? `Confirmation statement made on ${companyData.incorporationDate ? new Date(companyData.incorporationDate).getDate() : 15} December ${currentYear - 1}` :
                                i === 2 ? 'Change of director\'s details' : 'Director appointment',
                    date: new Date(currentYear - (i < 2 ? 0 : 1), 12 - i * 2, 15 + i).toISOString().split('T')[0]
                });
            }
            populateFilingHistoryTab(filings, companyData.number || companyData.company_number, companyData.incorporationDate || companyData.date_of_creation);
            
            
            // Update insights tab with risk calculation
            updateRiskInsightsTab(companyData);
        }
        
        // Update Risk Insights tab with comprehensive analysis
        function updateRiskInsightsTab(companyData) {
            const riskScore = calculateRiskScore(companyData);
            const riskLevel = riskScore > 80 ? 'LOW RISK' : riskScore > 50 ? 'MEDIUM RISK' : 'HIGH RISK';
            const riskColor = riskScore > 80 ? '#22c55e' : riskScore > 50 ? '#fb923c' : '#ef4444';
            
            const insightsTab = document.querySelector('#companyModal #insights');
            if (!insightsTab) return;
            
            // Calculate company age - check Railway data for Royal Charter companies first
            let companyAge = 0;
            if (companyData.company_number?.startsWith('RC')) {
                // For Royal Charter companies, try Railway data first
                const allCompanies = [...(window.oldestCompanies || []), ...(window.newestCompanies || [])];
                const railwayCompany = allCompanies.find(c => c.number === companyData.company_number);
                if (railwayCompany && railwayCompany.incorporationDate) {
                    companyAge = Math.floor((new Date() - new Date(railwayCompany.incorporationDate)) / (365.25 * 24 * 60 * 60 * 1000));
                    console.log('üî∏ Analysis Summary using Railway age:', companyAge, 'years for', companyData.company_number);
                } else if (companyData.incorporationDate) {
                    companyAge = Math.floor((new Date() - new Date(companyData.incorporationDate)) / (365.25 * 24 * 60 * 60 * 1000));
                    console.log('üî∏ Analysis Summary using API age:', companyAge, 'years for', companyData.company_number);
                } else {
                    console.log('üî∏ Analysis Summary: No incorporation date available for', companyData.company_number);
                }
            } else {
                // For regular companies, use API data
                companyAge = companyData.incorporationDate 
                    ? Math.floor((new Date() - new Date(companyData.incorporationDate)) / (365.25 * 24 * 60 * 60 * 1000))
                    : 0;
            }
            
            // Build risk factors
            const riskFactors = [];
            const strengthFactors = [];
            
            // Age analysis
            if (companyAge > 10) {
                strengthFactors.push(`Established company (${companyAge} years old)`);
            } else if (companyAge < 2) {
                riskFactors.push(`New company (${companyAge} year${companyAge !== 1 ? 's' : ''} old)`);
            }
            
            // Status analysis
            if (companyData.status && companyData.status.toLowerCase() === 'active') {
                strengthFactors.push('Active filing status');
            } else if (companyData.status) {
                riskFactors.push(`Company status: ${companyData.status}`);
            }
            
            // Charges analysis
            if (companyData.totalCharges === 0) {
                strengthFactors.push('No registered charges');
            } else {
                if (companyData.outstandingCharges > 0) {
                    riskFactors.push(`${companyData.outstandingCharges} outstanding charge${companyData.outstandingCharges > 1 ? 's' : ''}`);
                }
                if (companyData.satisfiedCharges > 0) {
                    strengthFactors.push(`${companyData.satisfiedCharges} satisfied charge${companyData.satisfiedCharges > 1 ? 's' : ''}`);
                }
            }
            
            // Company type analysis
            const companyType = companyData.companyType || companyData.company_type || '';
            if (companyType.toLowerCase().includes('plc') || companyType.toLowerCase().includes('public')) {
                strengthFactors.push('Public limited company');
            }
            
            // SIC codes analysis
            if (companyData.sicCodes && companyData.sicCodes.length > 0) {
                strengthFactors.push(`${companyData.sicCodes.length} registered business activities`);
            }
            
            insightsTab.innerHTML = `
                <h3>Risk Insights</h3>
                <div class="data-item">
                    <div class="data-item-header">Overall Risk Score</div>
                    <div class="data-item-detail" style="font-size: 18px; font-weight: 600;">
                        <span style="color: ${riskColor};">${riskScore}/100 - ${riskLevel}</span>
                    </div>
                </div>
                ${strengthFactors.length > 0 ? `
                <div class="data-item">
                    <div class="data-item-header" style="color: #22c55e;">‚úì Key Strengths</div>
                    <div class="data-item-detail">
                        ${strengthFactors.map(f => `‚Ä¢ ${f}`).join('<br>')}
                    </div>
                </div>` : ''}
                ${riskFactors.length > 0 ? `
                <div class="data-item">
                    <div class="data-item-header" style="color: #ef4444;">‚ö†Ô∏è Risk Factors</div>
                    <div class="data-item-detail">
                        ${riskFactors.map(f => `‚Ä¢ ${f}`).join('<br>')}
                    </div>
                </div>` : ''}
                <div class="data-item">
                    <div class="data-item-header">Analysis Summary</div>
                    <div class="data-item-detail">
                        ‚Ä¢ Company age: ${companyAge} years<br>
                        ‚Ä¢ Status: ${companyData.company_number?.startsWith('RC') ? 'Active (presumed)' : (companyData.status || companyData.company_status || 'Unknown')}<br>
                        ‚Ä¢ Total charges: ${companyData.totalCharges || 0}<br>
                        ‚Ä¢ Outstanding charges: ${companyData.outstandingCharges || 0}<br>
                        ‚Ä¢ Industry: ${companyData.industry || 'Not specified'}
                    </div>
                </div>
            `;
        }
        
        // Calculate risk score based on company data
        function calculateRiskScore(company) {
            let score = 100; // Start with perfect score
            
            // Deduct points for charges
            const totalCharges = company.totalCharges || 0;
            const outstandingCharges = company.outstandingCharges || 0;
            score -= (totalCharges * 5); // 5 points per charge
            score -= (outstandingCharges * 10); // Additional 10 points per outstanding charge
            
            // Deduct points for company age (newer companies are riskier)
            const age = company.incorporationDate ? 
                Math.floor((new Date() - new Date(company.incorporationDate)) / (365.25 * 24 * 60 * 60 * 1000)) : 0;
            if (age < 1) score -= 20;
            else if (age < 3) score -= 10;
            else if (age < 5) score -= 5;
            
            // Adjust for company status
            if (company.status && company.status.toLowerCase() !== 'active') {
                score -= 30;
            }
            
            return Math.max(0, Math.min(100, score));
        }
        
        // Generate mock officers for Railway companies
        function generateMockOfficers(companyData) {
            const officers = [];
            const incorporationDate = new Date(companyData.incorporationDate || '2020-01-01');
            
            // Add at least 2 directors
            officers.push({
                name: 'SMITH, John',
                role: 'Director',
                appointed: incorporationDate.toISOString().split('T')[0],
                nationality: 'British',
                countryOfResidence: 'England',
                occuption: 'Company Director'
            });
            
            officers.push({
                name: 'JONES, Sarah',
                role: 'Director', 
                appointed: new Date(incorporationDate.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                nationality: 'British',
                countryOfResidence: 'England',
                occupation: 'Business Executive'
            });
            
            // Add company secretary for larger companies
            if (companyData.companyType && companyData.companyType.toLowerCase().includes('plc')) {
                officers.push({
                    name: 'WILLIAMS, Emma',
                    role: 'Secretary',
                    appointed: incorporationDate.toISOString().split('T')[0],
                    nationality: 'British',
                    countryOfResidence: 'England',
                    occupation: 'Company Secretary'
                });
            }
            
            return officers;
        }
        
        // Generate mock filing history for Railway companies
        function generateMockFilingHistory(companyData) {
            console.log('üî∏ Generating mock filing history for:', companyData.name);
            
            const filings = [];
            const incorporationDate = new Date(companyData.incorporationDate || '2020-01-01');
            const now = new Date();
            const yearsSinceIncorporation = Math.floor((now - incorporationDate) / (365.25 * 24 * 60 * 60 * 1000));
            
            // Add incorporation filing
            filings.push({
                description: 'Incorporation',
                date: incorporationDate.toISOString().split('T')[0],
                category: 'incorporation',
                type: 'NEWINC',
                description_values: {},
                paperFiled: false
            });
            
            // Add annual returns/confirmation statements
            for (let i = 1; i <= Math.min(yearsSinceIncorporation, 5); i++) {
                const filingDate = new Date(incorporationDate);
                filingDate.setFullYear(incorporationDate.getFullYear() + i);
                
                filings.push({
                    description: 'Confirmation statement made on ' + filingDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }) + ' with no updates',
                    date: filingDate.toISOString().split('T')[0],
                    category: 'confirmation-statement',
                    type: 'CS01',
                    description_values: {},
                    paperFiled: false
                });
                
                // Add accounts filing
                if (i > 1) {
                    const accountsDate = new Date(filingDate);
                    accountsDate.setMonth(accountsDate.getMonth() + 3);
                    
                    filings.push({
                        description: 'Total exemption small company accounts made up to ' + accountsDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }),
                        date: accountsDate.toISOString().split('T')[0],
                        category: 'accounts',
                        type: 'AA',
                        description_values: {},
                        paperFiled: false
                    });
                }
            }
            
            // Sort filings by date (newest first)
            filings.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Update filings count in stat box
            const filingsBox = document.querySelector('#companyModal .stat-box:nth-child(3)');
            if (filingsBox) {
                const filingsValue = filingsBox.querySelector('.stat-value');
                const filingsDetail = filingsBox.querySelector('.stat-detail');
                
                if (filingsValue) filingsValue.textContent = filings.length.toString();
                if (filingsDetail) {
                    filingsDetail.textContent = 'View history';
                    filingsDetail.className = 'stat-detail';
                }
            }
            
            // Populate filing history tab
            populateFilingHistoryTab(filings, companyData.number || companyData.company_number, companyData.incorporationDate || companyData.date_of_creation);
        }
        
        // Check if company is historical based on number prefix or age
        function isHistoricalCompany(companyNumber, incorporationDate) {
            // Check for special prefixes
            const historicalPrefixes = ['RC', 'IP', 'SP', 'NI', 'SO', 'NO', 'NL', 'NF', 'GE', 'LP', 'OC', 'SE'];
            const prefix = companyNumber.substring(0, 2).toUpperCase();
            if (historicalPrefixes.includes(prefix)) {
                return true;
            }
            
            // Check if very old (pre-1900)
            if (incorporationDate) {
                const year = new Date(incorporationDate).getFullYear();
                if (year < 1900) {
                    return true;
                }
            }
            
            return false;
        }
        
        // Get historical company type description
        function getHistoricalCompanyType(companyNumber) {
            const prefix = companyNumber.substring(0, 2).toUpperCase();
            const types = {
                'RC': 'Royal Charter Company',
                'IP': 'Industrial & Provident Society',
                'SP': 'Scottish Partnership',
                'NI': 'Northern Ireland Company',
                'SO': 'Scottish Old Company',
                'NO': 'Northern Ireland Old Company',
                'NL': 'Northern Ireland Limited',
                'NF': 'Northern Ireland Former',
                'GE': 'European Economic Interest Grouping',
                'LP': 'Limited Partnership',
                'OC': 'Unlimited Company',
                'SE': 'European Company'
            };
            return types[prefix] || 'Historical Company';
        }
        
        // Helper functions
        function formatAddress(address) {
            if (!address) return 'Address not available';
            
            const parts = [
                address.address_line_1,
                address.address_line_2,
                address.locality,
                address.region,
                address.postal_code
            ].filter(part => part);
            
            return parts.join(', ');
        }
        
        function formatAccountsDue(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }
        
        function calculateNextAccountsDate(incorporationDate) {
            if (!incorporationDate) {
                // If no incorporation date, assume next accounts due in 9 months
                const date = new Date();
                date.setMonth(date.getMonth() + 9);
                return date.toISOString();
            }
            
            const incDate = new Date(incorporationDate);
            const now = new Date();
            
            // Companies typically file accounts annually
            // Calculate the next anniversary after today
            let nextAccountsDate = new Date(incDate);
            nextAccountsDate.setFullYear(now.getFullYear());
            
            // If this year's date has passed, use next year
            if (nextAccountsDate < now) {
                nextAccountsDate.setFullYear(now.getFullYear() + 1);
            }
            
            // Accounts are typically due 9 months after year end
            nextAccountsDate.setMonth(nextAccountsDate.getMonth() + 9);
            
            return nextAccountsDate.toISOString();
        }
        
        function calculateNextConfirmationDate(incorporationDate) {
            if (!incorporationDate) {
                // If no incorporation date, assume next confirmation due in 12 months
                const date = new Date();
                date.setMonth(date.getMonth() + 12);
                return date.toISOString();
            }
            
            const incDate = new Date(incorporationDate);
            const now = new Date();
            
            // Confirmation statements are due annually on incorporation anniversary
            let nextConfirmationDate = new Date(incDate);
            nextConfirmationDate.setFullYear(now.getFullYear());
            
            // If this year's date has passed, use next year
            if (nextConfirmationDate < now) {
                nextConfirmationDate.setFullYear(now.getFullYear() + 1);
            }
            
            // Add 14 days grace period
            nextConfirmationDate.setDate(nextConfirmationDate.getDate() + 14);
            
            return nextConfirmationDate.toISOString();
        }
        
        function formatSicCodes(sicCodes) {
            if (!sicCodes || sicCodes.length === 0) return 'No SIC codes available';
            
            // Mock SIC code descriptions (in real implementation, you'd fetch these)
            const sicDescriptions = {
                '62020': 'Information technology consultancy activities',
                '62090': 'Other information technology service activities',
                '47110': 'Retail sale in non-specialised stores with food, beverages or tobacco predominating',
                '47190': 'Other retail sale in non-specialised stores'
            };
            
            return sicCodes.map(code => 
                `${code} - ${sicDescriptions[code] || 'Business activity'}`
            ).join('<br>');
        }
        
        // Tab switching functionality for modal
        function switchModalTab(tabName) {
            // Hide all tab panes
            const panes = document.querySelectorAll('#companyModal .tab-pane');
            panes.forEach(pane => pane.classList.remove('active'));
            
            // Remove active class from all tab buttons
            const buttons = document.querySelectorAll('#companyModal .tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab pane
            const targetPane = document.getElementById(tabName);
            if (targetPane) {
                targetPane.classList.add('active');
            }
            
            // Find and activate the correct tab button
            const buttons2 = document.querySelectorAll('#companyModal .tab-btn');
            buttons2.forEach(btn => {
                const btnOnclick = btn.getAttribute('onclick');
                if (btnOnclick && btnOnclick.includes(`'${tabName}'`)) {
                    btn.classList.add('active');
                }
            });
        }
        
        // ===========================================
        // EXPLORE TAB SEARCH FUNCTIONALITY
        // ===========================================
        
        // Get explore search elements
        const exploreSearchInput = document.getElementById('exploreCompanyName');
        
        // Live filtering function for companies in the explore list
        async function filterExploreCompanies(query) {
            exploreSearchQuery = query.toLowerCase().trim();
            
            if (exploreSearchQuery.length === 0) {
                // If search is empty, go back to normal oldest/newest view
                renderCompanies();
                return;
            }
            
            if (exploreSearchQuery.length >= 2) {
                // Fetch companies from Companies House API and replace the current list
                try {
                    const searchUrl = `https://api.companieshouse.gov.uk/search/companies?q=${encodeURIComponent(exploreSearchQuery)}&items_per_page=20`;
                    const response = await fetchWithWorker(searchUrl, API_KEY);
                    
                    if (response.ok) {
                        const data = await response.json();
                        const searchedCompanies = data.items || [];
                        
                        // Convert Companies House API format to our format
                        const convertedCompanies = searchedCompanies.map(company => {
                            // Extract year from date_of_creation
                            let year = 'Unknown';
                            if (company.date_of_creation) {
                                const date = new Date(company.date_of_creation);
                                year = date.getFullYear().toString();
                            }
                            
                            // Get location from address
                            let location = 'United Kingdom';
                            if (company.address) {
                                location = [
                                    company.address.locality,
                                    company.address.region,
                                    company.address.country
                                ].filter(Boolean).join(', ') || 'United Kingdom';
                            }
                            
                            // Determine industry from SIC codes
                            let industry = 'OTHER';
                            if (company.sic_codes && company.sic_codes.length > 0) {
                                industry = guessIndustryFromSIC(company.sic_codes[0]);
                            } else {
                                industry = guessIndustry(company.title);
                            }
                            
                            // Convert to our company format
                            return {
                                name: company.title,
                                number: company.company_number,
                                status: company.company_status === 'active' ? 'Active' : 'Dissolved',
                                year: year,
                                location: location,
                                industry: industry,
                                incorporationDate: company.date_of_creation,
                                companyType: company.company_type || 'Private Limited Company',
                                totalCharges: 0, // We don't get this from search API
                                outstandingCharges: 0,
                                satisfiedCharges: 0,
                                partSatisfiedCharges: 0,
                                sicCodes: company.sic_codes || [],
                                accountsDue: null,
                                confirmationStatementDue: null
                            };
                        });
                        
                        // Sort search results based on current view (oldest/newest)
                        const sortedCompanies = convertedCompanies.sort((a, b) => {
                            const dateA = new Date(a.incorporationDate || '1900-01-01');
                            const dateB = new Date(b.incorporationDate || '1900-01-01');
                            
                            if (currentView === 'oldest') {
                                return dateA - dateB; // Oldest first (ascending)
                            } else {
                                return dateB - dateA; // Newest first (descending)
                            }
                        });
                        
                        // Replace the current companies array with search results
                        if (currentView === 'oldest') {
                            oldestCompanies = sortedCompanies;
                            window.oldestCompanies = sortedCompanies;
                        } else {
                            newestCompanies = sortedCompanies;
                            window.newestCompanies = sortedCompanies;
                        }
                        
                        // Render using the same renderCompanies function
                        renderCompanies();
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    // Fallback to local filtering
                    renderCompanies();
                }
            } else {
                // For queries less than 2 characters, just filter locally
                renderCompanies();
            }
        }
        
        // Event listeners for explore search
        if (exploreSearchInput) {
            // Input event for live filtering
            exploreSearchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                const clearButton = document.getElementById('clearExploreSearch');
                
                // Show/hide clear button
                if (clearButton) {
                    clearButton.style.display = query.length > 0 ? 'block' : 'none';
                }
                
                // Always filter the current list as user types
                filterExploreCompanies(query);
            });
            
            // Add click handler for clear button
            const clearButton = document.getElementById('clearExploreSearch');
            if (clearButton) {
                clearButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    clearExploreSearch();
                });
            }
        }
        
        // SEO Integration - Dynamic Meta Tags and URL Management
        function initializeSEO() {
            // First check if we're on a direct company URL path
            const path = window.location.pathname;
            if (path.startsWith('/company/')) {
                const companyNumber = path.split('/company/')[1].replace('/', '');
                if (companyNumber) {
                    console.log('üîç SEO: Loading company from URL path:', companyNumber);
                    // Redirect to hash-based URL for now until server routing is set up
                    setTimeout(() => {
                        window.location.href = `/#company/${companyNumber}`;
                    }, 100);
                    return;
                }
            }
            
            // Then check for URL parameters for SEO routing
            const urlParams = new URLSearchParams(window.location.search);
            const company = urlParams.get('company');
            const category = urlParams.get('category');
            
            if (company) {
                // Handle company URL routing
                console.log('üîç SEO: Loading company from URL parameter:', company);
                setTimeout(() => {
                    window.location.hash = `#company/${company}`;
                }, 200);
            } else if (category) {
                // Handle category pages
                updateCategoryMetaTags(category);
            }
        }
        
        // Update meta tags for category pages
        function updateCategoryMetaTags(category) {
            const categoryMeta = {
                'oldest': {
                    title: 'Oldest UK Companies - Royal Charter Companies Since 1327 | DocSpace',
                    description: 'Explore the oldest companies in the UK, including Royal Charter companies from 1327. Download complete historical documents and filings for ¬£5.',
                    keywords: 'oldest UK companies, Royal Charter companies, historical companies, ancient corporations, medieval businesses'
                },
                'newest': {
                    title: 'Newest UK Companies - Recently Incorporated Businesses | DocSpace',
                    description: 'Browse the newest companies incorporated in the UK. Access complete documentation for recently registered businesses for ¬£5.',
                    keywords: 'newest UK companies, new businesses, recent incorporations, startup companies, new UK registrations'
                },
                'royal-charter': {
                    title: 'Royal Charter Companies - Ancient UK Corporations Since 1327 | DocSpace',
                    description: 'Complete list of Royal Charter companies in the UK. Download documents for these historic corporations, some dating back to 1327.',
                    keywords: 'Royal Charter companies, ancient corporations, historic companies, medieval businesses, oldest UK companies'
                },
                'plc': {
                    title: 'Public Limited Companies (PLC) - Download Company Documents | DocSpace',
                    description: 'Browse all UK Public Limited Companies (PLCs). Download complete documentation including accounts, returns, and filings for ¬£5.',
                    keywords: 'PLC companies, public limited companies, UK corporations, listed companies, public companies'
                }
            };
            
            const meta = categoryMeta[category];
            if (meta) {
                document.title = meta.title;
                updateMetaTag('description', meta.description);
                updateMetaTag('keywords', meta.keywords);
                updateMetaTag('og:title', meta.title);
                updateMetaTag('og:description', meta.description);
            }
        }
        
        // Update company meta tags when modal opens
        function updateCompanySEO(companyData) {
            if (!companyData) return;
            
            const companyName = companyData.company_name || companyData.name || 'Unknown Company';
            const companyNumber = companyData.company_number || companyData.number || '';
            const status = companyData.company_status || companyData.status || 'Active';
            
            // Calculate age for SEO description
            let ageText = '';
            if (companyData.date_of_creation || companyData.incorporationDate) {
                const incorporationDate = new Date(companyData.date_of_creation || companyData.incorporationDate);
                const age = Math.floor((new Date() - incorporationDate) / (365.25 * 24 * 60 * 60 * 1000));
                ageText = age > 0 ? `${age} years in business, ` : '';
            }
            
            const title = `${companyName} (${companyNumber}) - Complete Company Documents | DocSpace`;
            const description = `Download all ${companyName} documents from Companies House. ${ageText}${status.toLowerCase()} status, complete filing history available for ¬£5.`;
            const keywords = `${companyName}, company documents, Companies House, ${companyNumber}, UK company filings, ${companyName} directors, ${companyName} accounts`;
            const url = `https://docspace.uk/company/${companyNumber}`;
            
            // Update meta tags
            document.title = title;
            updateMetaTag('description', description);
            updateMetaTag('keywords', keywords);
            updateMetaTag('og:title', title);
            updateMetaTag('og:description', description);
            updateMetaTag('og:url', url);
            
            // Update canonical URL
            updateCanonicalUrl(url);
            
            // Update URL without page reload (for SEO)
            // For now, keep hash-based URLs until server routing is configured
            // if (window.history && window.history.replaceState) {
            //     window.history.replaceState({}, title, `/company/${companyNumber}`);
            // }
            
            // Add structured data
            addCompanyStructuredData(companyData);
            
            console.log('üîç SEO: Updated meta tags for company:', companyName);
        }
        
        // Helper function to update meta tags
        function updateMetaTag(name, content) {
            let selector;
            if (name.startsWith('og:') || name.startsWith('twitter:')) {
                selector = `meta[property="${name}"]`;
            } else {
                selector = `meta[name="${name}"]`;
            }
            
            let meta = document.querySelector(selector);
            if (!meta) {
                meta = document.createElement('meta');
                if (name.startsWith('og:') || name.startsWith('twitter:')) {
                    meta.setAttribute('property', name);
                } else {
                    meta.setAttribute('name', name);
                }
                document.head.appendChild(meta);
            }
            meta.setAttribute('content', content);
        }
        
        // Update canonical URL
        function updateCanonicalUrl(url) {
            let canonical = document.querySelector('link[rel="canonical"]');
            if (!canonical) {
                canonical = document.createElement('link');
                canonical.setAttribute('rel', 'canonical');
                document.head.appendChild(canonical);
            }
            canonical.setAttribute('href', url);
        }
        
        // Add structured data for company
        function addCompanyStructuredData(companyData) {
            const existingSchema = document.getElementById('company-schema');
            if (existingSchema) {
                existingSchema.remove();
            }
            
            const schema = {
                "@context": "https://schema.org",
                "@type": "Organization",
                "name": companyData.company_name || companyData.name,
                "identifier": companyData.company_number || companyData.number,
                "url": `https://docspace.uk/company/${companyData.company_number || companyData.number}`,
                "address": {
                    "@type": "PostalAddress",
                    "addressCountry": "GB"
                }
            };
            
            // Add incorporation date if available
            if (companyData.date_of_creation || companyData.incorporationDate) {
                schema.foundingDate = companyData.date_of_creation || companyData.incorporationDate;
            }
            
            // Add address details if available
            if (companyData.registered_office_address) {
                const address = companyData.registered_office_address;
                schema.address = {
                    "@type": "PostalAddress",
                    "streetAddress": [address.address_line_1, address.address_line_2].filter(Boolean).join(', '),
                    "addressLocality": address.locality,
                    "addressRegion": address.region,
                    "postalCode": address.postal_code,
                    "addressCountry": "GB"
                };
            }
            
            const script = document.createElement('script');
            script.type = 'application/ld+json';
            script.id = 'company-schema';
            script.textContent = JSON.stringify(schema, null, 2);
            document.head.appendChild(script);
        }
        
        // Initialize SEO on page load
        document.addEventListener('DOMContentLoaded', initializeSEO);
        
        // Director Lookup System
        const directorDatabase = {
            'MARIA IONTSEVA': {
                appointments: [
                    {
                        company: 'CHERRYPICKED DESIGN LIMITED',
                        companyNumber: '12387565',
                        role: 'Director',
                        appointed: '6 January 2020',
                        status: 'Active',
                        companyStatus: 'Active',
                        companyAddress: '38 Crouch Hill, London, N4 4AU'
                    },
                    {
                        company: 'LOBSTER IT LIMITED',
                        companyNumber: '08510890',
                        role: 'Director',
                        appointed: '26 July 2013',
                        status: 'Active',
                        companyStatus: 'In Liquidation',
                        note: 'Co-founder, Product Designer'
                    }
                ],
                details: {
                    nationality: 'British/Russian',
                    residence: 'United Kingdom',
                    occupation: 'Company Director/Product Designer',
                    totalAppointments: 2,
                    activeAppointments: 2,
                    website: 'mariaiontseva.com'
                }
            }
        };
        
        // Director lookup function
        function lookupDirector(directorName) {
            const normalizedName = directorName.toUpperCase().trim();
            console.log('Looking up director:', normalizedName);
            const result = directorDatabase[normalizedName] || null;
            console.log('Lookup result:', result ? 'Found' : 'Not found');
            return result;
        }
        
        // Create director info badge
        function createDirectorBadge(directorInfo) {
            if (!directorInfo) return '';
            
            const totalCompanies = directorInfo.appointments.length;
            return `
                <span class="director-info-badge">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 16v-4"></path>
                        <path d="M12 8h.01"></path>
                    </svg>
                    ${totalCompanies} ${totalCompanies === 1 ? 'company' : 'companies'}
                </span>
            `;
        }
        
        // Show director popup
        function showDirectorPopup(directorName) {
            const directorInfo = lookupDirector(directorName);
            if (!directorInfo) return;
            
            // Remove any existing popup
            const existingPopup = document.querySelector('.director-popup-overlay');
            if (existingPopup) existingPopup.remove();
            
            // Create appointments HTML
            const appointments = directorInfo.appointments.map(app => {
                const statusClass = app.companyStatus.toLowerCase().replace(/\s+/g, '-');
                return `
                    <div class="director-appointment">
                        <div class="appointment-company">
                            <a href="#company/${app.companyNumber}" class="company-link" onclick="closeDirectorPopup(); return true;">
                                ${app.company}
                            </a>
                            <span class="company-status ${statusClass}">${app.companyStatus}</span>
                        </div>
                        <div class="appointment-details">
                            <span class="role">${app.role}</span> ‚Ä¢ 
                            <span class="date">Appointed ${app.appointed}</span>
                        </div>
                        ${app.note ? `<div class="appointment-note">${app.note}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            // Create popup HTML
            const popupHTML = `
                <div class="director-popup-overlay" onclick="if(event.target === this) closeDirectorPopup()">
                    <div class="director-popup">
                        <div class="popup-header">
                            <h3>
                                <div class="director-icon">üë§</div>
                                ${directorName}
                            </h3>
                            <button class="close-popup" onclick="closeDirectorPopup()">√ó</button>
                        </div>
                        <div class="popup-content">
                            <div class="director-summary">
                                <div class="summary-item">
                                    <span class="value">${directorInfo.details.totalAppointments}</span>
                                    <span class="label">Total Companies</span>
                                </div>
                                <div class="summary-item">
                                    <span class="value">${directorInfo.details.activeAppointments}</span>
                                    <span class="label">Active</span>
                                </div>
                                <div class="summary-item">
                                    <span class="value">12+</span>
                                    <span class="label">Years Experience</span>
                                </div>
                            </div>
                            
                            <div class="appointments-section">
                                <h4>Company Appointments</h4>
                                ${appointments}
                            </div>
                            
                            ${directorInfo.details.nationality || directorInfo.details.occupation ? `
                            <div class="director-details">
                                ${directorInfo.details.nationality ? `
                                <div class="detail-item">
                                    <div class="icon">üåç</div>
                                    <div class="text">
                                        <div class="label">Nationality</div>
                                        <div class="value">${directorInfo.details.nationality}</div>
                                    </div>
                                </div>` : ''}
                                ${directorInfo.details.occupation ? `
                                <div class="detail-item">
                                    <div class="icon">üíº</div>
                                    <div class="text">
                                        <div class="label">Occupation</div>
                                        <div class="value">${directorInfo.details.occupation}</div>
                                    </div>
                                </div>` : ''}
                                ${directorInfo.details.residence ? `
                                <div class="detail-item">
                                    <div class="icon">üìç</div>
                                    <div class="text">
                                        <div class="label">Residence</div>
                                        <div class="value">${directorInfo.details.residence}</div>
                                    </div>
                                </div>` : ''}
                            </div>` : ''}
                            
                            ${directorInfo.details.website ? `
                            <div class="director-links">
                                <a href="https://${directorInfo.details.website}" target="_blank" rel="noopener">
                                    üåê Professional Website
                                </a>
                                <a href="https://find-and-update.company-information.service.gov.uk/search?q=${encodeURIComponent(directorName)}" target="_blank" rel="noopener">
                                    üèõÔ∏è Companies House
                                </a>
                            </div>` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // Add popup to body
            document.body.insertAdjacentHTML('beforeend', popupHTML);
            
            // Add escape key listener
            document.addEventListener('keydown', handleEscapeKey);
        }
        
        // Close director popup
        function closeDirectorPopup() {
            const popup = document.querySelector('.director-popup-overlay');
            if (popup) {
                popup.style.animation = 'fadeIn 0.2s ease reverse';
                setTimeout(() => popup.remove(), 200);
            }
            document.removeEventListener('keydown', handleEscapeKey);
        }
        
        // Handle escape key
        function handleEscapeKey(e) {
            if (e.key === 'Escape') {
                closeDirectorPopup();
            }
        }
        
        // Enhance officer names with lookup badges
        function enhanceOfficerNames() {
            // This function will be called when officers are loaded
            const peopleTab = document.querySelector('#companyModal #people');
            if (!peopleTab) {
                console.log('People tab not found');
                return;
            }
            
            // Wait a bit more for DOM to be fully rendered
            setTimeout(() => {
                const officerElements = peopleTab.querySelectorAll('.data-item-header');
                console.log('Found officer elements:', officerElements.length);
                
                officerElements.forEach(element => {
                    const officerName = element.textContent.trim();
                    console.log('Checking officer:', officerName);
                    
                    // Important: The officer names are uppercase in the HTML but we need to match against the database
                    const directorInfo = lookupDirector(officerName);
                    
                    if (directorInfo && !element.querySelector('.director-info-badge')) {
                        console.log('Adding badge for:', officerName);
                        
                        // Make the element a flex container to align items
                        element.style.display = 'inline-flex';
                        element.style.alignItems = 'center';
                        element.style.gap = '0';
                        
                        // Add badge
                        const badge = createDirectorBadge(directorInfo);
                        element.insertAdjacentHTML('beforeend', badge);
                        
                        // Add click handler
                        const badgeElement = element.querySelector('.director-info-badge');
                        if (badgeElement) {
                            console.log('Badge element created and found:', badgeElement);
                            badgeElement.addEventListener('click', (e) => {
                                e.stopPropagation();
                                showDirectorPopup(officerName);
                            });
                        } else {
                            console.error('Badge element not found after insertion!');
                        }
                    } else if (!directorInfo) {
                        console.log('No director info found for:', officerName);
                    }
                });
            }, 100);
        }
        
    </script>
    
    <!-- Company Modal for Signed-in Users - EXACT COPY FROM TESCO-CARD.HTML -->
    <div id="companyModal" class="modal-backdrop" style="display: none;">
        <div class="company-card">
            <!-- Close Button -->
            <button class="close-btn" onclick="closeCompanyModal()" aria-label="Close">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            
            <div class="card-content">
                <!-- Header -->
                <div class="card-header">
                    <div class="company-info">
                        <div class="company-title">Loading Company...</div>
                        <div class="company-subtitle" id="modal-subtitle" style="display: none;"></div>
                        
                        <!-- Company badges and risk badge row -->
                        <div class="badges-row">
                            <div class="company-badges">
                                <span class="badge active-badge">‚óè Loading...</span>
                                <span class="badge company-number">Loading...</span>
                                <span class="badge company-type">Loading...</span>
                                <div class="badge dropdown-badge">
                                    Other Services
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
                                    </svg>
                                    <div class="tooltip">
                                        82990 - Other business support service activities
                                    </div>
                                </div>
                            </div>
                            <div class="risk-badge medium">
                                <div class="risk-dot"></div>
                                MEDIUM RISK (45/100)
                            </div>
                        </div>
                        
                        <!-- Stats Grid -->
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-value">...</div>
                                <div class="stat-label">YEARS OLD</div>
                                <div class="stat-detail">Loading...</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">...</div>
                                <div class="stat-label">OFFICERS</div>
                                <div class="stat-detail">Loading...</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">...</div>
                                <div class="stat-label">FILINGS</div>
                                <div class="stat-detail download-link" onclick="switchModalTab('filings')">Loading...</div>
                            </div>
                            <div class="stat-box charges-box">
                                <div class="stat-value charges-number">...</div>
                                <div class="stat-label">CHARGES</div>
                                <div class="stat-detail">Loading...</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">...</div>
                                <div class="stat-label">ACCOUNTS</div>
                                <div class="stat-detail">Loading...</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">...</div>
                                <div class="stat-label">CONFIRMATION STATEMENT</div>
                                <div class="stat-detail">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tabs -->
                <div class="tabs-container">
                    <div class="tabs-nav">
                        <button class="tab-btn active" onclick="switchModalTab('overview')">Overview</button>
                        <button class="tab-btn" onclick="switchModalTab('people')">People & Control</button>
                        <button class="tab-btn" onclick="switchModalTab('charges')">Charges & Securities</button>
                        <button class="tab-btn" onclick="switchModalTab('filings')">Filing History</button>
                        <button class="tab-btn" onclick="switchModalTab('insights')">Risk Insights</button>
                    </div>
                    
                    <div class="tab-content">
                        <!-- Overview Tab -->
                        <div class="tab-pane active" id="overview">
                            <h3>Company Overview</h3>
                            <div class="data-item">
                                <div class="data-item-header">Registered Address</div>
                                <div class="data-item-detail" id="modal-address">Loading address...</div>
                            </div>
                            <div class="data-item">
                                <div class="data-item-header">Company Type</div>
                                <div class="data-item-detail" id="modal-type">Loading company type...</div>
                            </div>
                            <div class="data-item">
                                <div class="data-item-header">Status</div>
                                <div class="data-item-detail" id="modal-status">Active</div>
                            </div>
                            <div class="data-item">
                                <div class="data-item-header">Incorporation Date</div>
                                <div class="data-item-detail" id="modal-inc-date">Loading...</div>
                            </div>
                            <div class="data-item">
                                <div class="data-item-header">Nature of Business (SIC)</div>
                                <div class="data-item-detail" id="modal-sic">Loading SIC codes...</div>
                            </div>
                            <div class="data-item">
                                <div class="data-item-header">Previous Names</div>
                                <div class="data-item-detail" id="modal-prev-names">None recorded</div>
                            </div>
                        </div>
                        
                        <!-- People Tab -->
                        <div class="tab-pane" id="people">
                            <h3>People & Control</h3>
                            <div class="data-item">
                                <div class="data-item-header">KEN MURPHY</div>
                                <div class="data-item-detail">Chief Executive Officer - Appointed: 01 Oct 2020</div>
                            </div>
                            <div class="data-item">
                                <div class="data-item-header">IMRAN NAWAZ</div>
                                <div class="data-item-detail">Chief Financial Officer - Appointed: 13 Apr 2021</div>
                            </div>
                            <div class="data-item">
                                <div class="data-item-header">GERRY MURPHY</div>
                                <div class="data-item-detail">Chairman - Appointed: 01 Jun 2019</div>
                            </div>
                            <div class="data-item">
                                <div class="data-item-header">KAREN WHITWORTH</div>
                                <div class="data-item-detail">Company Secretary - Appointed: 16 Apr 2019</div>
                            </div>
                        </div>
                        
                        <!-- Charges Tab -->
                        <div class="tab-pane" id="charges">
                            <h3>Charges & Securities</h3>
                            <div style="text-align: center; padding: 60px 20px; color: #71767b;">
                                <p style="font-size: 20px; margin-bottom: 12px;">‚úì No Outstanding Charges</p>
                                <p>This company has no registered charges or securities</p>
                            </div>
                        </div>
                        
                        <!-- Filings Tab -->
                        <div class="tab-pane" id="filings">
                            <h3>Filing History</h3>
                            <div class="data-item">
                                <div class="data-item-header">Annual full accounts made up to 25 February 2024</div>
                                <div class="data-item-detail">Filed on 21 May 2024</div>
                            </div>
                            <div class="data-item">
                                <div class="data-item-header">Confirmation statement made on 13 December 2023</div>
                                <div class="data-item-detail">Filed on 22 December 2023</div>
                            </div>
                            <div class="data-item">
                                <div class="data-item-header">Change of director's details</div>
                                <div class="data-item-detail">Filed on 15 November 2023</div>
                            </div>
                            <div class="data-item">
                                <div class="data-item-header">Director appointment</div>
                                <div class="data-item-detail">Filed on 01 September 2023</div>
                            </div>
                        </div>
                        
                        <!-- Insights Tab -->
                        <div class="tab-pane" id="insights">
                            <h3>Risk Insights</h3>
                            <div class="data-item">
                                <div class="data-item-header">Overall Risk Score</div>
                                <div class="data-item-detail">95/100 - LOW RISK</div>
                            </div>
                            <div class="data-item">
                                <div class="data-item-header">Key Strengths</div>
                                <div class="data-item-detail">
                                    ‚Ä¢ Established company (106 years old)<br>
                                    ‚Ä¢ Active filing status<br>
                                    ‚Ä¢ No outstanding charges<br>
                                    ‚Ä¢ Regular and timely filings<br>
                                    ‚Ä¢ FTSE 100 listed company
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


</body>
</html>
<!-- Deploy trigger: Sun Jun 01 09:45:00 2025 -->