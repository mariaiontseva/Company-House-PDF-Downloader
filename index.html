<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Companies House Document Downloader - Download UK Company Filings | DocSpace</title>
    
    <!-- Primary Meta Tags -->
    <meta name="title" content="Companies House Document Downloader - Download UK Company Filings | DocSpace">
    <meta name="description" content="Download all Companies House documents and filings for any UK company as a ZIP file. Fast, reliable service for just £5 per company. Access annual returns, accounts, incorporation documents and more. Instant access to official UK company records.">
    <meta name="keywords" content="companies house documents, uk company filings, download company documents, companies house pdf, annual returns, company accounts, incorporation documents, uk business documents, docspace, companies house api, ch direct, company reports uk, business filings uk, corporate documents, statutory filings, limited company documents, plc filings, company registration documents">
    <meta name="author" content="DocSpace UK">
    <meta name="robots" content="index, follow">
    <meta name="language" content="English">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://docspace.uk/">
    
    <!-- Web App Manifest -->
    <!-- <link rel="manifest" href="/manifest.json"> -->
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236366f1' stroke-width='2'%3E%3Cpath d='M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4'/%3E%3C/svg%3E">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://docspace.uk/">
    <meta property="og:title" content="Companies House Document Downloader - Download UK Company Filings">
    <meta property="og:description" content="Download all Companies House documents for any UK company. Fast, reliable service for just £5 per company download.">
    <!-- <meta property="og:image" content="https://docspace.uk/og-image.png"> -->
    <meta property="og:site_name" content="DocSpace UK">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://docspace.uk/">
    <meta property="twitter:title" content="Companies House Document Downloader - DocSpace UK">
    <meta property="twitter:description" content="Download all Companies House documents for any UK company. Fast, reliable service for just £5 per company download.">
    <!-- <meta property="twitter:image" content="https://docspace.uk/og-image.png"> -->
    
    <!-- Additional SEO Meta Tags -->
    <meta name="geo.region" content="GB">
    <meta name="geo.placename" content="United Kingdom">
    <meta name="copyright" content="DocSpace UK 2025">
    <meta name="theme-color" content="#6366f1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="DocSpace">
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RR9SEE0SQF"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-RR9SEE0SQF');
    </script>
    
    <!-- Preconnect for Performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://blue-flower-d40f.mahin84.workers.dev">
    <link rel="dns-prefetch" href="https://checkout.stripe.com">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%236366f1'/%3E%3Cstop offset='100%25' style='stop-color:%238b5cf6'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' rx='6' fill='url(%23g)'/%3E%3Cpath d='M16 6L8 11v13h16V11L16 6z' fill='white'/%3E%3Crect x='11' y='14' width='3' height='3' fill='%236366f1'/%3E%3Crect x='18' y='14' width='3' height='3' fill='%236366f1'/%3E%3Crect x='11' y='19' width='3' height='3' fill='%236366f1'/%3E%3Crect x='18' y='19' width='3' height='3' fill='%236366f1'/%3E%3C/svg%3E">
    
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #8b5cf6;
            --accent: #ec4899;
            --dark: #0f172a;
            --dark-light: #1e293b;
            --gray: #64748b;
            --gray-light: #94a3b8;
            --gray-lighter: #cbd5e1;
            --white: #ffffff;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --gradient-3: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-md: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            --radius: 12px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #1e293b;
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }

        .bg-animation::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 20% 80%, #6366f1 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, #8b5cf6 0%, transparent 50%),
                        radial-gradient(circle at 40% 40%, #3b82f6 0%, transparent 50%);
            animation: rotate 30s linear infinite;
            opacity: 0.1;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Top bar */
        .top-bar {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            max-width: 1200px;
            margin: 0 auto;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
        }

        .logo-small {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            background: var(--gradient-2);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .logo-small:hover {
            transform: scale(1.05);
        }

        .logo-small svg {
            width: 28px;
            height: 28px;
            color: white;
        }

        .top-bar-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Create Account button */
        .create-account-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--gradient-2);
            border: none;
            border-radius: 100px;
            padding: 10px 20px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .create-account-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.4);
        }

        .create-account-btn svg {
            width: 18px;
            height: 18px;
        }

        body.light-mode .create-account-btn {
            box-shadow: 0 4px 14px 0 rgba(99, 102, 241, 0.3);
        }
        
        /* Profile mode - matching theme toggle style */
        .create-account-btn.profile-mode {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: none;
        }
        
        .create-account-btn.profile-mode:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        
        .create-account-btn.profile-mode svg {
            width: 24px;
            height: 24px;
            color: #a5b4fc;
            transition: all 0.3s ease;
        }
        
        .create-account-btn.profile-mode:hover svg {
            color: white;
            transform: scale(1.1);
        }
        
        body.light-mode .create-account-btn.profile-mode {
            background: white;
            border-color: #e2e8f0;
            box-shadow: var(--shadow);
        }
        
        body.light-mode .create-account-btn.profile-mode svg {
            color: #6366f1;
        }
        
        /* Profile dropdown menu */
        .profile-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: rgba(20, 25, 40, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius);
            min-width: 220px;
            padding: 8px;
            display: none;
            z-index: 1000;
            box-shadow: var(--shadow-xl);
            animation: dropdownFadeIn 0.2s ease;
        }
        
        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .profile-dropdown.show {
            display: block;
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            color: #e2e8f0;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }
        
        .dropdown-item:hover {
            background: rgba(99, 102, 241, 0.1);
            color: white;
        }
        
        .dropdown-item svg {
            width: 18px;
            height: 18px;
            color: #94a3b8;
            transition: color 0.2s ease;
        }
        
        .dropdown-item:hover svg {
            color: var(--primary-light);
        }
        
        .dropdown-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 8px 0;
        }
        
        .dropdown-item.danger {
            color: #f87171;
        }
        
        .dropdown-item.danger svg {
            color: #f87171;
        }
        
        .dropdown-item.danger:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #fca5a5;
        }
        
        body.light-mode .profile-dropdown {
            background: white;
            border-color: #e2e8f0;
        }
        
        body.light-mode .dropdown-item {
            color: #475569;
        }
        
        body.light-mode .dropdown-item:hover {
            background: rgba(99, 102, 241, 0.08);
            color: #1e293b;
        }
        
        body.light-mode .dropdown-divider {
            background: #e2e8f0;
        }

        /* Dark mode toggle */
        .theme-toggle {
            position: relative;
            top: 0;
            right: 0;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .theme-toggle svg {
            width: 24px;
            height: 24px;
            color: white;
            transition: transform 0.3s ease;
        }

        .theme-toggle:hover svg {
            transform: rotate(180deg);
        }

        /* Main container */
        .main-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            position: relative;
        }

        /* Hero section */
        .hero {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeInUp 0.8s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-size: 3.5rem;
            font-weight: 800;
            background: var(--gradient-2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 16px;
            letter-spacing: -0.02em;
        }

        .hero-subtitle {
            font-size: 1.25rem;
            color: #94a3b8;
            max-width: 600px;
            margin: 0 auto 12px;
        }

        .price-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            padding: 8px 20px;
            border-radius: 100px;
            font-weight: 600;
            color: #a5b4fc;
            margin-top: 12px;
            animation: fadeIn 0.8s ease 0.3s both;
        }

        body.light-mode .price-badge {
            background: rgba(99, 102, 241, 0.15);
            border-color: rgba(99, 102, 241, 0.3);
            color: #6366f1;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Search container */
        .search-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            padding: 40px;
            width: 100%;
            max-width: 600px;
            margin-bottom: 40px;
            box-shadow: var(--shadow-xl);
            animation: fadeInUp 0.8s ease 0.2s both;
            position: relative;
            z-index: 500;
        }

        /* Form styles */
        .form-group {
            margin-bottom: 24px;
        }

        .form-input {
            width: 100%;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius);
            font-size: 16px;
            color: white;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-input::placeholder {
            color: #64748b;
            opacity: 1;
        }

        .form-helper {
            font-size: 14px;
            color: #64748b;
            margin-top: 8px;
        }

        /* Button styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px 32px;
            background: var(--gradient-2);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-decoration: none;
            width: 100%;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0);
            transition: background 0.3s ease;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px -12px rgba(99, 102, 241, 0.5);
        }

        .btn:hover:not(:disabled)::before {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #334155;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .btn-success:hover:not(:disabled) {
            box-shadow: 0 20px 40px -12px rgba(16, 185, 129, 0.5);
        }

        /* Status messages */
        .status-message {
            margin-top: 24px;
            padding: 16px 20px;
            border-radius: var(--radius);
            display: none;
            animation: slideIn 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid transparent;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-success {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border-color: rgba(16, 185, 129, 0.2);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.2);
        }

        .status-info {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border-color: rgba(59, 130, 246, 0.2);
        }

        /* Progress section */
        .progress-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            padding: 32px;
            margin-top: 24px;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .progress-title {
            font-size: 18px;
            font-weight: 600;
            color: white;
        }

        .progress-count {
            font-size: 14px;
            color: #94a3b8;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            height: 8px;
            border-radius: 100px;
            overflow: hidden;
            margin-bottom: 24px;
        }

        .progress-fill {
            background: var(--gradient-2);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* File list */
        .file-list {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .file-list::-webkit-scrollbar {
            width: 8px;
        }

        .file-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 100px;
        }

        .file-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 100px;
        }

        .file-list::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .file-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .file-item.success {
            color: #10b981;
        }

        .file-item.error {
            color: #ef4444;
        }

        .file-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #cbd5e1;
        }

        /* Search results */
        .results-container {
            width: 100%;
            max-width: 600px;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .company-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            padding: 32px;
            padding-left: 36px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .company-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
        }

        .company-name {
            font-size: 24px;
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
        }

        .company-info {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 24px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #94a3b8;
        }

        .info-item svg {
            width: 16px;
            height: 16px;
            color: #64748b;
        }

        .document-stats {
            display: flex;
            gap: 24px;
            padding: 20px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: var(--radius);
            margin-bottom: 24px;
        }

        .stat-item {
            flex: 1;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-light);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            color: #94a3b8;
        }

        /* Loading states */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .skeleton {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.05) 25%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0.05) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Info section */
        .info-section-single {
            width: 100%;
            max-width: 600px;
            margin: 24px auto 60px;
        }

        .info-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 32px;
            box-shadow: var(--shadow-xl);
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .info-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 50px -12px rgba(99, 102, 241, 0.25);
        }

        .info-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 32px;
        }

        .info-column h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-light);
            margin-bottom: 16px;
        }

        .feature-list.compact {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .feature-list.compact .feature-item {
            padding: 12px 16px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
            display: block;
            transition: all 0.2s ease;
        }

        .feature-list.compact .feature-item:hover {
            background: rgba(99, 102, 241, 0.15);
            transform: translateX(4px);
        }

        .user-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .user-item {
            font-size: 14px;
        }

        .user-item strong {
            color: #e2e8f0;
            display: block;
            margin-bottom: 4px;
            font-size: 15px;
        }

        .user-item p {
            color: #94a3b8;
            margin: 0;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .info-content {
                grid-template-columns: 1fr;
                gap: 24px;
            }
            
            .info-container {
                padding: 24px;
            }
        }

        /* Old info card styles for compatibility */
        .info-section {
            display: none;
        }

        .info-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            padding: 32px;
            transition: all 0.3s ease;
        }

        .info-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-4px);
        }

        .info-icon {
            width: 48px;
            height: 48px;
            background: var(--gradient-2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }

        .info-icon svg {
            width: 24px;
            height: 24px;
            color: white;
        }

        .info-title {
            font-size: 20px;
            font-weight: 700;
            color: white;
            margin-bottom: 12px;
        }

        .info-description {
            font-size: 14px;
            color: #94a3b8;
            line-height: 1.7;
        }

        /* Feature list */
        .feature-list {
            list-style: none;
            margin-top: 16px;
        }

        .feature-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 14px;
            color: #cbd5e1;
        }

        .feature-item svg {
            width: 20px;
            height: 20px;
            color: var(--primary-light);
            flex-shrink: 0;
            margin-top: 2px;
        }

        /* Footer */
        footer {
            width: 100%;
            text-align: center;
            padding: 60px 20px 40px;
            margin-top: 100px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .footer-logo {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
            color: white;
            margin-bottom: 24px;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-bottom: 24px;
        }

        .footer-links a {
            color: #94a3b8;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.2s ease;
        }

        .footer-links a:hover {
            color: var(--primary-light);
        }

        .footer-copyright {
            font-size: 14px;
            color: #64748b;
        }


        /* Download Status Indicator */
        .download-status-indicator {
            margin-bottom: 12px;
        }

        .already-downloaded {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--success);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .already-downloaded svg {
            flex-shrink: 0;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .top-bar {
                width: calc(100% - 32px);
            }

            .create-account-btn span {
                display: none;
            }

            .create-account-btn {
                padding: 10px;
                width: 48px;
                height: 48px;
                justify-content: center;
            }

            h1 {
                font-size: 2.5rem;
            }

            .hero-subtitle {
                font-size: 1.1rem;
            }

            .search-container {
                padding: 24px;
            }

            .company-card {
                padding: 24px;
            }

            .document-stats {
                flex-direction: column;
                gap: 16px;
            }

            .footer-links {
                flex-direction: column;
                gap: 16px;
            }
        }

        /* Autocomplete styles */
        .autocomplete-wrapper {
            position: relative;
            width: 100%;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: rgba(20, 25, 40, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius);
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: var(--shadow-xl);
        }

        .autocomplete-dropdown.show {
            display: block;
        }

        .autocomplete-item {
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover,
        .autocomplete-item.active {
            background: rgba(99, 102, 241, 0.2);
        }

        .autocomplete-item .company-title {
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
            font-size: 15px;
        }

        .autocomplete-item .company-details {
            font-size: 13px;
            color: #94a3b8;
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .autocomplete-item .company-number {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .autocomplete-item .company-status {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .autocomplete-item .company-status.active {
            color: #10b981;
        }

        .autocomplete-item .company-status.dissolved {
            color: #ef4444;
        }

        .autocomplete-loading {
            padding: 20px;
            text-align: center;
            color: #94a3b8;
        }

        .autocomplete-loading .spinner {
            margin: 0 auto;
        }

        .autocomplete-empty {
            padding: 20px;
            text-align: center;
            color: #64748b;
            font-size: 14px;
        }

        /* Light mode autocomplete */
        body.light-mode .autocomplete-dropdown {
            background: white;
            border-color: #e2e8f0;
        }

        body.light-mode .autocomplete-item {
            border-bottom-color: #f1f5f9;
        }

        body.light-mode .autocomplete-item:hover,
        body.light-mode .autocomplete-item.active {
            background: rgba(99, 102, 241, 0.08);
        }

        body.light-mode .autocomplete-item .company-title {
            color: #1e293b;
        }

        /* Light mode styles */
        body.light-mode {
            background: #f8fafc;
            color: #1e293b;
        }

        body.light-mode .bg-animation::before {
            opacity: 0.05;
        }

        body.light-mode .theme-toggle {
            background: rgba(0, 0, 0, 0.05);
            border-color: rgba(0, 0, 0, 0.1);
        }

        body.light-mode .theme-toggle svg {
            color: #1e293b;
        }

        body.light-mode .search-container,
        body.light-mode .company-card,
        body.light-mode .progress-section,
        body.light-mode .info-container {
            background: white;
            border-color: #e2e8f0;
        }

        body.light-mode .info-column h3 {
            color: var(--primary);
        }

        body.light-mode .feature-list.compact .feature-item {
            background: rgba(99, 102, 241, 0.08);
            border-color: rgba(99, 102, 241, 0.15);
            color: #475569;
        }

        body.light-mode .feature-list.compact .feature-item:hover {
            background: rgba(99, 102, 241, 0.12);
        }

        body.light-mode .user-item strong {
            color: #1e293b;
        }

        body.light-mode .user-item p {
            color: #64748b;
        }

        body.light-mode .info-card {
            background: white;
            border-color: #e2e8f0;
        }

        body.light-mode .form-input {
            background: #f8fafc;
            border-color: #e2e8f0;
            color: #1e293b;
        }

        body.light-mode .form-input:focus {
            background: white;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        body.light-mode .company-name,
        body.light-mode .info-title,
        body.light-mode .footer-logo {
            color: #1e293b;
        }

        body.light-mode .progress-title {
            color: #1e293b;
        }

        body.light-mode .file-item {
            background: #f8fafc;
        }

        body.light-mode .file-item:hover {
            background: #f1f5f9;
        }

        body.light-mode footer {
            border-top-color: #e2e8f0;
        }
    </style>
    
    <!-- Schema.org Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "DocSpace - Companies House Document Downloader",
      "url": "https://docspace.uk",
      "description": "Download all Companies House documents and filings for any UK company as a ZIP file. Fast, reliable service for just £5 per company.",
      "applicationCategory": "BusinessApplication",
      "operatingSystem": "Any",
      "offers": {
        "@type": "Offer",
        "price": "5.00",
        "priceCurrency": "GBP",
        "availability": "https://schema.org/InStock"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.8",
        "ratingCount": "127"
      },
      "provider": {
        "@type": "Organization",
        "name": "DocSpace UK",
        "url": "https://docspace.uk",
        "logo": "https://docspace.uk/",
        "sameAs": [
          "https://twitter.com/docspaceuk",
          "https://www.linkedin.com/company/docspace-uk"
        ]
      }
    }
    </script>
</head>
<body>
    <!-- Animated background -->
    <div class="bg-animation"></div>
    
    <!-- Top bar -->
    <div class="top-bar">
        <div class="logo-small">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
        </div>
        <div class="top-bar-actions">
            <!-- Auth button container with dropdown -->
            <div style="position: relative;">
                <button class="create-account-btn" id="authBtn" aria-label="Account" onclick="window.location.href='auth.html'">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span id="authBtnText">Create Account</span>
                </button>
                
                <!-- Profile dropdown menu -->
                <div class="profile-dropdown" id="profileDropdown">
                    <!-- Content will be dynamically populated based on auth state -->
                </div>
            </div>
            <!-- Dark mode toggle -->
            <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Main container -->
    <div class="main-container">
        <!-- Hero section -->
        <div class="hero">
            <h1>DocSpace</h1>
            <p class="hero-subtitle">Bulk Download Companies House Filings – Automate the Boring.</p>
            <div class="price-badge">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                £5 per company download
            </div>
        </div>
        
        <!-- Search container -->
        <div class="search-container">
            <form id="searchForm">
                <div class="form-group">
                    <div class="autocomplete-wrapper">
                        <input 
                            type="text" 
                            id="companyName" 
                            name="companyName" 
                            class="form-input"
                            placeholder="Enter company name or number"
                            required
                            autocomplete="off"
                        >
                        <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
                    </div>
                    <div class="form-helper">Search any UK registered company</div>
                </div>
                
                <button type="submit" class="btn" id="searchBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    Search Company
                </button>
            </form>
            
            <div class="status-message" id="statusBox"></div>
        </div>
        
        <!-- Results container -->
        <div class="results-container" id="resultsContainer">
            <div class="company-card" id="companyCard">
                <div class="company-name" id="companyNameDisplay"></div>
                <div class="company-info" id="companyInfo"></div>
                <div class="document-stats" id="documentStats">
                    <div class="stat-item">
                        <div class="stat-number" id="totalDocs">0</div>
                        <div class="stat-label">Total Documents</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="companyAge">0</div>
                        <div class="stat-label">Years Old</div>
                    </div>
                </div>
                <button class="btn btn-success" id="downloadZipBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                    </svg>
                    Download All Documents
                </button>
            </div>
            
            <!-- Progress section -->
            <div class="progress-section" id="progressContainer">
                <div class="progress-header">
                    <div class="progress-title">Downloading Documents</div>
                    <div class="progress-count" id="fileCount">0 of 0</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="file-list" id="fileList"></div>
            </div>
        </div>
        
        <!-- Info section -->
        <div class="info-section-single" id="marketingSection">
            <div class="info-container">
                <div class="info-content">
                    <div class="info-column">
                        <h3 class="info-title">Why DocSpace?</h3>
                        <ul class="feature-list compact">
                            <li class="feature-item">All filings in one click</li>
                            <li class="feature-item">Blazing-fast downloads</li>
                            <li class="feature-item">Flat £5 fee per company</li>
                            <li class="feature-item">Secure Stripe checkout</li>
                            <li class="feature-item">No sign-up, no fuss</li>
                        </ul>
                    </div>
                    
                    <div class="info-column">
                        <h3 class="info-title">Who Uses DocSpace?</h3>
                        <div class="user-list">
                            <div class="user-item">
                                <strong>1. Accountants & Bookkeepers</strong>
                                <p>Quickly collect client filings for audits, tax prep, or financial reviews.</p>
                            </div>
                            <div class="user-item">
                                <strong>2. Corporate Investigators & Due Diligence Teams</strong>
                                <p>Download full company histories for M&A, compliance checks, or KYC.</p>
                            </div>
                            <div class="user-item">
                                <strong>3. Lawyers & Legal Researchers</strong>
                                <p>Access incorporation papers, director changes, charges—all in one go.</p>
                            </div>
                            <div class="user-item">
                                <strong>4. Investors & Analysts</strong>
                                <p>Evaluate company health and structure before investing or partnering.</p>
                            </div>
                            <div class="user-item">
                                <strong>5. Journalists & Researchers</strong>
                                <p>Get instant access to company disclosures for reports or case studies.</p>
                            </div>
                            <div class="user-item">
                                <strong>6. Founders & Business Owners</strong>
                                <p>Check competitor filings or retrieve your own archive easily.</p>
                            </div>
                            <div class="user-item">
                                <strong>7. Procurement & Risk Teams</strong>
                                <p>Vet suppliers with full filing history in seconds.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        </div>
    </div>
    
    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-logo">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="24" height="24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
                DocSpace UK
            </div>
            <div class="footer-links">
                <a href="/terms">Terms of Service</a>
                <a href="/privacy">Privacy Policy</a>
                <a href="/contact">Contact</a>
                <a href="/api">API Access</a>
            </div>
            <div class="footer-copyright">
                © 2025 DocSpace UK - Companies House Document Download Service
            </div>
        </div>
    </footer>
    
    <script>
        const WORKER_URL = 'https://blue-flower-d40f.mahin84.workers.dev';
        const API_KEY = '22aefa40-ee9e-47c0-b40a-2dd3c03165c6';
        const STRIPE_PUBLIC_KEY = 'pk_test_51RT33XAJ1gsWpnv6rpEFMeCmuADlJet1lmqeaMrPXas4DYblZZ73SOnNEXb0gE5ADHrfRkVJIXyACM3Nw5Vt9HCz00L8E9wffe';
        let allDocuments = [];
        let companyData = null;
        let paymentCompleted = false;
        
        // Initialize Stripe
        const stripe = Stripe(STRIPE_PUBLIC_KEY);
        
        // Autocomplete variables
        let autocompleteTimeout = null;
        let selectedIndex = -1;
        let suggestions = [];
        
        // Dark mode toggle
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;
        
        // Check for saved theme preference
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            body.classList.add('light-mode');
            updateThemeIcon();
        }
        
        themeToggle.addEventListener('click', () => {
            body.classList.toggle('light-mode');
            updateThemeIcon();
            localStorage.setItem('theme', body.classList.contains('light-mode') ? 'light' : 'dark');
        });
        
        function updateThemeIcon() {
            const icon = themeToggle.querySelector('svg');
            if (body.classList.contains('light-mode')) {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />';
            } else {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />';
            }
        }
        
        // Helper functions
        function addDebug(message) {
            console.log(`${new Date().toISOString().substr(11, 8)} - ${message}`);
        }
        
        async function fetchWithWorker(url, apiKey) {
            const params = new URLSearchParams({
                url: url,
                apiKey: apiKey
            });
            const proxyUrl = `${WORKER_URL}?${params.toString()}`;
            
            addDebug(`Worker URL: ${WORKER_URL}`);
            addDebug(`Target URL: ${url}`);
            
            try {
                const response = await fetch(proxyUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': url.includes('/content') ? 'application/pdf' : 'application/json'
                    }
                });
                addDebug(`Response status: ${response.status}`);
                
                if (!response.ok) {
                    try {
                        const errorText = await response.text();
                        addDebug(`Error response: ${errorText}`);
                    } catch (e) {
                        // Ignore if can't read error
                    }
                }
                
                return response;
            } catch (error) {
                addDebug(`Fetch error: ${error.message}`);
                throw error;
            }
        }
        
        function showStatus(type, message) {
            const statusBox = document.getElementById('statusBox');
            statusBox.className = `status-message status-${type}`;
            statusBox.textContent = message;
            statusBox.style.display = 'block';
        }
        
        function updateProgress(current, total) {
            const percentage = Math.round((current / total) * 100);
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = `${percentage}%`;
            
            document.getElementById('fileCount').textContent = `${current} of ${total}`;
        }
        
        function addFileToList(filename, status, error = null) {
            const fileList = document.getElementById('fileList');
            const fileItem = document.createElement('div');
            fileItem.className = `file-item ${status}`;
            
            const icon = status === 'success' 
                ? '<svg class="file-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
                : '<svg class="file-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
            
            const errorText = error ? ` - ${error}` : '';
            fileItem.innerHTML = `${icon}<span class="file-name">${filename}${errorText}</span>`;
            
            fileList.appendChild(fileItem);
            fileList.scrollTop = fileList.scrollHeight;
        }
        
        async function displayCompanyInfo(company) {
            document.getElementById('companyNameDisplay').textContent = company.title;
            
            const companyInfo = document.getElementById('companyInfo');
            companyInfo.innerHTML = `
                <div class="info-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                    </svg>
                    ${company.company_number}
                </div>
                ${company.company_status ? `
                <div class="info-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    ${company.company_status.charAt(0).toUpperCase() + company.company_status.slice(1)}
                </div>
                ` : ''}
                ${company.date_of_creation ? `
                <div class="info-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Incorporated ${company.date_of_creation}
                </div>
                ` : ''}
            `;
            
            // Check download status for authenticated users
            if (currentUser && window.searchHistory) {
                try {
                    const downloadStatus = await window.searchHistory.checkDownloadStatus(company.company_number);
                    const downloadBtn = document.getElementById('downloadZipBtn');
                    const downloadBtnContainer = downloadBtn.parentElement;
                    
                    if (downloadStatus && downloadStatus.download_status === 'downloaded') {
                        // Company already downloaded - show free re-download option
                        const downloadedDate = new Date(downloadStatus.downloaded_at).toLocaleDateString();
                        
                        // Add downloaded indicator
                        const existingIndicator = downloadBtnContainer.querySelector('.download-status-indicator');
                        if (existingIndicator) existingIndicator.remove();
                        
                        const indicator = document.createElement('div');
                        indicator.className = 'download-status-indicator';
                        indicator.innerHTML = `
                            <div class="already-downloaded">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                Already downloaded on ${downloadedDate}
                            </div>
                        `;
                        downloadBtnContainer.insertBefore(indicator, downloadBtn);
                        
                        // Update button text
                        downloadBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Free Re-download
                        `;
                        downloadBtn.className = 'btn btn-primary'; // Change to green/primary color
                    } else {
                        // Company not downloaded yet - show normal download button
                        const existingIndicator = downloadBtnContainer.querySelector('.download-status-indicator');
                        if (existingIndicator) existingIndicator.remove();
                        
                        downloadBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                            </svg>
                            Download All Documents
                        `;
                        downloadBtn.className = 'btn btn-success';
                    }
                } catch (error) {
                    console.error('Error checking download status:', error);
                }
            }
        }
        
        // Search form handler
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const companyInput = document.getElementById('companyName');
            const companyName = companyInput.value.trim();
            const companyNumber = companyInput.dataset.companyNumber; // Get stored company number
            const searchBtn = document.getElementById('searchBtn');
            const resultsContainer = document.getElementById('resultsContainer');
            const progressContainer = document.getElementById('progressContainer');
            
            // Reset UI
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<span class="spinner"></span> Searching...';
            resultsContainer.style.display = 'none';
            progressContainer.style.display = 'none';
            document.getElementById('fileList').innerHTML = '';
            allDocuments = [];
            
            // Clear the stored company number after use
            delete companyInput.dataset.companyNumber;
            
            try {
                // If we have a company number from autocomplete, fetch directly
                if (companyNumber) {
                    showStatus('info', 'Fetching company details...');
                    
                    const companyUrl = `https://api.companieshouse.gov.uk/company/${companyNumber}`;
                    const companyResponse = await fetchWithWorker(companyUrl, API_KEY);
                    
                    if (!companyResponse.ok) {
                        throw new Error(`Failed to fetch company details (${companyResponse.status})`);
                    }
                    
                    companyData = await companyResponse.json();
                    companyData.company_number = companyNumber; // Ensure number is set
                    companyData.title = companyData.company_name; // Normalize field name
                } else {
                    // Otherwise, search by name
                    showStatus('info', 'Searching for company...');
                    
                    const searchUrl = `https://api.companieshouse.gov.uk/search/companies?q=${encodeURIComponent(companyName)}&items_per_page=1`;
                    const searchResponse = await fetchWithWorker(searchUrl, API_KEY);
                    
                    if (!searchResponse.ok) {
                        if (searchResponse.status === 401) {
                            throw new Error('Invalid API key. Please check your credentials.');
                        }
                        throw new Error(`Failed to search for company (${searchResponse.status})`);
                    }
                    
                    const searchData = await searchResponse.json();
                    
                    if (!searchData.items || searchData.items.length === 0) {
                        throw new Error('No company found with that name');
                    }
                    
                    companyData = searchData.items[0];
                }
                
                // Add to search history for logged-in users
                if (currentUser && window.searchHistory) {
                    try {
                        await window.searchHistory.addSearch(companyData);
                        console.log('Added to search history:', companyData.company_name);
                    } catch (error) {
                        console.error('Failed to add to search history:', error);
                    }
                }
                
                await displayCompanyInfo(companyData);
                
                // Get filing history
                showStatus('info', 'Fetching filing history...');
                
                const filingUrl = `https://api.companieshouse.gov.uk/company/${companyData.company_number}/filing-history?items_per_page=100`;
                const filingResponse = await fetchWithWorker(filingUrl, API_KEY);
                
                if (!filingResponse.ok) {
                    throw new Error('Failed to fetch filing history');
                }
                
                const filingData = await filingResponse.json();
                const documents = filingData.items || [];
                
                if (documents.length === 0) {
                    throw new Error('No documents found for this company');
                }
                
                // Filter documents with PDF links
                allDocuments = documents.filter(doc => {
                    return doc.links && doc.links.document_metadata;
                }).map(doc => {
                    let metadataUrl = doc.links.document_metadata;
                    
                    if (metadataUrl.startsWith('/')) {
                        metadataUrl = `https://api.companieshouse.gov.uk${metadataUrl}`;
                    }
                    
                    return {
                        date: doc.date || 'unknown',
                        category: doc.category || 'document',
                        description: doc.description || 'Untitled',
                        metadataUrl: metadataUrl,
                        filename: generateFilename(doc)
                    };
                });
                
                // Update stats
                document.getElementById('totalDocs').textContent = documents.length;
                
                // Calculate company age
                if (companyData.date_of_creation) {
                    const incorporationDate = new Date(companyData.date_of_creation);
                    const currentDate = new Date();
                    const ageInYears = Math.floor((currentDate - incorporationDate) / (365.25 * 24 * 60 * 60 * 1000));
                    document.getElementById('companyAge').textContent = ageInYears;
                } else {
                    document.getElementById('companyAge').textContent = 'N/A';
                }
                
                if (allDocuments.length === 0) {
                    throw new Error('No downloadable PDFs found');
                }
                
                // Show results
                showStatus('success', `Found ${companyData.title} with ${allDocuments.length} downloadable documents`);
                resultsContainer.style.display = 'block';
                
            } catch (error) {
                showStatus('error', error.message);
                addDebug(`Error: ${error.message}`);
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    Search Company
                `;
            }
        });
        
        // Download handler
        async function startDownload() {
            const progressContainer = document.getElementById('progressContainer');
            const downloadZipBtn = document.getElementById('downloadZipBtn');
            
            downloadZipBtn.disabled = true;
            progressContainer.style.display = 'block';
            
            showStatus('info', 'Downloading PDFs... This may take a few minutes.');
            
            const zip = new JSZip();
            const companyFolder = zip.folder(sanitizeFilename(companyData.title));
            
            let downloaded = 0;
            let failed = 0;
            
            // Download all documents
            for (let i = 0; i < allDocuments.length; i++) {
                const doc = allDocuments[i];
                updateProgress(i + 1, allDocuments.length);
                
                try {
                    const pdfUrl = doc.metadataUrl.includes('document-api.') 
                        ? doc.metadataUrl 
                        : `${doc.metadataUrl}/content`;
                    
                    const pdfResponse = await fetchWithWorker(pdfUrl, API_KEY);
                    
                    if (pdfResponse.ok) {
                        const pdfBlob = await pdfResponse.blob();
                        
                        if (pdfBlob.size > 0) {
                            companyFolder.file(doc.filename, pdfBlob);
                            downloaded++;
                            addFileToList(doc.filename, 'success');
                        } else {
                            failed++;
                            addFileToList(doc.filename, 'error', 'Empty file');
                        }
                    } else {
                        failed++;
                        addFileToList(doc.filename, 'error', `Status ${pdfResponse.status}`);
                    }
                    
                    // Small delay to avoid rate limiting
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    failed++;
                    addFileToList(doc.filename, 'error', error.message);
                }
            }
            
            if (downloaded > 0) {
                showStatus('info', 'Creating ZIP file...');
                
                try {
                    const content = await zip.generateAsync({ 
                        type: 'blob',
                        compression: 'DEFLATE',
                        compressionOptions: { level: 6 }
                    });
                    
                    saveAs(content, `${sanitizeFilename(companyData.title)}_documents.zip`);
                    
                    showStatus('success', 
                        `✨ Download complete! ${downloaded} files downloaded${failed > 0 ? `, ${failed} failed` : ''}.`
                    );
                } catch (error) {
                    showStatus('error', 'Failed to create ZIP file');
                }
            } else {
                showStatus('error', 'No files could be downloaded.');
            }
            
            downloadZipBtn.disabled = false;
        }
        
        document.getElementById('downloadZipBtn').addEventListener('click', async () => {
            const downloadZipBtn = document.getElementById('downloadZipBtn');
            
            if (!paymentCompleted) {
                downloadZipBtn.disabled = true;
                downloadZipBtn.innerHTML = '<span class="spinner"></span> Processing payment...';
                
                try {
                    showStatus('info', 'Redirecting to payment...');
                    
                    const dataToStore = {
                        companyData: companyData,
                        allDocuments: allDocuments,
                        timestamp: Date.now()
                    };
                    
                    localStorage.setItem('pendingCompany', JSON.stringify(dataToStore));
                    
                    const paymentUrl = 'https://buy.stripe.com/6oU14m6YxcZL9ywgEncwg01';
                    window.location.href = paymentUrl;
                    
                } catch (error) {
                    showStatus('error', 'Payment error: ' + error.message);
                    downloadZipBtn.disabled = false;
                    downloadZipBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                        </svg>
                        Download All Documents
                    `;
                }
                return;
            }
            
            await startDownload();
        });
        
        function generateFilename(doc) {
            const date = doc.date || 'unknown';
            const category = doc.category || 'document';
            const desc = (doc.description || 'document').substring(0, 50);
            const safeDesc = sanitizeFilename(desc);
            return `${date}_${category}_${safeDesc}.pdf`;
        }
        
        function sanitizeFilename(name) {
            return name.replace(/[^a-z0-9\s\-\_]/gi, '').trim().replace(/\s+/g, '_');
        }
        
        // Autocomplete functionality
        const companyInput = document.getElementById('companyName');
        const autocompleteDropdown = document.getElementById('autocompleteDropdown');
        
        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Search companies for autocomplete
        async function searchCompanies(query) {
            if (query.length < 2) {
                hideAutocomplete();
                return;
            }
            
            // Show loading state
            autocompleteDropdown.innerHTML = '<div class="autocomplete-loading"><div class="spinner"></div></div>';
            autocompleteDropdown.classList.add('show');
            
            try {
                const searchUrl = `https://api.companieshouse.gov.uk/search/companies?q=${encodeURIComponent(query)}&items_per_page=5`;
                const response = await fetchWithWorker(searchUrl, API_KEY);
                
                if (!response.ok) {
                    hideAutocomplete();
                    return;
                }
                
                const data = await response.json();
                suggestions = data.items || [];
                
                if (suggestions.length === 0) {
                    autocompleteDropdown.innerHTML = '<div class="autocomplete-empty">No companies found</div>';
                    return;
                }
                
                // Render suggestions
                renderSuggestions();
                
            } catch (error) {
                console.error('Autocomplete error:', error);
                hideAutocomplete();
            }
        }
        
        // Render autocomplete suggestions
        function renderSuggestions() {
            autocompleteDropdown.innerHTML = suggestions.map((company, index) => {
                const statusClass = company.company_status === 'active' ? 'active' : 'dissolved';
                const statusIcon = company.company_status === 'active' 
                    ? '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="14" height="14"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
                    : '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="14" height="14"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                
                return `
                    <div class="autocomplete-item ${index === selectedIndex ? 'active' : ''}" data-index="${index}">
                        <div class="company-title">${company.title}</div>
                        <div class="company-details">
                            <span class="company-number">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="14" height="14">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                                </svg>
                                ${company.company_number}
                            </span>
                            <span class="company-status ${statusClass}">
                                ${statusIcon}
                                ${company.company_status.charAt(0).toUpperCase() + company.company_status.slice(1)}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add click handlers
            const items = autocompleteDropdown.querySelectorAll('.autocomplete-item');
            items.forEach((item, index) => {
                item.addEventListener('click', () => selectCompany(index));
            });
        }
        
        // Select a company from autocomplete
        function selectCompany(index) {
            const company = suggestions[index];
            if (company) {
                companyInput.value = company.title;
                // Store the company number for exact search
                companyInput.dataset.companyNumber = company.company_number;
                hideAutocomplete();
                // Trigger search
                document.getElementById('searchForm').dispatchEvent(new Event('submit'));
            }
        }
        
        // Hide autocomplete dropdown
        function hideAutocomplete() {
            autocompleteDropdown.classList.remove('show');
            autocompleteDropdown.innerHTML = '';
            selectedIndex = -1;
            suggestions = [];
        }
        
        // Debounced search function
        const debouncedSearch = debounce(searchCompanies, 300);
        
        // Input event listener
        companyInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            if (query.length >= 2) {
                debouncedSearch(query);
            } else {
                hideAutocomplete();
            }
        });
        
        // Keyboard navigation
        companyInput.addEventListener('keydown', (e) => {
            if (!autocompleteDropdown.classList.contains('show')) return;
            
            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, suggestions.length - 1);
                    renderSuggestions();
                    break;
                    
                case 'ArrowUp':
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    renderSuggestions();
                    break;
                    
                case 'Enter':
                    if (selectedIndex >= 0) {
                        e.preventDefault();
                        selectCompany(selectedIndex);
                    }
                    break;
                    
                case 'Escape':
                    hideAutocomplete();
                    break;
            }
        });
        
        // Hide autocomplete on click outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.autocomplete-wrapper')) {
                hideAutocomplete();
            }
        });
        
        // Initialize Supabase
        const SUPABASE_URL = 'https://iotwhyiisbazeqmowljv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlvdHdoeWlpc2JhemVxbW93bGp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgzMDUwMzUsImV4cCI6MjA2Mzg4MTAzNX0.HYAZLeIjR9b9C9k0p3wgf73GvpVH4-Ag9wQbACLcsLc';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                persistSession: true,
                storageKey: 'docspace-auth',
                storage: window.localStorage,
                detectSessionInUrl: true,
                autoRefreshToken: true
            }
        });
        
        // Auth state management
        let currentUser = null;
        
        // Search history functions (inline since we can't import modules)
        window.searchHistory = {
            async addSearch(companyData) {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return null;
                
                const { data, error } = await supabaseClient
                    .from('search_history')
                    .upsert({
                        user_id: user.id,
                        company_number: companyData.company_number,
                        company_name: companyData.company_name || companyData.title,
                        company_status: companyData.company_status,
                        company_type: companyData.company_type,
                        date_of_creation: companyData.date_of_creation,
                        address: companyData.registered_office_address ? 
                            `${companyData.registered_office_address.address_line_1 || ''}, ${companyData.registered_office_address.locality || ''}, ${companyData.registered_office_address.postal_code || ''}`.replace(/^,\s*|,\s*$/g, '') : 
                            null,
                        searched_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id,company_number'
                    });
                
                if (error) console.error('Error adding to search history:', error);
                return data;
            },

            async getHistory() {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return [];

                const { data, error } = await supabaseClient
                    .from('search_history')
                    .select('*')
                    .order('searched_at', { ascending: false })
                    .limit(20);

                if (error) {
                    console.error('Error getting search history:', error);
                    return [];
                }
                return data || [];
            },

            async checkDownloadStatus(companyNumber) {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return null;

                const { data, error } = await supabaseClient
                    .from('search_history')
                    .select('download_status, downloaded_at, company_name, download_count')
                    .eq('company_number', companyNumber)
                    .single();

                if (error && error.code !== 'PGRST116') console.error('Error checking download status:', error);
                return error ? null : data;
            }
        };
        
        // Listen for auth state changes
        supabaseClient.auth.onAuthStateChange((event, session) => {
            console.log('Auth state changed:', event, session);
            currentUser = session?.user || null;
            updateAuthUI();
        });
        
        // Force update auth UI immediately
        setTimeout(async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                console.log('Force updating UI for logged in user:', session.user.email);
                currentUser = session.user;
                updateAuthUI();
            }
        }, 100);
        
        // Check auth state
        async function checkAuthState() {
            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                console.log('Auth check - Session:', session);
                console.log('Auth check - User:', session?.user);
                if (error) {
                    console.error('Auth error:', error);
                }
                currentUser = session?.user || null;
                updateAuthUI();
            } catch (err) {
                console.error('Failed to check auth:', err);
            }
        }
        
        // Update UI based on auth state
        function updateAuthUI() {
            console.log('Updating auth UI, currentUser:', currentUser);
            const authBtn = document.getElementById('authBtn');
            const marketingSection = document.getElementById('marketingSection');
            
            if (!authBtn) {
                console.error('Auth button not found!');
                return;
            }
            
            if (currentUser) {
                console.log('User is logged in:', currentUser.email);
                // Hide marketing section for logged-in users
                if (marketingSection) {
                    marketingSection.style.display = 'none';
                }
                // User is logged in - show profile icon
                authBtn.style.display = 'flex';
                authBtn.classList.add('profile-mode');
                authBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                `;
                
                // Remove the inline onclick and add dropdown menu handler
                authBtn.removeAttribute('onclick');
                authBtn.onclick = (e) => {
                    e.preventDefault();
                    showUserMenu();
                };
                
            } else {
                // User is not logged in - show profile icon button with dropdown
                authBtn.style.display = 'flex';
                authBtn.classList.add('profile-mode');
                authBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                `;
                
                // Remove the inline onclick and add dropdown menu handler
                authBtn.removeAttribute('onclick');
                authBtn.onclick = (e) => {
                    e.preventDefault();
                    showGuestMenu();
                };
                
                // Show marketing section for guests
                if (marketingSection) {
                    marketingSection.style.display = 'block';
                }
            }
        }
        
        // Show user dropdown menu
        function showUserMenu() {
            const dropdown = document.getElementById('profileDropdown');
            // Update dropdown content for logged-in users
            dropdown.innerHTML = `
                <button class="dropdown-item" onclick="showMonitoredCompanies()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                    </svg>
                    Companies I Follow
                </button>
                <button class="dropdown-item" onclick="showSearchHistory()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Search History
                </button>
                <button class="dropdown-item logout" onclick="signOut()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Log Out
                </button>
            `;
            dropdown.classList.toggle('show');
        }
        
        // Show guest dropdown menu
        function showGuestMenu() {
            const dropdown = document.getElementById('profileDropdown');
            // Update dropdown content for guests
            dropdown.innerHTML = `
                <button class="dropdown-item" onclick="window.location.href='auth.html'">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                    </svg>
                    Create Account
                </button>
                <button class="dropdown-item" onclick="window.location.href='auth.html?mode=signin'">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Sign In
                </button>
            `;
            dropdown.classList.toggle('show');
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('profileDropdown');
            const authBtn = document.getElementById('authBtn');
            
            if (!authBtn.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });
        
        // Dropdown menu functions
        function showMonitoredCompanies() {
            alert('Companies I Follow - Coming soon!');
            // TODO: Show modal with monitored companies list
        }
        
        function showSearchHistory() {
            // Navigate to dedicated search history page
            window.location.href = '/search-history.html';
        }
        
        // Sign out function
        async function signOut() {
            try {
                await supabaseClient.auth.signOut();
                currentUser = null;
                
                // Close dropdown menu
                const dropdown = document.getElementById('profileDropdown');
                if (dropdown) {
                    dropdown.classList.remove('show');
                }
                
                updateAuthUI();
                showStatus('info', 'Signed out successfully');
            } catch (error) {
                console.error('Sign out error:', error);
                showStatus('error', 'Failed to sign out');
            }
        }
        
        // Debug function - type debugAuth() in console
        window.debugAuth = async function() {
            console.log('=== AUTH DEBUG ===');
            console.log('LocalStorage keys:', Object.keys(localStorage));
            console.log('docspace-auth:', localStorage.getItem('docspace-auth'));
            
            // Try to get session directly
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            console.log('Direct session check:', session);
            console.log('Session error:', error);
            
            // Try to get user
            const { data: { user } } = await supabaseClient.auth.getUser();
            console.log('Current user:', user);
            
            console.log('=================');
        };
        
        // Sign out button handler (keeping this one for the separate sign out button if needed)
        document.getElementById('signOutBtn').addEventListener('click', async () => {
            signOut();
        });
        
        // Listen for auth state changes
        supabaseClient.auth.onAuthStateChange((event, session) => {
            console.log('Auth state changed:', event, session);
            currentUser = session?.user || null;
            updateAuthUI();
        });
        
        // Check for payment status on page load
        window.addEventListener('DOMContentLoaded', async () => {
            // First check if we're coming back from auth redirect
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = hashParams.get('access_token');
            
            if (accessToken) {
                console.log('Found access token in URL, setting session...');
                // Clean up the URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            // Check auth state after DOM is loaded
            await checkAuthState();
            
            // Force refresh session to ensure we have latest state
            const { data: refreshData, error: refreshError } = await supabaseClient.auth.refreshSession();
            if (refreshData?.session) {
                console.log('Session refreshed:', refreshData.session);
                currentUser = refreshData.session.user;
                updateAuthUI();
            }
            
            // Also try to recover session from storage
            const { data: sessionData } = await supabaseClient.auth.getSession();
            if (sessionData?.session) {
                console.log('Recovered session from storage:', sessionData.session);
                currentUser = sessionData.session.user;
                updateAuthUI();
            }
            
            // Check for search data from search history page
            const searchData = sessionStorage.getItem('searchData');
            if (searchData) {
                try {
                    const { companyNumber, companyName, autoDownload } = JSON.parse(searchData);
                    sessionStorage.removeItem('searchData'); // Clear it
                    
                    // Fill in the search form
                    const companyInput = document.getElementById('companyName');
                    companyInput.value = companyName;
                    companyInput.dataset.companyNumber = companyNumber;
                    
                    // Trigger form submission
                    setTimeout(() => {
                        document.getElementById('searchForm').dispatchEvent(new Event('submit'));
                        
                        // If auto-download is requested, trigger download after search completes
                        if (autoDownload) {
                            setTimeout(() => {
                                const downloadBtn = document.getElementById('downloadZipBtn');
                                if (downloadBtn && !downloadBtn.disabled) {
                                    downloadBtn.click();
                                }
                            }, 3000);
                        }
                    }, 1000);
                } catch (error) {
                    console.error('Error processing search data:', error);
                }
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const paymentStatus = urlParams.get('payment');
            
            if (paymentStatus === 'success') {
                const storedData = localStorage.getItem('pendingCompany');
                
                if (storedData) {
                    try {
                        const parsed = JSON.parse(storedData);
                        const { companyData: stored, allDocuments: docs, timestamp } = parsed;
                        
                        if (Date.now() - timestamp < 30 * 60 * 1000) {
                            companyData = stored;
                            allDocuments = docs;
                            paymentCompleted = true;
                            
                            displayCompanyInfo(companyData);
                            document.getElementById('totalDocs').textContent = docs.length;
                            // Company age should already be set from stored data
                            if (stored.companyData && stored.companyData.date_of_creation) {
                                const incorporationDate = new Date(stored.companyData.date_of_creation);
                                const currentDate = new Date();
                                const ageInYears = Math.floor((currentDate - incorporationDate) / (365.25 * 24 * 60 * 60 * 1000));
                                document.getElementById('companyAge').textContent = ageInYears;
                            }
                            document.getElementById('resultsContainer').style.display = 'block';
                            
                            showStatus('success', 'Payment successful! Starting download...');
                            localStorage.removeItem('pendingCompany');
                            
                            setTimeout(async () => {
                                await startDownload();
                            }, 1500);
                        } else {
                            localStorage.removeItem('pendingCompany');
                            showStatus('error', 'Payment session expired. Please search again.');
                        }
                    } catch (error) {
                        showStatus('error', 'Error restoring session. Please search again.');
                    }
                } else {
                    showStatus('info', 'Payment successful! Please search for the company again to download.');
                }
                
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (paymentStatus === 'cancelled') {
                showStatus('info', 'Payment cancelled. Search for a company to try again.');
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });
    </script>
</body>
</html>