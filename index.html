<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Companies House Document Downloader - Download UK Company Filings | DocSpace</title>
    
    <!-- Primary Meta Tags -->
    <meta name="title" content="Companies House Document Downloader - Download UK Company Filings | DocSpace">
    <meta name="description" content="Download all Companies House documents and filings for any UK company as a ZIP file. Fast, reliable service for just £5 per company. Access annual returns, accounts, incorporation documents and more. Instant access to official UK company records.">
    <meta name="keywords" content="companies house documents, uk company filings, download company documents, companies house pdf, annual returns, company accounts, incorporation documents, uk business documents, docspace, companies house api, ch direct, company reports uk, business filings uk, corporate documents, statutory filings, limited company documents, plc filings, company registration documents">
    <meta name="author" content="DocSpace UK">
    <meta name="robots" content="index, follow">
    <meta name="language" content="English">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://docspace.uk/">
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://docspace.uk/">
    <meta property="og:title" content="Companies House Document Downloader - Download UK Company Filings">
    <meta property="og:description" content="Download all Companies House documents for any UK company. Fast, reliable service for just £5 per company download.">
    <meta property="og:image" content="https://docspace.uk/og-image.png">
    <meta property="og:site_name" content="DocSpace UK">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://docspace.uk/">
    <meta property="twitter:title" content="Companies House Document Downloader - DocSpace UK">
    <meta property="twitter:description" content="Download all Companies House documents for any UK company. Fast, reliable service for just £5 per company download.">
    <meta property="twitter:image" content="https://docspace.uk/og-image.png">
    
    <!-- Additional SEO Meta Tags -->
    <meta name="geo.region" content="GB">
    <meta name="geo.placename" content="United Kingdom">
    <meta name="copyright" content="DocSpace UK 2025">
    <meta name="theme-color" content="#1e40af">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="DocSpace">
    
    <!-- Preconnect for Performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://blue-flower-d40f.mahin84.workers.dev">
    <link rel="dns-prefetch" href="https://checkout.stripe.com">
    <meta property="twitter:description" content="Download all Companies House documents for any UK company. Fast, reliable service for just £5 per company download.">
    <meta property="twitter:image" content="https://docspace.uk/twitter-image.png">
    
    <!-- Additional SEO Meta Tags -->
    <meta name="revisit-after" content="7 days">
    <meta name="distribution" content="global">
    <meta name="rating" content="general">
    <meta name="expires" content="never">
    <meta name="copyright" content="DocSpace UK 2025">
    <meta name="geo.region" content="GB">
    <meta name="geo.placename" content="United Kingdom">
    
    <!-- Mobile App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="DocSpace">
    <meta name="application-name" content="DocSpace">
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="theme-color" content="#667eea">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea'/%3E%3Cstop offset='100%25' style='stop-color:%23764ba2'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' rx='6' fill='url(%23g)'/%3E%3Cpath d='M16 6L8 11v13h16V11L16 6z' fill='white'/%3E%3Crect x='11' y='14' width='3' height='3' fill='%23667eea'/%3E%3Crect x='18' y='14' width='3' height='3' fill='%23667eea'/%3E%3Crect x='11' y='19' width='3' height='3' fill='%23667eea'/%3E%3Crect x='18' y='19' width='3' height='3' fill='%23667eea'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea'/%3E%3Cstop offset='100%25' style='stop-color:%23764ba2'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' rx='6' fill='url(%23g)'/%3E%3Cpath d='M16 6L8 11v13h16V11L16 6z' fill='white'/%3E%3Crect x='11' y='14' width='3' height='3' fill='%23667eea'/%3E%3Crect x='18' y='14' width='3' height='3' fill='%23667eea'/%3E%3Crect x='11' y='19' width='3' height='3' fill='%23667eea'/%3E%3Crect x='18' y='19' width='3' height='3' fill='%23667eea'/%3E%3C/svg%3E">
    
    <!-- Preconnect to external domains for performance -->
    <link rel="preconnect" href="https://js.stripe.com">
    <link rel="preconnect" href="https://api.companieshouse.gov.uk">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XXXXXXXXXX');
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 700px;
        }
        
        h1 {
            color: #2d3748;
            margin-bottom: 10px;
            text-align: center;
            font-size: 32px;
        }
        
        .subtitle {
            color: #718096;
            text-align: center;
            margin-bottom: 30px;
            font-size: 16px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
            font-size: 14px;
        }
        
        input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-box {
            margin-top: 20px;
            padding: 16px;
            border-radius: 10px;
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .success {
            background: #c6f6d5;
            color: #276749;
            border: 1px solid #9ae6b4;
        }
        
        .error {
            background: #fed7d7;
            color: #9b2c2c;
            border: 1px solid #feb2b2;
        }
        
        .info {
            background: #bee3f8;
            color: #2c5282;
            border: 1px solid #90cdf4;
        }
        
        .progress-container {
            margin-top: 20px;
            display: none;
        }
        
        .progress-bar {
            background: #e2e8f0;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }
        
        .file-count {
            text-align: center;
            color: #4a5568;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .file-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 10px;
            background: #f7fafc;
            border-radius: 8px;
            font-size: 12px;
            color: #4a5568;
        }
        
        .file-item {
            padding: 4px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-item.success {
            color: #38a169;
        }
        
        .file-item.error {
            color: #e53e3e;
        }
        
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .download-zip-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            margin-top: 20px;
        }
        
        .download-zip-btn:hover {
            box-shadow: 0 10px 20px rgba(72, 187, 120, 0.3);
        }
        
        .api-note {
            font-size: 12px;
            color: #718096;
            margin-top: 5px;
        }
        
        .api-note a {
            color: #667eea;
            text-decoration: none;
        }
        
    </style>
    <!-- Schema.org Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "DocSpace - Companies House Document Downloader",
      "url": "https://docspace.uk",
      "description": "Download all Companies House documents and filings for any UK company as a ZIP file. Fast, reliable service for just £5 per company.",
      "applicationCategory": "BusinessApplication",
      "operatingSystem": "Any",
      "offers": {
        "@type": "Offer",
        "price": "5.00",
        "priceCurrency": "GBP",
        "availability": "https://schema.org/InStock"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.8",
        "ratingCount": "127"
      },
      "provider": {
        "@type": "Organization",
        "name": "DocSpace UK",
        "url": "https://docspace.uk",
        "logo": "https://docspace.uk/logo.png",
        "sameAs": [
          "https://twitter.com/docspaceuk",
          "https://www.linkedin.com/company/docspace-uk"
        ]
      }
    }
    </script>
    
    <!-- Additional Schema.org for Service -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Service",
      "name": "Companies House Document Download Service",
      "description": "Professional service for downloading all Companies House documents for UK companies including annual returns, accounts, incorporation documents, and all other filings.",
      "provider": {
        "@type": "Organization",
        "name": "DocSpace UK"
      },
      "areaServed": {
        "@type": "Country",
        "name": "United Kingdom"
      },
      "hasOfferCatalog": {
        "@type": "OfferCatalog",
        "name": "Document Download Services",
        "itemListElement": [
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Company Document Bundle Download",
              "description": "Download all available Companies House documents for a single company"
            },
            "price": "5.00",
            "priceCurrency": "GBP"
          }
        ]
      }
    }
    </script>
    
    <!-- Breadcrumb Schema -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "name": "Home",
        "item": "https://docspace.uk"
      }]
    }
    </script>
    
    <!-- Organization Schema -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "DocSpace UK",
      "url": "https://docspace.uk",
      "logo": "https://docspace.uk/logo.png",
      "description": "Fast and reliable Companies House document download service",
      "address": {
        "@type": "PostalAddress",
        "@id": "https://docspace.uk/#address",
        "addressCountry": "GB"
      },
      "sameAs": []
    }
    </script>
    
    <!-- FAQ Schema -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [{
        "@type": "Question",
        "name": "How much does it cost to download Companies House documents?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "DocSpace charges a flat fee of £5 per company to download all available Companies House documents as a single ZIP file."
        }
      },{
        "@type": "Question",
        "name": "What documents are included in the download?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "The download includes all available Companies House filings such as Annual Returns, Accounts, Incorporation documents, Change of name documents, Registered office address changes, Officer appointments and resignations, Share capital changes, Mortgage charges, and Dissolution documents."
        }
      },{
        "@type": "Question",
        "name": "How quickly can I download the documents?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Documents are available for download immediately after payment. The download process typically takes 30-60 seconds depending on the number of documents."
        }
      }]
    }
    </script>
</head>
<body>
    <div class="container">
        <h1>🏢 Companies House Document Downloader</h1>
        <p class="subtitle">Download all official documents filed by UK companies as a ZIP file - Annual Returns, Accounts, Incorporation Documents & More</p>
        <p style="text-align: center; color: #667eea; font-weight: 600; margin-top: -20px; margin-bottom: 25px;">
            £5 per company download
        </p>
        
        <form id="searchForm">
            <div class="form-group">
                <label for="companyName">Company Name</label>
                <input 
                    type="text" 
                    id="companyName" 
                    name="companyName"
                    placeholder="e.g. Tesco PLC, Sainsbury's" 
                    required
                    aria-label="Enter UK company name to download documents"
                    aria-describedby="company-help"
                >
                <small id="company-help" style="color: #718096; font-size: 12px; margin-top: 5px; display: block;">Enter the name of any UK registered company</small>
            </div>
            
            
            <button type="submit" class="btn" id="searchBtn" aria-label="Search for company documents">
                Search Company
            </button>
        </form>
        
        <div class="status-box" id="statusBox"></div>
        
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div class="file-count" id="fileCount"></div>
            <div class="file-list" id="fileList"></div>
        </div>
        
        <button class="btn download-zip-btn" id="downloadZipBtn" style="display: none;" aria-label="Download all company documents as ZIP file">
            📦 Download All as ZIP
        </button>
        
        <!-- SEO Content Section -->
        <div style="margin-top: 40px; padding-top: 40px; border-top: 1px solid #e2e8f0;">
            <h2 style="color: #2d3748; font-size: 24px; margin-bottom: 16px;">About DocSpace UK</h2>
            <p style="color: #4a5568; line-height: 1.6; margin-bottom: 16px;">
                DocSpace is the UK's fastest and most reliable Companies House document downloader. 
                Access all official company filings including annual returns, accounts, incorporation 
                documents, change of director forms, and more - all in one convenient ZIP file.
            </p>
            <h3 style="color: #2d3748; font-size: 20px; margin-bottom: 12px; margin-top: 24px;">What Documents Can You Download?</h3>
            <ul style="color: #4a5568; line-height: 1.8; margin-left: 20px;">
                <li>Annual Returns and Confirmation Statements</li>
                <li>Annual Accounts and Financial Statements</li>
                <li>Incorporation Documents and Articles of Association</li>
                <li>Change of Director and Secretary Forms</li>
                <li>Share Capital and Allotment Documents</li>
                <li>Registered Office Changes</li>
                <li>Mortgage and Charge Documents</li>
                <li>All other Companies House filings</li>
            </ul>
            <h3 style="color: #2d3748; font-size: 20px; margin-bottom: 12px; margin-top: 24px;">Why Choose DocSpace?</h3>
            <p style="color: #4a5568; line-height: 1.6;">
                <strong>✓ Complete Archives:</strong> Download every document filed for a company<br>
                <strong>✓ Fast Downloads:</strong> Get all documents in seconds, not hours<br>
                <strong>✓ One Low Price:</strong> Just £5 per company for unlimited documents<br>
                <strong>✓ Secure Payment:</strong> Processed safely through Stripe<br>
                <strong>✓ Instant Access:</strong> No registration or subscription required
            </p>
        </div>
        
        <!-- Footer with additional SEO links -->
        <footer style="text-align: center; margin-top: 60px; padding: 20px 0; font-size: 14px;">
            <p style="color: #6b7280;">© 2025 DocSpace UK - Companies House Document Download Service</p>
            <p style="margin-top: 10px;">
                <a href="/terms" style="color: #6b7280; text-decoration: none; margin: 0 10px;">Terms of Service</a>
                <a href="/privacy" style="color: #6b7280; text-decoration: none; margin: 0 10px;">Privacy Policy</a>
                <a href="/contact" style="color: #6b7280; text-decoration: none; margin: 0 10px;">Contact</a>
            </p>
        </footer>
    </div>
    
    <script>
        const WORKER_URL = 'https://blue-flower-d40f.mahin84.workers.dev';
        const API_KEY = '22aefa40-ee9e-47c0-b40a-2dd3c03165c6';
        const STRIPE_PUBLIC_KEY = 'pk_test_51RT33XAJ1gsWpnv6rpEFMeCmuADlJet1lmqeaMrPXas4DYblZZ73SOnNEXb0gE5ADHrfRkVJIXyACM3Nw5Vt9HCz00L8E9wffe';
        let allDocuments = [];
        let companyData = null;
        let paymentCompleted = false;
        
        // Detect Telegram browser
        const isTelegram = /Telegram/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        
        // Initialize Stripe
        const stripe = Stripe(STRIPE_PUBLIC_KEY);
        
        function addDebug(message) {
            console.log(`${new Date().toISOString().substr(11, 8)} - ${message}`);
        }
        
        async function fetchWithWorker(url, apiKey) {
            // Build the proxy URL with parameters
            const params = new URLSearchParams({
                url: url,
                apiKey: apiKey
            });
            const proxyUrl = `${WORKER_URL}?${params.toString()}`;
            
            addDebug(`Worker URL: ${WORKER_URL}`);
            addDebug(`Target URL: ${url}`);
            addDebug(`Full proxy URL: ${proxyUrl}`);
            
            try {
                const response = await fetch(proxyUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': url.includes('/content') ? 'application/pdf' : 'application/json'
                    }
                });
                addDebug(`Response status: ${response.status}`);
                
                // If error, log the response
                if (!response.ok) {
                    try {
                        const errorText = await response.text();
                        addDebug(`Error response: ${errorText}`);
                    } catch (e) {
                        // Ignore if can't read error
                    }
                }
                
                return response;
            } catch (error) {
                addDebug(`Fetch error: ${error.message}`);
                throw error;
            }
        }
        
        function showStatus(type, message) {
            const statusBox = document.getElementById('statusBox');
            statusBox.className = `status-box ${type}`;
            statusBox.textContent = message;
            statusBox.style.display = 'block';
        }
        
        function updateProgress(current, total) {
            const percentage = Math.round((current / total) * 100);
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = `${percentage}%`;
            progressFill.textContent = `${percentage}%`;
            
            document.getElementById('fileCount').textContent = 
                `Processing ${current} of ${total} documents`;
        }
        
        function addFileToList(filename, status, error = null) {
            const fileList = document.getElementById('fileList');
            const fileItem = document.createElement('div');
            fileItem.className = `file-item ${status}`;
            const errorText = error ? ` (${error})` : '';
            fileItem.textContent = `${status === 'success' ? '✓' : '✗'} ${filename}${errorText}`;
            fileList.appendChild(fileItem);
            fileList.scrollTop = fileList.scrollHeight;
        }
        
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const companyName = document.getElementById('companyName').value.trim();
            const apiKey = API_KEY; // Use the constant API key
            const searchBtn = document.getElementById('searchBtn');
            const progressContainer = document.getElementById('progressContainer');
            const downloadZipBtn = document.getElementById('downloadZipBtn');
            
            // Reset UI
            searchBtn.disabled = true;
            searchBtn.innerHTML = 'Searching... <span class="spinner"></span>';
            progressContainer.style.display = 'none';
            downloadZipBtn.style.display = 'none';
            document.getElementById('fileList').innerHTML = '';
            allDocuments = [];
            
            try {
                // Search for company
                showStatus('info', 'Searching for company...');
                
                const searchUrl = `https://api.companieshouse.gov.uk/search/companies?q=${encodeURIComponent(companyName)}&items_per_page=1`;
                const searchResponse = await fetchWithWorker(searchUrl, apiKey);
                
                if (!searchResponse.ok) {
                    const errorText = await searchResponse.text();
                    addDebug(`Search error response: ${errorText}`);
                    if (searchResponse.status === 401) {
                        throw new Error('Invalid API key. Please check your credentials.');
                    }
                    throw new Error(`Failed to search for company (${searchResponse.status})`);
                }
                
                const searchData = await searchResponse.json();
                addDebug(`Found ${searchData.items?.length || 0} companies`);
                
                if (!searchData.items || searchData.items.length === 0) {
                    throw new Error('No company found with that name');
                }
                
                companyData = searchData.items[0];
                showStatus('success', `Found: ${companyData.title}`);
                addDebug(`Company number: ${companyData.company_number}`);
                
                // Get filing history
                showStatus('info', 'Fetching filing history...');
                
                const filingUrl = `https://api.companieshouse.gov.uk/company/${companyData.company_number}/filing-history?items_per_page=100`;
                const filingResponse = await fetchWithWorker(filingUrl, apiKey);
                
                if (!filingResponse.ok) {
                    const errorText = await filingResponse.text();
                    addDebug(`Filing history error: ${errorText}`);
                    throw new Error('Failed to fetch filing history');
                }
                
                const filingData = await filingResponse.json();
                const documents = filingData.items || [];
                addDebug(`Found ${documents.length} filing history items`);
                
                if (documents.length === 0) {
                    throw new Error('No documents found for this company');
                }
                
                // Filter documents with PDF links
                allDocuments = documents.filter(doc => {
                    const hasLink = doc.links && doc.links.document_metadata;
                    if (!hasLink) {
                        addDebug(`No document link for: ${doc.description}`);
                    }
                    return hasLink;
                }).map(doc => {
                    // Document metadata URLs can be in different formats
                    let metadataUrl = doc.links.document_metadata;
                    
                    // If it's a relative URL, make it absolute
                    if (metadataUrl.startsWith('/')) {
                        metadataUrl = `https://api.companieshouse.gov.uk${metadataUrl}`;
                    }
                    // If it's already a full URL with different domain, keep it as is
                    
                    return {
                        date: doc.date || 'unknown',
                        category: doc.category || 'document',
                        description: doc.description || 'Untitled',
                        metadataUrl: metadataUrl,
                        filename: generateFilename(doc)
                    };
                });
                
                addDebug(`${allDocuments.length} documents have downloadable PDFs`);
                
                if (allDocuments.length === 0) {
                    throw new Error('No downloadable PDFs found');
                }
                
                // Show first few document URLs for debugging
                allDocuments.slice(0, 3).forEach(doc => {
                    addDebug(`Document URL: ${doc.metadataUrl}`);
                });
                
                // Show download button
                showStatus('success', `Found ${allDocuments.length} PDF files. Click below to download all.`);
                downloadZipBtn.style.display = 'block';
                
            } catch (error) {
                showStatus('error', error.message);
                addDebug(`Error: ${error.message}`);
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = 'Search Company';
            }
        });
        
        async function startDownload() {
            const apiKey = API_KEY;
            const progressContainer = document.getElementById('progressContainer');
            const downloadZipBtn = document.getElementById('downloadZipBtn');
            
            if (downloadZipBtn) downloadZipBtn.disabled = true;
            progressContainer.style.display = 'block';
            
            showStatus('info', 'Downloading PDFs... This may take a few minutes.');
            
            const zip = new JSZip();
            const companyFolder = zip.folder(sanitizeFilename(companyData.title));
            
            let downloaded = 0;
            let failed = 0;
            
            // Download all documents
            const documentsToDownload = allDocuments;
            addDebug(`Attempting to download ${documentsToDownload.length} documents`);
            
            for (let i = 0; i < documentsToDownload.length; i++) {
                const doc = documentsToDownload[i];
                updateProgress(i + 1, documentsToDownload.length);
                
                try {
                    // Get PDF content - the content endpoint is at the document URL
                    // For document-api URLs, we need to use the URL as-is
                    const pdfUrl = doc.metadataUrl.includes('document-api.') 
                        ? doc.metadataUrl 
                        : `${doc.metadataUrl}/content`;
                    addDebug(`Downloading PDF ${i + 1}: ${pdfUrl}`);
                    
                    const pdfResponse = await fetchWithWorker(pdfUrl, apiKey);
                    addDebug(`PDF response status: ${pdfResponse.status}`);
                    
                    if (pdfResponse.ok) {
                        const contentType = pdfResponse.headers.get('content-type');
                        addDebug(`Content-Type: ${contentType}`);
                        
                        const pdfBlob = await pdfResponse.blob();
                        addDebug(`Blob size: ${pdfBlob.size} bytes`);
                        
                        if (pdfBlob.size > 0) {
                            companyFolder.file(doc.filename, pdfBlob);
                            downloaded++;
                            addFileToList(doc.filename, 'success');
                        } else {
                            failed++;
                            addFileToList(doc.filename, 'error', 'Empty file');
                        }
                    } else {
                        const errorText = await pdfResponse.text();
                        addDebug(`PDF download error: ${errorText}`);
                        failed++;
                        addFileToList(doc.filename, 'error', `Status ${pdfResponse.status}`);
                    }
                    
                    // Small delay to avoid rate limiting
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    addDebug(`Download error: ${error.message}`);
                    failed++;
                    addFileToList(doc.filename, 'error', error.message);
                }
            }
            
            if (downloaded > 0) {
                showStatus('info', 'Creating ZIP file...');
                
                try {
                    // Generate ZIP file
                    const content = await zip.generateAsync({ 
                        type: 'blob',
                        compression: 'DEFLATE',
                        compressionOptions: { level: 6 }
                    });
                    
                    addDebug(`ZIP file size: ${content.size} bytes`);
                    
                    // Download ZIP
                    saveAs(content, `${sanitizeFilename(companyData.title)}_documents.zip`);
                    
                    showStatus('success', 
                        `✨ Download complete! ${downloaded} files downloaded${failed > 0 ? `, ${failed} failed` : ''}.`
                    );
                } catch (error) {
                    addDebug(`ZIP creation error: ${error.message}`);
                    showStatus('error', 'Failed to create ZIP file');
                }
            } else {
                showStatus('error', 'No files could be downloaded. Check the debug info below.');
            }
            
            if (downloadZipBtn) downloadZipBtn.disabled = false;
        }
        
        document.getElementById('downloadZipBtn').addEventListener('click', async () => {
            const apiKey = API_KEY; // Use the constant API key
            const progressContainer = document.getElementById('progressContainer');
            const downloadZipBtn = document.getElementById('downloadZipBtn');
            
            // Check if payment already completed for this session
            if (!paymentCompleted) {
                downloadZipBtn.disabled = true;
                downloadZipBtn.innerHTML = 'Processing payment... <span class="spinner"></span>';
                
                try {
                    showStatus('info', 'Redirecting to payment...');
                    
                    // Store company data in localStorage to retrieve after payment
                    const dataToStore = {
                        companyData: companyData,
                        allDocuments: allDocuments,
                        timestamp: Date.now()
                    };
                    
                    try {
                        localStorage.setItem('pendingCompany', JSON.stringify(dataToStore));
                    } catch (e) {
                        console.error('localStorage failed:', e);
                        // Fallback: encode in URL for Telegram
                        if (isTelegram) {
                            showStatus('error', 'Payment not supported in Telegram browser. Please open in Safari or Chrome.');
                            downloadZipBtn.disabled = false;
                            downloadZipBtn.innerHTML = '📦 Download All as ZIP';
                            
                            // Add "Open in Browser" button
                            const openButton = document.createElement('button');
                            openButton.className = 'btn download-zip-btn';
                            openButton.style.marginTop = '10px';
                            openButton.innerHTML = '🌐 Open in Safari/Chrome';
                            openButton.onclick = () => {
                                window.open(window.location.href, '_system');
                            };
                            document.querySelector('.container').appendChild(openButton);
                            return;
                        }
                    }
                    
                    console.log('Storing company data before payment:', companyData.title);
                    console.log('Document count:', allDocuments.length);
                    
                    // Create a Stripe Payment Link URL with metadata
                    const paymentUrl = 'https://buy.stripe.com/6oU14m6YxcZL9ywgEncwg01';
                    
                    // Redirect to Stripe payment
                    window.location.href = paymentUrl;
                    return;
                    
                } catch (error) {
                    showStatus('error', 'Payment error: ' + error.message);
                    downloadZipBtn.disabled = false;
                    downloadZipBtn.innerHTML = '📦 Download All as ZIP';
                    return;
                }
            }
            
            // If payment completed, proceed with download
            await startDownload();
        });
        
        function generateFilename(doc) {
            const date = doc.date || 'unknown';
            const category = doc.category || 'document';
            const desc = (doc.description || 'document').substring(0, 50);
            const safeDesc = sanitizeFilename(desc);
            return `${date}_${category}_${safeDesc}.pdf`;
        }
        
        function sanitizeFilename(name) {
            return name.replace(/[^a-z0-9\s\-\_]/gi, '').trim().replace(/\s+/g, '_');
        }
        
        // Check URL parameters on page load for payment status
        window.addEventListener('DOMContentLoaded', async () => {
            // Show warning for Telegram browser
            if (isTelegram && isIOS) {
                showStatus('info', '📱 For best experience, please open this link in Safari or Chrome');
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const paymentStatus = urlParams.get('payment');
            
            if (paymentStatus === 'success') {
                // Retrieve stored company data
                const storedData = localStorage.getItem('pendingCompany');
                console.log('Payment success - checking for stored data:', storedData ? 'Found' : 'Not found');
                
                if (storedData) {
                    try {
                        const parsed = JSON.parse(storedData);
                        const { companyData: stored, allDocuments: docs, timestamp } = parsed;
                        
                        // Check if data is recent (within 30 minutes)
                        if (Date.now() - timestamp < 30 * 60 * 1000) {
                            companyData = stored;
                            allDocuments = docs;
                            paymentCompleted = true;
                            
                            console.log('Restored company:', companyData.title);
                            console.log('Document count:', allDocuments.length);
                            
                            // Update UI - don't update the input field as it might trigger search
                            showStatus('success', `Payment successful! Starting download for ${companyData.title}...`);
                            
                            // Show progress container
                            document.getElementById('progressContainer').style.display = 'block';
                            
                            // Clear stored data
                            localStorage.removeItem('pendingCompany');
                            
                            // Directly start download process without clicking button
                            setTimeout(async () => {
                                console.log('Starting automatic download for:', companyData.title);
                                await startDownload();
                            }, 1500);
                        } else {
                            console.log('Stored data too old');
                            localStorage.removeItem('pendingCompany');
                            showStatus('error', 'Payment session expired. Please search again.');
                        }
                    } catch (error) {
                        console.error('Error parsing stored data:', error);
                        showStatus('error', 'Error restoring session. Please search again.');
                    }
                } else {
                    showStatus('info', 'Payment successful! Please search for the company again to download.');
                }
                
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (paymentStatus === 'cancelled') {
                showStatus('info', 'Payment cancelled. Search for a company to try again.');
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });
    </script>
</body>
</html>